(this.webpackJsonpmopaint=this.webpackJsonpmopaint||[]).push([[0],{35:function(e,t,o){},49:function(e,t,o){},53:function(e,t,o){},54:function(e,t,o){},55:function(e,t,o){},56:function(e,t,o){},57:function(e,t,o){},58:function(e,t,o){},59:function(e,t,o){},60:function(e,t,o){},61:function(e,t,o){},62:function(e,t,o){},63:function(e,t,o){},64:function(e,t){let o,n;window.simulateRandomGesture=e=>{let t=document.querySelector("canvas"),n=t.getBoundingClientRect(),r=(e,o)=>{let r=new MouseEvent(e,{view:window,bubbles:!0,cancelable:!0,clientX:n.left+o.x,clientY:n.top+o.y});t.dispatchEvent(r)},s=0,a=Math.random()*n.width,i=Math.random()*n.height,c=[];for(let o=0;o<5;o+=1)c.push({rx:Math.random()*Math.min(n.width,n.height)/2/5,ry:Math.random()*Math.min(n.width,n.height)/2/5,angularFactor:5*Math.random()-Math.random(),angularOffset:5*Math.random()-Math.random()});let l=e=>{let t={x:a,y:i};for(let o=0;o<c.length;o+=1){let n=c[o],r=n.rx,s=n.ry,a=n.angularFactor,i=n.angularOffset;t.x+=Math.sin(2*Math.PI*(e/100*a+i))*r,t.y+=Math.cos(2*Math.PI*(e/100*a+i))*s}return t};r("mousedown",l(s));let d=()=>{s+=1,s>50?(r("mouseup",l(s)),e&&e()):(r("mousemove",l(s)),o=setTimeout(d,10))};d()},window.simulateRandomGesturesPeriodically=(e=50)=>{let t=()=>{n=setTimeout((()=>{window.simulateRandomGesture(t)}),e)};window.simulateRandomGesture(t)},window.stopSimulatingGestures=()=>{clearTimeout(o),clearTimeout(n)}},65:function(e,t,o){"use strict";o.r(t);var n=o(0),r=o(3),s=o.n(r),a=o(11),i=o.n(a),c=o(1),l=o.n(c),d=o(16),h=o.n(d),u=(o(35),o(21)),m=o(4),p=o(2),f=o(17),g=o(18),b=o.n(g),w=o(12),v=o.n(w),y=o(19),j=o.n(y),O=o(13),x=o.n(O);function D(e,t,o){((e,t)=>{const o=new FileReader;o.onload=()=>{const e=o.result,n=new Uint8Array(e),r=v()(n);t(r)},o.readAsArrayBuffer(e)})(e,(e=>{for(var n=0,r=Object.keys(t);n<r.length;n++){const o=r[n];e.splice(-1,0,x.a.encode(o,t[o]))}const s=j()(e),a=new Blob([s],{type:"image/png"});o(a)}))}function E(e){const t=v()(e).filter((e=>"tEXt"===e.name)).map((e=>x.a.decode(e.data))),o={};for(let n=0;n<t.length;n++){const e=t[n];o[e.keyword]=e.text}return o}const N=e=>"0".concat(e.toString(16)).slice(-2),I=(e=40)=>{const t=new Uint8Array(e/2);return crypto.getRandomValues(t),Array.from(t,N).join("")};class S{constructor({parentNode:e,timestamp:t,operation:o,name:n,id:r}){this.parentNode=e,this.childNodes=[],this.timestamp=null!==t&&void 0!==t?t:Date.now(),this.operation=o,this.name=n,this.id=null!==r&&void 0!==r?r:I()}}var L=o(5);function C(e,{currentHistoryNode:t,redos:o,undos:n}){const r=t,s=o.size>0?[o.first(),...P(o.first())]:[r,...P(r)],a=P(e);n=new p.List([...a].reverse()),o=new p.List;let i=e;for(;i.childNodes.length>0;){const e=[...i.childNodes];e.sort(((e,t)=>s.indexOf(e)>-1?-1:s.indexOf(t)>-1?1:0)),i=e[0],o=o.unshift(i)}return{currentHistoryNode:e,undos:n,redos:o}}function P(e){const t=[];for(e=e.parentNode;e;e=e.parentNode)t.push(e);return t}function M(e){const t=function(e){for(;e.parentNode;)e=e.parentNode;return e}(e),o=[],n=e=>{var t,r=Object(L.a)(e.childNodes);try{for(r.s();!(t=r.n()).done;){const e=t.value;n(e)}}catch(s){r.e(s)}finally{r.f()}o.push(e)};return n(t),o.sort(((e,t)=>e.timestamp<t.timestamp?-1:t.timestamp<e.timestamp?1:0)),o}const k=.5;function H({palette:e,selectedSwatch:t,selectedTool:o,undos:n,redos:r,currentHistoryNode:s}){const a=M(s),i=e=>e.id,c={};return a.forEach((e=>{var t;c[e.id]={parentHNID:e.parentNode&&e.parentNode.id,childHNIDs:e.childNodes.map(i),timestamp:e.timestamp,operation:e.operation&&(t=e.operation,{id:t.id,toolID:t.tool.name,points:t.points,swatch:t.swatch}),name:e.name,id:e.id}})),{format:"mopaint",formatVersion:k,palette:e,selectedSwatch:t,selectedToolID:o.name,historyNodesByID:c,undoHNIDs:n.toJS().map(i),redoHNIDs:r.toJS().map(i),currentHNID:i(s)}}const R=(e,t,o,n,r,s)=>{e.beginPath(),e.moveTo(t,o),e.lineTo(n,r),e.strokeStyle=s,e.lineWidth=5,e.lineCap="round",e.stroke()};var F=R;const T=(e,t,o,n,r,s)=>{const a=Math.hypot(n-t,r-o);e.beginPath(),e.arc(t,o,a,0,2*Math.PI),e.fillStyle=s,e.fill()};var B=T;var z=(e,t,o,n,r,s)=>{e.beginPath(),e.rect(t,o,n-t,r-o),e.fillStyle=s,e.fill()};var U=(e,t,o)=>[{x:e,y:t},((e,t)=>({x:2*o-e,y:t}))(e,t)];var V=(e,t,o,n)=>{const r=e-o,s=n-t,a=Math.hypot(r,s),i=Math.atan2(r,s)+0,c=[];for(let l=0;l<6;l++){let r=i+2*Math.PI/6*l;e=o+Math.sin(r)*a,t=n-Math.cos(r)*a,c.push({x:e,y:t})}return c};function A(){return(A=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}function W(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var J=c.createElement("g",null),G=c.createElement("g",null),q=c.createElement("g",null),X=c.createElement("g",null),Y=c.createElement("g",null),_=c.createElement("g",null),$=c.createElement("g",null),K=c.createElement("g",null),Q=c.createElement("g",null),Z=c.createElement("g",null),ee=c.createElement("g",null),te=c.createElement("g",null),oe=c.createElement("g",null),ne=c.createElement("g",null),re=c.createElement("g",null);function se(e,t){let o=e.title,n=e.titleId,r=W(e,["title","titleId"]);return c.createElement("svg",A({id:"Capa_1",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",x:"0px",y:"0px",viewBox:"0 0 18.713 18.713",style:{enableBackground:"new 0 0 18.713 18.713"},xmlSpace:"preserve",ref:t,"aria-labelledby":n},r),o?c.createElement("title",{id:n},o):null,c.createElement("g",{transform:"scale(-1,1) translate(-18.713,0)"},c.createElement("path",{style:{fill:"#030104"},d:"M13.367,6.434L8.872,1.895l-0.65-0.672L6.687,2.731c-2.624-0.375-4.51,0.59-5.178,1.777 C0.698,5.949,1.527,7.522,1.553,7.57c0.693,1.385,1.689,2.216,2.961,2.473c0.279,0.055,0.56,0.08,0.84,0.08 c1.322,0,2.644-0.561,3.649-1.135c0.271,0.188,0.601,0.299,0.954,0.299c0.93,0,1.686-0.759,1.686-1.691s-0.756-1.69-1.686-1.69 s-1.686,0.758-1.686,1.69c0,0.093,0.013,0.184,0.027,0.274C7.286,8.445,5.951,8.986,4.77,8.748C3.905,8.573,3.237,7.995,2.719,6.96 C2.714,6.95,2.203,5.957,2.654,5.157c0.38-0.676,1.371-1.111,2.883-1.275L5.302,4.119L3.13,6.299 c0.023,0.053,0.04,0.085,0.041,0.087c0.209,0.418,0.444,0.758,0.706,1.03l3.932-3.943c0.187-0.187,0.435-0.29,0.698-0.29 s0.513,0.103,0.698,0.29l4.771,4.787c0.385,0.385,0.385,1.014,0,1.399L7.774,15.88c-0.372,0.373-1.023,0.373-1.396,0l-4.772-4.787 c-0.187-0.186-0.289-0.434-0.289-0.699c0-0.264,0.102-0.514,0.289-0.7l0.515-0.518C1.828,8.874,1.568,8.512,1.335,8.098 l-0.66,0.663C0.24,9.197,0,9.777,0,10.394c0,0.617,0.24,1.197,0.675,1.633l4.772,4.787c0.435,0.436,1.012,0.676,1.628,0.676 c0.614,0,1.193-0.24,1.628-0.676l6.201-6.221L16.205,9.3l-0.361-0.365c0.683-0.373,0.987,2.744,0.987,2.744s0.954,7.439,1.802,0 C19.443,4.56,13.854,6.272,13.367,6.434z"})),J,G,q,X,Y,_,$,K,Q,Z,ee,te,oe,ne,re)}const ae=c.forwardRef(se);o.p;const ie={"Freeform Line":{name:"Freeform Line",drawFromPoints:(e,t,o)=>{e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let n=1;n<t.length;n+=1)e.lineTo(t[n].x,t[n].y);e.strokeStyle=o,e.lineWidth=5,e.lineCap="round",e.lineJoin="round",e.stroke()}},Line:{drawShape:F},"Freeform Circles":{drawSegmentOfPath:B},Circle:{drawShape:B},Rectangle:{drawShape:z},Fill:{Icon:ae,drawFromPoint:function(e,t,o,n,r){e.drawImage(r.canvas,0,0),function(e,t,o,n){const r=e.canvas;if(t=Math.floor(t),o=Math.floor(o),t<0||o<0||t>r.width||o>r.height)return;const s=[[t,o]],a=e.getImageData(0,0,r.width,r.height);let i=4*(o*r.width+t);const c=a.data[i+0],l=a.data[i+1],d=a.data[i+2],h=a.data[i+3],u=document.createElement("canvas").getContext("2d");u.fillStyle=n,u.fillRect(0,0,1,1);const p=u.getImageData(0,0,1,1),f=Object(m.a)(p.data,4),g=f[0],b=f[1],w=f[2],v=f[3];if(g!==c||b!==l||w!==d||v!==h){for(;s.length;){let e,t,o,n,a,i;for(e=s.pop(),t=e[0],o=e[1],n=4*(o*r.width+t);y(n);)o--,n=4*(o*r.width+t);for(a=!1,i=!1;o++,n=4*(o*r.width+t),o<r.height&&y(n);)j(n),t>0&&(y(n-4)?a||(s.push([t-1,o]),a=!0):a&&(a=!1)),t<r.width-1&&(y(n+4)?i||(s.push([t+1,o]),i=!0):i&&(i=!1)),n+=4*r.width}e.putImageData(a,0,0)}function y(e){return a.data[e+0]===c&&a.data[e+1]===l&&a.data[e+2]===d&&a.data[e+3]===h}function j(e){a.data[e+0]=g,a.data[e+1]=b,a.data[e+2]=w,a.data[e+3]=v}}(e,t,o,n)}}};Object.keys(ie).forEach((e=>{const t=ie[e];t.drawSegmentOfPath&&(t.drawFromPoints=(e,o,n)=>{for(let r=0,s=1;s<o.length;r+=1,s+=1)t.drawSegmentOfPath(e,o[r].x,o[r].y,o[s].x,o[s].y,n)},t.getDemoPointsForIcon=(e,t)=>{const o=[];for(let n=0;n<20;n+=2)o.push({x:e/2+48*Math.sin(Math.sin(n*n/302)),y:t/2+48*Math.cos(Math.sin(n/5))});return o}),t.drawShape&&(t.drawFromPoints=(e,o,n)=>{const r=o[0],s=o[o.length-1];t.drawShape(e,r.x,r.y,s.x,s.y,n)},t.getDemoPointsForIcon=(e,t)=>[{x:.5*e,y:.5*t},{x:.8*e,y:.8*t}]),t.drawFromPoint&&(t.drawFromPoints=(e,o,n,r)=>{const s=o[o.length-1];t.drawFromPoint(e,s.x,s.y,n,r)},t.getDemoPointsForIcon=(e,t)=>({x:e/2,y:t/2})),t.getDemoPointsForIcon||(t.getDemoPointsForIcon=(e,t)=>{const o=[];for(let n=0;n<20;n+=2)o.push({x:e/2+48*Math.sin(Math.sin(n*n/302)),y:t/2+48*Math.cos(Math.sin(n/5))});return o})}));[{prefix:"Mirror Symmetric ",pointToPoints:U},{prefix:"Rotationally Symmetric ",pointToPoints:V}].forEach((e=>{Object.keys(ie).forEach((t=>{const o=ie[t],n=e.prefix+t;if(!o.drawFromPoint&&o.drawFromPoints){const t=ie[n]={};if(t.drawFromPoints=(t,n,r,s)=>{const a=[],i=t.canvas.width/2,c=t.canvas.height/2;var l,d=Object(L.a)(n);try{for(d.s();!(l=d.n()).done;){const t=l.value,o=e.pointToPoints(t.x,t.y,i,c);for(let e=0;e<o.length;e++)a[e]=a[e]||[],a[e].push(o[e])}}catch(m){d.e(m)}finally{d.f()}for(var h=0,u=a;h<u.length;h++){const e=u[h];o.drawFromPoints(t,e,r,s)}},o.getSymmetryPoints){const n=o.getSymmetryPoints;t.getSymmetryPoints=(t,o)=>{const r=n(t,o),s=t.canvas.width/2,a=t.canvas.height/2;return r.map((t=>e.pointToPoints(t.x,t.y,s,a))).flat()}}else t.getSymmetryPoints=(t,o)=>{const n=t.canvas.width/2,r=t.canvas.height/2;return e.pointToPoints(o.x,o.y,n,r)};t.getDemoPointsForIcon=(e,t)=>o.getDemoPointsForIcon(e/2,t/2)}}))}));var ce=Object.keys(ie).map((e=>{const t=ie[e];return t.name=e,t}));const le=ie;o(49);var de=o(20),he=o.n(de);const ue=document.createElement("canvas"),me=ue.getContext("2d");o(53);function pe(){return Object(n.jsx)("div",{className:"LoadingIndicator",role:"progressbar"})}class fe extends c.Component{constructor(e){super(e),this.operation=null,this.pointerPos=null,this.pointerOverCanvas=!1,this.canvasRef=l.a.createRef(),this.cache={},this.hashInDocumentByOperation=new Map}draw(){this.animationFrameID&&cancelAnimationFrame(this.animationFrameID),this.animationFrameID=requestAnimationFrame((()=>{if((({documentCanvas:e,operations:t,cache:o,hashInDocumentByOperation:n})=>{const r=e.getContext("2d");r.clearRect(0,0,ue.width,ue.height),ue.width=e.width,ue.height=e.height;let s=-1/0,a=t.length-1;for(;a>=0;a--){const e=t[a],i=n.get(e);if(o["document-at-".concat(i)]){r.drawImage(o["document-at-".concat(i)],0,0),s=a;break}}a++;const i=he()();for(;a<t.length;a++){const c=t[a];i.update(JSON.stringify(c));const l=i.digest("hex");if(me.clearRect(0,0,ue.width,ue.height),o["individual-".concat(l)])r.drawImage(o["individual-".concat(l)],0,0),s=a;else{const t=c.points,i=c.tool,d=c.swatch;i.drawFromPoints(me,t,d,r),r.drawImage(ue,0,0),n.set(c,l),c.updatingContinously||a>=s+5&&(o["document-at-".concat(l)]=document.createElement("canvas"),o["document-at-".concat(l)].width=ue.width,o["document-at-".concat(l)].height=ue.height,o["document-at-".concat(l)].getContext("2d").drawImage(e,0,0),s=a)}}})({documentCanvas:this.canvasRef.current,operations:this.props.operations,thumbnailsByOperation:this.props.thumbnailsByOperation,cache:this.cache,hashInDocumentByOperation:this.hashInDocumentByOperation}),(this.pointerOverCanvas||this.operation)&&this.props.selectedTool.getSymmetryPoints&&this.pointerPos){const n=this.canvasRef.current.getContext("2d"),r=this.props.selectedTool.getSymmetryPoints(n,this.pointerPos);var e,t=Object(L.a)(r);try{for(t.s();!(e=t.n()).done;){const t=e.value;n.beginPath(),n.arc(t.x,t.y,2.5,0,2*Math.PI),n.fillStyle="#fff",n.fill(),n.strokeStyle="#000",n.lineWidth=1,n.stroke()}}catch(o){t.e(o)}finally{t.f()}}}))}render(){this.draw();return Object(n.jsxs)("div",{className:"DrawingCanvas",style:{width:640,height:480,position:"relative"},children:[Object(n.jsx)("canvas",{width:640,height:480,ref:this.canvasRef}),!this.props.loaded&&Object(n.jsx)("div",{style:{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)"},children:Object(n.jsx)(pe,{})})]})}toCanvasCoords(e){const t=this.canvasRef.current.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}onPointerMove(e){this.pointerPos=this.toCanvasCoords(e),this.props.selectedTool.getSymmetryPoints&&this.draw()}onPointerLeave(){this.pointerOverCanvas=!1,this.props.selectedTool.getSymmetryPoints&&this.draw()}onPointerEnter(){this.pointerOverCanvas=!0}onPointerMoveWhileDown(e){if(e.preventDefault(),this.pointerPos=this.toCanvasCoords(e),!this.operation)return;this.operation.points.push(this.pointerPos);(0,this.props.updateOperation)(this.operation)}onPointerDown(e){if(1!==e.which)return;e.preventDefault();const t=this.props,o=t.selectedSwatch,n=t.selectedTool;if(!n)return void console.warn("no tool selected");this.pointerPos=this.toCanvasCoords(e),this.operation={id:I(10),points:[this.pointerPos],tool:n,swatch:o,updatingContinously:!0};(0,this.props.addOperation)(this.operation),e.target.setCapture?e.target.setCapture():document.body.classList.add("cursor-override-DrawingCanvas")}onPointerUp(){const e=this.props.updateOperation;this.operation&&(delete this.operation.updatingContinously,e(this.operation),this.operation=null,document.body.classList.remove("cursor-override-DrawingCanvas"))}componentDidMount(){const e=this.canvasRef.current;let t=!1;e.addEventListener("pointermove",this.pointerMoveListener=e=>{this.onPointerMove(e)}),e.addEventListener("pointerleave",this.pointerLeaveListener=e=>{this.onPointerLeave(e)}),e.addEventListener("pointerenter",this.pointerEnterListener=e=>{this.onPointerEnter(e)}),e.addEventListener("pointerdown",this.pointerDownListener=e=>{t||0===e.button&&(t=!0,this.onPointerDown(e),window.addEventListener("pointermove",this.pointerMoveWhileDownListener=e=>{this.onPointerMoveWhileDown(e)}),window.addEventListener("pointerup",this.pointerUpListener=e=>{window.removeEventListener("pointermove",this.pointerMoveWhileDownListener),window.removeEventListener("pointerup",this.pointerUpListener),t=!1,this.onPointerUp(e)}))})}componentWillUnmount(){const e=this.canvasRef.current;e.removeEventListener("pointerdown",this.pointerDownListener),e.removeEventListener("pointermove",this.pointerMoveListener),e.removeEventListener("pointerleave",this.pointerLeaveListener),e.removeEventListener("pointerenter",this.pointerEnterListener),window.removeEventListener("pointermove",this.pointerMoveWhileDownListener),window.removeEventListener("pointerup",this.pointerUpListener),cancelAnimationFrame(this.animationFrameID)}}var ge=fe;var be=(()=>{function e(e,t,o){for(let n=0;n<t;++n)if(0!==e.data[o*t*4+4*n+3])return!1;return!0}function t(e,t,o,n,r){for(let s=n;s<r;++s)if(0!==e.data[s*t*4+4*o+3])return!1;return!0}return o=>{const n=o.getContext("2d"),r=o.width,s=n.getImageData(0,0,o.width,o.height);let a=0,i=s.height,c=0,l=s.width;for(;a<i&&e(s,r,a);)++a;for(;i-1>a&&e(s,r,i-1);)--i;for(;c<l&&t(s,r,c,a,i);)++c;for(;l-1>c&&t(s,r,l-1,a,i);)--l;const d=n.getImageData(c,a,l-c||1,i-a||1),h=o.ownerDocument.createElement("canvas"),u=h.getContext("2d");return h.width=d.width,h.height=d.height,u.putImageData(d,0,0),h}})();class we extends c.Component{constructor(e){super(e),this.canvasRef=l.a.createRef()}render(){const e=this.props,t=e.width,o=e.height,r=e.tool;return r.Icon?Object(n.jsx)(r.Icon,{className:"ToolPreview",width:t,height:o}):Object(n.jsx)("canvas",{className:"ToolPreview",width:t,height:o,ref:this.canvasRef})}componentDidMount(){const e=this.canvasRef.current;if(!e)return;const t=e.getContext("2d"),o=document.createElement("canvas");o.width=128,o.height=128;const n=o.getContext("2d"),r=this.props.tool,s=r.getDemoPointsForIcon(o.width,o.height);r.drawFromPoints(n,s,"black");const a=be(o);let i,c;a.width>a.height?(i=e.width,c=a.height/a.width*e.width):(i=a.width/a.height*e.width,c=e.width),t.drawImage(a,(e.width-i)/2,(e.height-c)/2,i,c)}}var ve=we;o(54);class ye extends c.Component{render(){var e=this.props,t=e.tools,o=e.selectedTool,r=e.selectTool;return t=t||[],Object(n.jsx)("div",{className:"Toolbox",role:"radiogroup",children:t.map((e=>{const t=o===e;return Object(n.jsx)("button",{className:"Toolbox-tool",role:"radio","aria-checked":t?"aria-checked":null,onClick:()=>{r(e)},title:e.name,children:Object(n.jsx)(ve,{tool:e,width:48,height:48})},e.name)}))})}}var je=ye;o(55);class Oe extends c.Component{render(){const e=this.props,t=e.palette,o=e.selectedSwatch,r=e.selectSwatch;return Object(n.jsx)("div",{className:"Palette",role:"radiogroup",children:t.map((e=>{const t=o===e;return Object(n.jsx)("button",{className:"Palette-swatch swatch",style:{backgroundColor:e},role:"radio","aria-checked":t?"aria-checked":null,onClick:()=>{r(e)}},e)}))})}}var xe=Oe;o(56);class De extends c.Component{render(){const e=this.props,t=e.palette,o=e.selectedSwatch,r=e.selectSwatch;return Object(n.jsxs)("div",{className:"Colorbox",children:[Object(n.jsx)("div",{className:"Colorbox-selected-swatches",children:Object(n.jsx)("div",{className:"Colorbox-selected-swatch swatch",style:{backgroundColor:o}},o)}),Object(n.jsx)("div",{className:"Colorbox-divider"}),Object(n.jsx)(xe,{palette:t,selectedSwatch:o,selectSwatch:r})]})}}var Ee=De;o(57);c.Component;class Ne extends c.Component{constructor(e){super(e),this.entryRef=l.a.createRef()}shouldComponentUpdate(e){return e.current!==this.props.current||e.historyNode!==this.props.historyNode||e.ancestorOfCurrent!==this.props.ancestorOfCurrent}render(){var e;const t=this.props,o=t.current,r=t.ancestorOfCurrent,s=t.onClick,a=t.historyNode,i=t.getIconReactElementMaybe,c=a.operation;return Object(n.jsxs)("button",{className:"HistoryEntry"+(o?" current":"")+(r?" ancestor-of-current":""),role:"radio","aria-checked":o?"aria-checked":null,onClick:s,onMouseDown:s,ref:this.entryRef,children:[null!==(e=null===i||void 0===i?void 0:i())&&void 0!==e?e:c&&Object(n.jsx)(ve,{tool:c.tool,width:16,height:16}),a.name]})}}var Ie=Ne;o(58);function Se(){return(Se=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}function Le(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var Ce=c.createElement("path",{fill:"#95a5a6",d:"M5 0c-.982 0-3 2.018-3 3v10c0 1 1 2 2 2h8c.982 0 .762-1.048 1-2V5L9 0z"}),Pe=c.createElement("path",{fill:"#bdc3c7",d:"M4 0c-.982 0-2 1.018-2 2v10c0 .982 1.018 2 2 2h8c.982 0 1.73-1.056 2-2V5L9 0z"}),Me=c.createElement("path",{fill:"#95a5a6",d:"M14 5L9 0v3c0 .982 1.018 2 2 2z"}),ke=c.createElement("g",{transform:"matrix(.5 0 0 .5 9.225 -504.681)"},c.createElement("circle",{cx:6.55,cy:1034.362,r:7,fill:"#27ae60"}),c.createElement("circle",{cx:6.55,cy:1032.362,r:7,fill:"#2ecc71"}),c.createElement("path",{fill:"#27ae60",d:"M1.55 1035.362h4v4h2v-4h4v-2h-4v-4h-2v4h-4z"}),c.createElement("path",{fill:"#ecf0f1",d:"M1.55 1033.362h4v4h2v-4h4v-2h-4v-4h-2v4h-4z"}));function He(e,t){let o=e.title,n=e.titleId,r=Le(e,["title","titleId"]);return c.createElement("svg",Se({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,viewBox:"0 0 16 16",ref:t,"aria-labelledby":n},r),o?c.createElement("title",{id:n},o):null,Ce,Pe,Me,ke)}const Re=c.forwardRef(He);o.p;class Fe extends c.Component{constructor(e){super(e),this.currentEntryRef=l.a.createRef(),this.selfRef=l.a.createRef()}componentDidMount(){this.scrollSelectedEntryIntoView()}componentDidUpdate(e){this.props.undos.size!==e.undos.size&&this.scrollSelectedEntryIntoView()}scrollSelectedEntryIntoView(){const e=this.currentEntryRef.current,t=e&&e.entryRef.current;t&&t.scrollIntoView({behavior:"instant",block:"nearest",inline:"nearest"})}shouldComponentUpdate(e){return e.currentHistoryNode!==this.props.currentHistoryNode||e.thumbnailsByOperation!==this.props.thumbnailsByOperation||e.loaded!==this.props.loaded}render(){const e=this.props,t=e.currentHistoryNode,o=e.goToHistoryNode,r=e.thumbnailsByOperation,s=e.loaded,a=P(t),i=M(t),c=e=>{const n=i.indexOf(t),r=i[n+e];r&&o(r)};return Object(n.jsx)("div",{className:"HistoryView",role:"radiogroup",ref:this.selfRef,onKeyDown:e=>{"ArrowUp"===e.key?(e.preventDefault(),c(-1)):"ArrowDown"===e.key&&(e.preventDefault(),c(1))},children:s?i.map((e=>{const s=a.indexOf(e)>-1,i=e===t;return Object(n.jsx)(Ie,{historyNode:e,current:i,ref:i&&this.currentEntryRef,ancestorOfCurrent:s,onClick:()=>o(e),thumbnailsByOperation:r,getIconReactElementMaybe:()=>"New Document"===e.name?Object(n.jsx)(Re,{width:16,height:16}):null},e.id)})):Object(n.jsx)(pe,{})})}}var Te=Fe;o(59);const Be=e=>Object(n.jsx)("a",{href:"https://github.com/1j01/mopaint/issues/",target:"_blank",rel:"noopener noreferrer",children:e.children});function ze({message:e,error:t,requestBugReport:o,close:r,extraButtons:s,buttons:a,maxWidth:i="50em"}){const c=t&&t.stack&&(0===t.stack.indexOf(t.toString())?t.stack.slice(t.toString().length).trimEnd():"\n".concat(t.stack.trim()).replace(/\n/g,"\n    ")),l=t&&(c?"".concat(t.toString(),"\n\nStack trace:").concat(c):t.toString());return Object(n.jsx)("div",{className:"Dialog",children:Object(n.jsxs)("div",{className:"Dialog-box",style:{maxWidth:i},children:[e||t.message,t&&Object(n.jsxs)("details",{children:[Object(n.jsx)("summary",{children:"Details"}),Object(n.jsx)("div",{className:"actual-details",children:Object(n.jsx)("pre",{children:l})})]}),o&&Object(n.jsxs)("div",{children:["You should ",Object(n.jsx)(Be,{children:"report this bug"}),"."]}),Object(n.jsxs)("div",{className:"Dialog-buttons",children:[a||Object(n.jsx)("button",{onClick:r,children:"Close"}),s]})]})})}o(60);var Ue=e=>Object(n.jsx)("div",{className:"Warning",children:e.children});var Ve=["rgb(174, 206, 209)","rgb(122, 148, 168)","rgb(77, 94, 118)","rgb(44, 47, 75)","rgb(0, 0, 0)","rgb(47, 19, 80)","rgb(113, 31, 133)","rgb(204, 63, 200)","rgb(255, 147, 217)","rgb(255, 255, 255)","rgb(145, 242, 251)","rgb(73, 155, 224)","rgb(44, 78, 167)","rgb(25, 33, 113)","rgb(19, 15, 60)","rgb(35, 48, 90)","rgb(47, 91, 112)","rgb(47, 148, 125)","rgb(53, 213, 75)","rgb(171, 255, 55)","rgb(255, 239, 83)","rgb(243, 162, 20)","rgb(226, 98, 39)","rgb(162, 41, 62)","rgb(91, 26, 58)","rgb(35, 3, 33)","rgb(62, 19, 38)","rgb(139, 60, 60)","rgb(205, 115, 73)","rgb(255, 191, 147)"];o(61);function Ae(){return(Ae=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}function We(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var Je=c.createElement("path",{d:"M7 0c-.982 0-3 2.018-3 3v16c0 1 1 2 2 2h12c.982 0 1-1.018 1-2V5l-4-5z",fill:"#95a5a6"}),Ge=c.createElement("path",{d:"M6 0c-.982 0-2 1.018-2 2v16c0 .982 1.018 2 2 2h12c.982 0 2-1.018 2-2V5l-5-5z",fill:"#bdc3c7"}),qe=c.createElement("path",{d:"M20 5l-5-5v3c0 .982 1.03 1.845 2 2z",fill:"#95a5a6"}),Xe=c.createElement("g",{transform:"matrix(.5 0 0 .5 16.225 -497.681)"},c.createElement("circle",{cx:6.55,cy:1034.362,r:9,fill:"#27ae60"}),c.createElement("circle",{cx:6.55,cy:1032.362,r:9,fill:"#2ecc71"}),c.createElement("path",{d:"M1.55 1035.362h4v4h2v-4h4v-2h-4v-4h-2v4h-4z",fill:"#27ae60"}),c.createElement("path",{d:"M1.55 1033.362h4v4h2v-4h4v-2h-4v-4h-2v4h-4z",fill:"#ecf0f1"}));function Ye(e,t){let o=e.title,n=e.titleId,r=We(e,["title","titleId"]);return c.createElement("svg",Ae({xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",ref:t,"aria-labelledby":n},r),o?c.createElement("title",{id:n},o):null,Je,Ge,qe,Xe)}const _e=c.forwardRef(Ye);o.p;function $e(){return($e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}function Ke(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var Qe=c.createElement("path",{d:"M1.632 6.314C.73 6.314 0 7.044 0 7.946v11.422C0 20.27.78 21 1.682 21H17.75c1.401 0 2.281-2.21 2.253-2.42l-.422-.549V7.946c0-.902-.73-1.632-1.631-1.632z",fill:"#2980b9"}),Ze=c.createElement("path",{d:"M3 3c-.901 0-2 1.099-2 2v10.928c0 1 .546 1.808 1.448 1.808H17.134c.901 0 1.632-.73 1.632-1.631V6.532C18.766 5.633 17.9 5 17 5H10.473L8 3z",fill:"#2980b9"}),et=c.createElement("path",{d:"M18.52 19.368L20 8c.118-.909-.203-2-1.203-2H4c-.901 0-1.42.229-1.557 1.13L1 19z",fill:"#bdc3c7"}),tt=c.createElement("path",{d:"M6 7c-.901 0-1.362.044-1.68.946L2.591 12.84l-.288.816L1 18c-.318.901 0 2 2 2h15.14c.902 0 1.34-.156 1.799-1.12l1.946-5.223.288-.816 1.463-4.32c.428-1.1.172-1.521-.972-1.521z",fill:"#3498db"});function ot(e,t){let o=e.title,n=e.titleId,r=Ke(e,["title","titleId"]);return c.createElement("svg",$e({xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",ref:t,"aria-labelledby":n},r),o?c.createElement("title",{id:n},o):null,Qe,Ze,et,tt)}const nt=c.forwardRef(ot);o.p;function rt(){return(rt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}function st(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var at=c.createElement("path",{d:"M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-3H5z",fill:"#3498db"}),it=c.createElement("path",{d:"M7 3v6a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3H7z",fill:"#2980b9"}),ct=c.createElement("path",{d:"M7 3v5a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3H7zM6 12a1 1 0 0 0-1 1v8h14v-8a1 1 0 0 0-1-1H6z",fill:"#ecf0f1"}),lt=c.createElement("path",{fill:"#bdc3c7",d:"M5 20h14v1H5zM7 14h10v1H7zM7 16h10v1H7z"}),dt=c.createElement("path",{fill:"#3498db",d:"M13 4h3v4h-3z"}),ht=c.createElement("path",{fill:"#2980b9",d:"M13 4h3v1h-3z"});function ut(e,t){let o=e.title,n=e.titleId,r=st(e,["title","titleId"]);return c.createElement("svg",rt({xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",ref:t,"aria-labelledby":n},r),o?c.createElement("title",{id:n},o):null,at,it,ct,lt,dt,ht)}const mt=c.forwardRef(ut);o.p;function pt(){return(pt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}function ft(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)o=s[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var gt=c.createElement("g",{id:"a"},c.createElement("path",{d:"M23 1044.362a2 2 0 01-2 2H7a2 2 0 01-2-2v-10a2 2 0 012-2h14a2 2 0 012 2v4z",fill:"#95a5a6",transform:"translate(3 -1051.362)"}),c.createElement("path",{d:"M5 1043.362a2 2 0 002 2h14a2 2 0 002-2v-10a2 2 0 00-2-2H7a2 2 0 00-2 2v4z",fill:"#bdc3c7",transform:"translate(3 -1051.362)"}),c.createElement("path",{fill:"#f39c12",d:"M7 1033.362h14v10H7z",transform:"translate(3 -1051.362)"}),c.createElement("path",{d:"M16.625 8.625L9 15h12v-2z",transform:"translate(3 -23)",fill:"#e67e22"}),c.createElement("path",{d:"M13 1036.362a2.5 2.5 0 11-5 0 2.5 2.5 0 115 0z",fill:"#f1c40f",strokeWidth:1.75,transform:"translate(3 -1051.362)"}),c.createElement("path",{d:"M10 1037.362l-3 3.188v2.812h10z",fill:"#d35400",transform:"translate(3 -1051.362)"})),bt=c.createElement("use",{x:0,y:0,xlinkHref:"#a",id:"b",transform:"translate(-2 20)",width:"100%",height:"100%"}),wt=c.createElement("use",{xlinkHref:"#b",transform:"translate(-3 4)",width:"100%",height:"100%"}),vt=c.createElement("use",{xlinkHref:"#b",transform:"translate(-6 8)",width:"100%",height:"100%"});function yt(e,t){let o=e.title,n=e.titleId,r=ft(e,["title","titleId"]);return c.createElement("svg",pt({xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",width:24,height:24,viewBox:"0 0 24 24",ref:t,"aria-labelledby":n},r),o?c.createElement("title",{id:n},o):null,gt,bt,wt,vt)}const jt=c.forwardRef(yt);o.p,o(62);class Ot extends l.a.Component{constructor(e){super(e),this.state={name:"Untitled",thumbnailBlobURL:null}}componentDidMount(){const e=this.props.documentID;s.a.getItem("document:".concat(e,":name")).then((e=>{e&&this.setState({name:e})})),s.a.getItem("document:".concat(e,":thumbnail")).then((e=>{e&&this.setState({thumbnailBlobURL:URL.createObjectURL(e)})}))}componentWillUnmount(){URL.revokeObjectURL(this.state.thumbnailBlobURL)}render(){const e=this.props.documentID;return Object(n.jsxs)("a",{href:"?document=".concat(e),children:[Object(n.jsx)("div",{className:"document-thumbnail",children:Object(n.jsx)("img",{src:this.state.thumbnailBlobURL,alt:""})}),this.state.name||"Untitled"]})}}class xt extends l.a.Component{constructor(e){super(e),this.state={documentIDs:null}}componentDidMount(){const e=()=>s.a.keys().then((e=>{let t=e.map((e=>e.match(/document:([a-zA-Z0-9\-_]+):state/))).filter((e=>e)).map((e=>e[1]));t=[this.props.currentDocumentID,...t.filter((e=>e!==this.props.currentDocumentID))],t.sort(),this.setState({documentIDs:t})}));e(),this.iid=setInterval(e,600)}componentWillUnmount(){clearInterval(this.iid)}render(){let e="Loading documents list...";if(this.state.documentIDs){e=this.state.documentIDs.map((e=>Object(n.jsx)("li",{"data-document-id":e,children:Object(n.jsx)(Ot,{documentID:e})},e)))}return Object(n.jsx)(ze,{maxWidth:"",message:Object(n.jsx)("div",{className:"document-picker-dialog-message",children:Object(n.jsx)("ul",{className:"document-picker-dialog-documents",children:e})}),close:this.props.close})}}var Dt=xt;o(63);function Et(){try{if("dark"===localStorage["mopaint-color-scheme"])return"dark";if("light"===localStorage["mopaint-color-scheme"])return"light"}catch(e){}return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function Nt(){return Object(c.useLayoutEffect)((()=>{document.documentElement.setAttribute("data-color-scheme",Et())})),Object(n.jsxs)("button",{className:"dark-mode-button","aria-label":"Toggle Dark Mode",onClick:()=>{localStorage["mopaint-color-scheme"]="light"===Et()?"dark":"light",document.documentElement.setAttribute("data-color-scheme",Et())},children:[Object(n.jsxs)("div",{className:"rays",children:[Object(n.jsx)("div",{className:"ray"}),Object(n.jsx)("div",{className:"ray"}),Object(n.jsx)("div",{className:"ray"}),Object(n.jsx)("div",{className:"ray"}),Object(n.jsx)("div",{className:"ray"}),Object(n.jsx)("div",{className:"ray"}),Object(n.jsx)("div",{className:"ray"}),Object(n.jsx)("div",{className:"ray"})]}),Object(n.jsx)("div",{className:"sun-moon",children:Object(n.jsx)("div",{className:"shadow"})})]})}const It=e=>{const t=le[e];if(!t)throw new Error("Tool not found with name '".concat(e,"'"));return t};class St extends c.Component{constructor(e){super(e),this.state={palette:Ve,selectedSwatch:"rgb(0, 0, 0)",selectedTool:It("Freeform Line"),undos:new p.List,redos:new p.List,currentHistoryNode:new S({name:"New Document"}),loaded:!1,loadFailed:!1},this.thumbnailsByOperation=new Map,this.timeoutIDs=new Set;this.saveDebounced=((e,t)=>{let o;return()=>{clearTimeout(o),this.timeoutIDs.delete(o),o=setTimeout(e,t),this.timeoutIDs.add(o)}})(this.save.bind(this),500)}loadSerializedDocument(e,t){let o,r;try{var a=function(e,t,o){const r=t?"document":"document state";if("mopaint"!==e.format)return[{message:"Can't load ".concat(r," - it does not appear to be a Mopaint document")}];if("number"!==typeof e.formatVersion||e.formatVersion>k)return[{message:"Can't load ".concat(r," created by later version of the app")}];if(.1===e.formatVersion&&(e.formatVersion=.3),.3===e.formatVersion){e.formatVersion=.4;const t=+new Date("January 1, 2020 00:00:00"),o={name:"New Document",id:I(),childHNIDs:[],timestamp:t},n={};n[o.id]=o;const r=new Map,s=e=>{const o=I();n[o]={id:o,operation:e,name:e.toolID,parentHNID:void 0,childHNIDs:[],timestamp:t},r.set(e,n[o])};let a;e.undos.forEach(s),e.redos.forEach(s);const i=[],c=[],l=(e,t)=>{e&&(e.childHNIDs.push(t.id),t.parentHNID=e.id)},d=[...e.undos,...[...e.redos].reverse()];[o,...d.map((e=>r.get(e)))].forEach(((e,t,o)=>{const n=o[t-1];n&&l(n,e),e.timestamp+=t})),i.push(o.id),d.forEach((t=>{const o=r.get(t);t===e.undos[e.undos.length-1]?a=o.id:e.redos.indexOf(t)>-1?c.push(o.id):i.push(o.id)})),e.historyNodesByID=n,e.currentHNID=a,e.undoHNIDs=i,e.redoHNIDs=c,delete e.undos,delete e.redos}if(.4===e.formatVersion){e.formatVersion=.5;for(var s=0,a=Object.values(e.historyNodesByID);s<a.length;s++){var i;const e=a[s];"Fill"===(null===(i=e.operation)||void 0===i?void 0:i.name)&&(e.operation.points.length=1)}}if(e.formatVersion<k){const t="format-version-".concat(e.formatVersion);return[{message:Object(n.jsxs)(l.a.Fragment,{children:[Object(n.jsxs)("p",{children:["Can\u2019t load ",r," created by old version of the app; there\u2019s no upgrade path from format version ",e.formatVersion," to ",k," (minimum loadable: ".concat(.1,")")]}),Object(n.jsxs)("p",{children:["To load this ",r,", use the version of Mopaint at the Git branch\xa0",Object(n.jsx)("a",{href:"https://github.com/1j01/mopaint/tree/".concat(t),style:{fontFamily:"monospace"},children:t})]})]})}]}const c=(e,t,o)=>{e.forEach((e=>{if(!t[e])throw new TypeError("expected property '".concat(e,"' ").concat(o))}))},d=e=>{c(["id","toolID","points","swatch"],e,"on operation with ID ".concat(e.id));const t=o(e.toolID);return{id:e.id,tool:t,points:e.points,swatch:e.swatch}};c(["palette","selectedSwatch","selectedToolID","undoHNIDs","redoHNIDs","currentHNID","historyNodesByID"],e,"on the root document object");const h={};for(var u=0,f=Object.entries(e.historyNodesByID);u<f.length;u++){const e=Object(m.a)(f[u],2),t=e[0],o=e[1];h[t]=new S(o),o.operation&&(h[t].operation=d(o.operation))}const g=e=>h[e];for(var b=0,w=Object.entries(e.historyNodesByID);b<w.length;b++){const e=Object(m.a)(w[b],2),t=e[0],o=e[1];h[t].parentNode=h[o.parentHNID],h[t].childNodes=o.childHNIDs.map(g)}return[null,{palette:e.palette,selectedSwatch:e.selectedSwatch,selectedTool:o(e.selectedToolID),undos:new p.List(e.undoHNIDs.map(g)),redos:new p.List(e.redoHNIDs.map(g)),currentHistoryNode:g(e.currentHNID)}]}(e,t,It),i=Object(m.a)(a,2);o=i[0],r=i[1]}catch(c){o={message:"Failed to load document!",error:c}}o?(this.showError(o),this.setState({loadFailed:!0})):(r.loaded=!0,this.setState(r,(()=>{console.log("Loaded ".concat(this.props.documentID)),s.a.getItem("document:".concat(this.props.documentID,":thumbnail")).then((e=>{e||requestAnimationFrame((()=>{this.saveThumbnail()}))}))})))}load(){if(!this.props.documentID)return void console.log("No document ID to load");console.log("Load ".concat(this.props.documentID));const e=this.props.serializedDocumentToLoad;s.a.getItem("document:".concat(this.props.documentID,":state"),((t,o)=>{if(t)return this.showError({message:"Failed to load document state from storage!",error:t}),void this.setState({loadFailed:!0});if(e)o?this.showError({message:"Almost loaded a document over an existing document. This shouldn't happen!",requestBugReport:!0}):this.loadSerializedDocument(e);else{if(!o)return this.setState({loaded:!0}),void console.log("State loaded as empty for document:".concat(this.props.documentID,":state"));console.log("Loaded data for ".concat(this.props.documentID)),this.loadSerializedDocument(o)}}))}save(e){if(!this.state.loaded)return void(e||(this.setState({undos:new p.List,redos:new p.List,loaded:!1}),this.showError({message:"The document ".concat(this.state.loadFailed?"failed to load":"hasn't loaded yet",". Start a new document?"),extraButtons:Object(n.jsx)("button",{onClick:this.props.createNewDocument,children:"New Document"})})));const t=H(this.state);s.a.setItem("document:".concat(this.props.documentID,":state"),t,(t=>{const o=e?"the previous document":"document";t?"QuotaExceededError"!==t.name||t.message?"QuotaExceededError"===t.name?this.showError({message:Object(n.jsxs)("div",{children:["Failed to save ",o," into storage!",Object(n.jsx)("br",{}),Object(n.jsx)("br",{}),"Ran out of space allowed by the browser. You could free up quota by clearing the storage for this site in your browser\u2019s settings, however, this will delete all documents."]}),error:t}):this.showError({message:"Failed to save ".concat(o," into storage!"),error:t}):this.showError({message:Object(n.jsxs)("div",{children:["Failed to save ",o," into storage!",Object(n.jsx)("br",{}),Object(n.jsx)("br",{}),"Check that your computer has enough disk space.",Object(n.jsx)("br",{}),Object(n.jsx)("br",{}),"If you have enough free space, we\u2019ve run out of space as allowed by the browser per site. You could free up quota by clearing the storage for this site in your browser\u2019s settings, however, this will delete all documents."]}),error:t}):(console.log("Saved ".concat(this.props.documentID).concat(e?" (leaving it)":"")),this.saveThumbnail())}))}saveThumbnail(){const e=document.querySelector(".DrawingCanvas canvas"),t=e.width/e.height,o=document.createElement("canvas");o.width=Math.min(100,e.width,e.height*t),o.height=o.width/t,o.getContext("2d").drawImage(e,0,0,o.width,o.height),o.toBlob((e=>{s.a.setItem("document:".concat(this.props.documentID,":thumbnail"),e,(()=>{}))}))}createPNGram(e,t,o){const n=JSON.stringify(e),r={Software:"Mopaint","Mopaint Format Version":e.formatVersion,"Creation Time":(new Date).toUTCString(),"Program Source":n};console.log("Save PNG with metadata",r);this.createRawPNG((e=>{D(e,r,(e=>{((e,t,o)=>{const r=new FileReader;r.onload=()=>{const e=r.result;E(new Uint8Array(e))["Program Source"]===n?t():o()},r.readAsArrayBuffer(e)})(e,(()=>{t(e)}),(()=>{o()}))}))}))}createRawPNG(e){document.querySelector(".DrawingCanvas canvas").toBlob(e,"image/png")}loadDocumentFromJSON(e,t){let o;try{o=JSON.parse(e)}catch(r){return void this.showError({message:Object(n.jsxs)("div",{children:["Failed to load as Mopaint document, invalid JSON",Object(n.jsxs)("details",{children:[Object(n.jsx)("summary",{children:"JSON"}),Object(n.jsx)("div",{className:"actual-details",children:Object(n.jsx)("pre",{children:e})})]})]}),error:r})}this.props.loadNewDocument(o,t)}handleDroppedOrOpenedFiles(e){const t=e[0];if(t){const e=new FileReader;e.onload=()=>{const o=e.result,n=new Uint8Array(o);if(b()(n)){const e=E(n);if(e["Mopaint Format Version"]){const o=e["Program Source"];this.loadDocumentFromJSON(o,t.name)}else this.showError({message:"Loading images is not supported yet (other than Mopaint PNG programs)"})}else if(n[0]==="{".charCodeAt(0)){const e=new FileReader;e.onload=()=>{this.loadDocumentFromJSON(e.result)},e.readAsText(t)}else Object(f.loadPalette)(t,((e,t)=>{e?this.showError({message:"Failed to load file as a color palette.",error:e}):this.setState({palette:t.map((e=>e.toString()))},this.saveDebounced.bind(this))}))},e.readAsArrayBuffer(t)}}openDocument(){const e=document.createElement("input");e.type="file",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",(()=>{this.handleDroppedOrOpenedFiles(e.files),e.remove()})),e.click()}componentDidMount(){this.load(),window.addEventListener("beforeunload",this.beforeUnloadListener=()=>{this.save(!0)}),window.addEventListener("keydown",this.keyDownListener=e=>{if("Escape"!==e.key){if((!document.activeElement||!document.activeElement.matches("input, textarea"))&&e.ctrlKey){if("z"===e.key)this.undo();else if("Z"===e.key||"y"===e.key)this.redo();else if("s"===e.key||"S"===e.key)this.showSaveDialog();else{if("o"!==e.key)return;this.openDocument()}e.preventDefault()}}else this.closeDialog()}),window.addEventListener("dragover",this.dragOverListener=e=>{e.preventDefault()}),window.addEventListener("drop",this.dropListener=e=>{e.preventDefault(),this.handleDroppedOrOpenedFiles(e.dataTransfer.files)})}componentWillUnmount(){this.save(!0),this.timeoutIDs.forEach((e=>{clearTimeout(e)})),window.removeEventListener("beforeunload",this.beforeUnloadListener),window.removeEventListener("keydown",this.keyDownListener),window.removeEventListener("dragover",this.dragOverListener),window.removeEventListener("drop",this.dropListener)}UNSAFE_componentWillReceiveProps(e){console.assert(e.documentID===this.props.documentID,"App component is not designed to handle switching documents without reconstruction")}addOperation(e){let t=this.state,o=t.currentHistoryNode,n=t.undos,r=t.redos;r=new p.List,n=n.push(o);const s=new S({parentNode:o,name:e.tool.name,operation:e});o.childNodes.push(s),o=s,this.setState({currentHistoryNode:o,undos:n,redos:r},this.save.bind(this))}updateOperation(){this.setState({currentHistoryNode:this.state.currentHistoryNode},this.saveDebounced.bind(this))}undo(){const e=this.state,t=function({currentHistoryNode:e,undos:t,redos:o}){return t.size<1?{currentHistoryNode:e,undos:t,redos:o}:(o=o.push(e),C(t.last(),{currentHistoryNode:e,undos:t=t.pop(),redos:o}))}({currentHistoryNode:e.currentHistoryNode,undos:e.undos,redos:e.redos});this.setState({currentHistoryNode:t.currentHistoryNode,undos:t.undos,redos:t.redos},this.saveDebounced.bind(this))}redo(){const e=this.state,t=function({currentHistoryNode:e,undos:t,redos:o}){return o.size<1?{currentHistoryNode:e,undos:t,redos:o}:(t=t.push(e),C(o.last(),{currentHistoryNode:e,undos:t,redos:o=o.pop()}))}({currentHistoryNode:e.currentHistoryNode,undos:e.undos,redos:e.redos});this.setState({currentHistoryNode:t.currentHistoryNode,undos:t.undos,redos:t.redos},this.saveDebounced.bind(this))}goToHistoryNode(e){const t=this.state,o=C(e,{currentHistoryNode:t.currentHistoryNode,undos:t.undos,redos:t.redos});this.setState({currentHistoryNode:o.currentHistoryNode,undos:o.undos,redos:o.redos},this.saveDebounced.bind(this))}render(){const e=this.state,t=e.selectedSwatch,o=e.selectedTool,r=e.palette,s=e.currentHistoryNode,a=e.dialog,i=[];return(e=>{for(e.operation&&i.push(e.operation);e.parentNode;)(e=e.parentNode).operation&&i.push(e.operation);i.reverse()})(s),Object(n.jsxs)("div",{className:"App",children:[Object(n.jsxs)("main",{children:[Object(n.jsxs)(Ue,{children:["\u26a0 This app is in very early stages of development. There are Big Plans. See the ",Object(n.jsx)("a",{href:"https://github.com/1j01/mopaint#mopaint",target:"_blank",rel:"noopener noreferrer",children:"README on GitHub for more info"}),"."]}),Object(n.jsxs)("div",{id:"documents-options",children:[Object(n.jsx)("button",{id:"new-document",className:"toolbar-button",onClick:this.props.createNewDocument,"aria-label":"New Document",title:"New Document",children:Object(n.jsx)(_e,{width:"48px",height:"48px"})}),Object(n.jsx)("button",{id:"save-document",className:"toolbar-button",onClick:()=>{this.showSaveDialog()},"aria-label":"Save Document",title:"Save Document",children:Object(n.jsx)(mt,{width:"48px",height:"48px"})}),Object(n.jsx)("button",{id:"open-document",className:"toolbar-button",onClick:()=>{this.openDocument()},"aria-label":"Open Document",title:"Open Document",children:Object(n.jsx)(nt,{width:"48px",height:"48px"})}),Object(n.jsx)("button",{id:"show-document-picker",className:"toolbar-button",onClick:()=>{this.showChooseDocumentDialog()},"aria-label":"Show Documents",title:"Show Documents",children:Object(n.jsx)(jt,{width:"48px",height:"48px"})}),Object(n.jsx)("div",{style:{flex:1}}),Object(n.jsx)(Nt,{})]}),Object(n.jsx)(je,{tools:ce,selectedTool:o,selectTool:e=>{this.setState({selectedTool:e},this.saveDebounced.bind(this))}}),Object(n.jsx)(Ee,{palette:r,selectedSwatch:t,selectSwatch:e=>{this.setState({selectedSwatch:e},this.saveDebounced.bind(this))}}),Object(n.jsx)(ge,{loaded:this.state.loaded||this.state.loadFailed,selectedSwatch:t,selectedTool:o,documentContext:this.documentContext,addOperation:this.addOperation.bind(this),updateOperation:this.updateOperation.bind(this),operations:i,thumbnailsByOperation:this.thumbnailsByOperation,ref:e=>{this.drawingCanvasComponent=e}})]}),Object(n.jsx)("div",{className:"sidebar",children:Object(n.jsx)(Te,{loaded:this.state.loaded||this.state.loadFailed,currentHistoryNode:this.state.currentHistoryNode,undos:this.state.undos,redos:this.state.redos,goToHistoryNode:this.goToHistoryNode.bind(this),thumbnailsByOperation:this.thumbnailsByOperation})}),a]})}showError(e){e=Object(u.a)({isError:!0},e),window.console&&e.error&&console.error("(Error details:)",e.error),this.showMessage(e)}showMessage(e){this.showDialog(Object(n.jsx)(ze,{message:e.message,error:e.error,isError:e.isError,requestBugReport:e.requestBugReport,extraButtons:e.extraButtons,buttons:e.buttons,close:this.closeDialog.bind(this)}))}showDialog(e){this.setState({dialog:e})}closeDialog(){this.setState({dialog:null})}showChooseDocumentDialog(){const e=this.closeDialog.bind(this);this.showDialog(Object(n.jsx)(Dt,{close:e,currentDocumentID:this.props.documentID}))}showSaveDialog(){const e=this.props.documentID,t=this.createPNGram.bind(this),o=this.createRawPNG.bind(this),r=this.closeDialog.bind(this),a=this.showError.bind(this),i=this.state,l=document.createElement("a");function d(d){const h=Object(c.useState)("hybrid"),u=Object(m.a)(h,2),p=u[0],f=u[1],g=Object(c.useState)(d.defaultName),b=Object(m.a)(g,2),w=b[0],v=b[1],y=Object(c.useState)(null),j=Object(m.a)(y,2),O=j[0],x=j[1],D=e=>{x((t=>(URL.revokeObjectURL(t),e)))},E=Object(c.useRef)(null),N={hybrid:"png","raw-image":"png",program:"mop"}[p],I=w.replace(new RegExp("\\."+N+"$","i"),"")+"."+N,S=()=>{l.download=I,l.href=O,console.log("Download",O),l.click(),r(),s.a.setItem("document:".concat(e,":name"),w,(()=>{}))};return Object(c.useEffect)((()=>{E.current.select()}),[]),Object(c.useEffect)((()=>()=>{D(null),l.remove()}),[]),Object(c.useEffect)((()=>{if(D(null),"hybrid"===p){const e=H(i);t(e,(e=>{const t=URL.createObjectURL(e);D(t)}),(()=>{alert("Failed to save hybrid document (probably too large) - try the other save options.")}))}else if("raw-image"===p)o((e=>{const t=URL.createObjectURL(e);D(t)}));else if("program"===p){const e=H(i),t=new Blob([JSON.stringify(e)],{type:"application/x-mopaint+json"}),o=URL.createObjectURL(t);D(o)}else a({message:"This shouldn't happen, saveType=".concat(p),requestBugReport:!0})}),[p]),Object(n.jsx)(ze,{message:Object(n.jsx)("div",{className:"save-dialog-message",children:Object(n.jsxs)("form",{className:"save-dialog-form",onSubmit:e=>{e.preventDefault(),S()},children:[Object(n.jsxs)("label",{children:["Name:"," ",Object(n.jsx)("input",{type:"text",value:w,autoFocus:!0,onChange:e=>{v(e.target.value)},ref:E})]}),Object(n.jsx)("div",{style:{marginTop:"1em"},children:Object(n.jsxs)("select",{value:p,onChange:e=>f(e.target.value),children:[Object(n.jsx)("option",{value:"hybrid",children:"Hybrid Mopaint Document and Image (.png)"}),Object(n.jsx)("option",{value:"program",children:"Mopaint Document (.mop)"}),Object(n.jsx)("option",{value:"raw-image",children:"Raw Image (.png)"})]})})]})}),close:r,extraButtons:Object(n.jsxs)("button",{onClick:S,disabled:!O,children:["Save ",O?"":"(please wait...)"]})})}l.className="for-downloading-files",l.tabIndex=-1,document.body.appendChild(l),s.a.getItem("document:".concat(e,":name")).then((e=>{this.showDialog(Object(n.jsx)(d,{defaultName:e||"Drawing"}))}),(()=>{this.showDialog(Object(n.jsx)(d,{defaultName:"Drawing"}))}))}}var Lt=St;const Ct=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function Pt(e){navigator.serviceWorker.register(e).then((e=>{e.onupdatefound=()=>{const t=e.installing;t.onstatechange=()=>{"installed"===t.state&&(navigator.serviceWorker.controller?console.log("New content is available; please refresh."):console.log("Content is cached for offline use."))}}})).catch((e=>{console.error("Error during service worker registration:",e)}))}o(64);"http:"===window.location.protocol&&window.location.host.match(/editor|app|mopaint/)&&(window.location.protocol="https:");const Mt=e=>"".concat(window.location.origin).concat(window.location.pathname,"?document=").concat(e),kt=e=>{window.location.search.match(/^\?./)?window.history.pushState({},null,Mt(e)):window.history.replaceState({},null,Mt(e)),Tt()},Ht=()=>{const e=i.a.generate();kt(e)};let Rt={serializedDocument:null,documentID:null};const Ft=(e,t)=>{const o=i.a.generate();Rt={serializedDocument:e,documentID:o},console.log("Start new document (".concat(o,") from"),e),s.a.setItem("document:".concat(o,":name"),t.replace(/(\.mop(aint))?(\.png)?$/i,""),(()=>{kt(o)}))},Tt=()=>{const e=document.getElementById("root"),t=(window.location.search.match(/document=([\w\-./]*)/)||[])[1];if(!t)return void Ht();let o;t===Rt.documentID&&(o=Rt.serializedDocument,Rt={serializedDocument:null,documentID:null}),h.a.render(Object(n.jsx)(Lt,{documentID:t,goToDocument:kt,createNewDocument:Ht,loadNewDocument:Ft,serializedDocumentToLoad:o},t),e)};window.addEventListener("popstate",Tt),Tt(),function(){if("serviceWorker"in navigator){if(new URL("",window.location).origin!==window.location.origin)return;window.addEventListener("load",(()=>{const e="".concat("","/service-worker.js");Ct?function(e){fetch(e).then((t=>{404===t.status||-1===t.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then((e=>{e.unregister().then((()=>{window.location.reload()}))})):Pt(e)})).catch((()=>{console.log("No internet connection found. App is running in offline mode.")}))}(e):Pt(e)}))}}()}},[[65,1,2]]]);
//# sourceMappingURL=main.12869f0c.chunk.js.map