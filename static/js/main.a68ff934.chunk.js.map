{"version":3,"sources":["simulate-gestures.js","png-metadata.js","helpers.js","HistoryNode.js","history.js","document-format.js","tools/line.js","tools/circle.js","tools/rectangle.js","tools/mirror-symmetry.js","tools/rotational-symmetry.js","icons/flaticons-fill-bucket-flipped.svg","tools/index.js","tools/fill.js","engine.js","components/DrawingCanvas.js","trim-canvas.js","components/ToolPreview.js","components/Toolbox.js","components/Palette.js","components/Colorbox.js","components/HistoryEntry.js","icons/small-n-flat/document-new-16px-importable.svg","components/HistoryView.js","components/Dialog.js","components/Warning.js","db32-palette.js","icons/small-n-flat/document-new-importable.svg","icons/small-n-flat/document-open-importable.svg","icons/small-n-flat/document-save-importable.svg","components/App.js","registerServiceWorker.js","index.js"],"names":["gestureTimeoutID","periodicGesturesTimeoutID","window","simulateRandomGesture","callback","target","document","querySelector","rect","getBoundingClientRect","triggerMouseEvent","type","point","event","MouseEvent","view","bubbles","cancelable","clientX","left","x","clientY","top","y","dispatchEvent","t","cx","Math","random","width","cy","height","gestureComponents","i","push","rx","min","ry","angularFactor","angularOffset","pointForTime","length","sin","PI","cos","move","setTimeout","simulateRandomGesturesPeriodically","delayBetweenGestures","waitThenGo","stopSimulatingGestures","clearTimeout","injectMetadataIntoBlob","blob","metadata","fileReader","FileReader","onload","arrayBuffer","result","uint8Array","Uint8Array","chunks","pngChunksExtract","readAsArrayBuffer","readPngChunksFromBlob","k","hasOwnProperty","splice","pngChunkText","encode","reencodedBuffer","pngChunksEncode","reencodedBlob","Blob","readMetadataSync","textChunks","filter","chunk","name","map","decode","data","textChunk","keyword","text","byteToHex","byte","toString","slice","generateID","array","crypto","getRandomValues","Array","from","join","HistoryNode","parentNode","timestamp","operation","id","this","childNodes","Date","now","goToHistoryNode","targetHistoryNode","currentHistoryNode","redos","undos","fromHistoryNode","oldHistoryPath","size","first","getHistoryAncestors","ancestorsOfTarget","List","reverse","latestNode","futures","sort","a","b","indexOf","unshift","node","ancestors","getAllHistoryNodesSortedByTimestamp","anyHistoryNodeInGraph","rootHistoryNode","historyNode","getRoot","allHistoryNodes","collectNodes","serializeDocument","palette","selectedSwatch","selectedTool","toID","historyNodesByID","forEach","parentHNID","childHNIDs","toolID","tool","points","swatch","format","formatVersion","selectedToolID","undoHNIDs","toJS","redoHNIDs","currentHNID","line","ctx","x1","y1","x2","y2","beginPath","moveTo","lineTo","strokeStyle","lineWidth","lineCap","stroke","circle","radius","hypot","arc","fillStyle","fill","rectangle","getMirrorSymmetryPoints","flipCenterX","flipCenterY","reflectPoint","getRotationalSymmetryPoints","centerX","centerY","relativeX","relativeY","distance","angle","atan2","theta","_extends","Object","assign","arguments","source","key","prototype","call","apply","_objectWithoutProperties","excluded","sourceKeys","keys","_objectWithoutPropertiesLoose","getOwnPropertySymbols","sourceSymbolKeys","propertyIsEnumerable","_ref2","createElement","_ref4","_ref8","_ref9","_ref10","_ref11","_ref12","_ref13","_ref14","_ref15","_ref16","_ref","svgRef","title","props","viewBox","style","enableBackground","xmlSpace","ref","transform","d","ForwardRef","forwardRef","tools","drawSegmentOfPath","drawShape","Icon","FillBucketIcon","drawFromPoint","opCtx","documentCtx","drawImage","canvas","floor","stack","imageData","getImageData","pixelIndex","startR","startG","startB","startA","onePixelCanvasCtx","getContext","fillRect","onePixelImageData","fillR","fillG","fillB","fillA","newPos","reachLeft","reachRight","pop","matchesStartColor","colorPixel","putImageData","drawFromGesturePoints","opContext","i1","i2","getPreviewGesturePoints","startPos","lastPos","documentContext","prefix","pointToPoints","mirrorReflect","rotationallyReflect","modifier","originalTool","newKey","newTool","gesturePoints","pointses","gesturePoint","symmetricPoints","toolsArray","toolsByName","opCanvas","DrawingCanvas","canvasRef","React","createRef","cache","hashInDocumentByOperation","Map","animationFrameID","cancelAnimationFrame","requestAnimationFrame","documentCanvas","operations","thumbnailsByOperation","clearRect","runningHash","sha256","operationIndex","update","JSON","stringify","operationHash","digest","set","updatingContinously","thumbnail","draw","current","className","preventDefault","pos","toCanvasCoords","updateOperation","which","addOperation","setCapture","body","classList","add","console","warn","remove","mouseIsDown","addEventListener","mouseDownListener","button","onMouseDown","mouseMoveListener","onMouseMoveWhileDown","mouseUpListener","removeEventListener","onMouseUp","Component","trimCanvas","rowBlank","columnBlank","bottom","right","trimmed","copy","ownerDocument","copyCtx","ToolPreview","ReactDOM","findDOMNode","refs","drawWidth","drawHeight","trimmedCanvas","Toolbox","selectTool","role","selected","aria-checked","onClick","Palette","selectSwatch","backgroundColor","Colorbox","Thumbnail","drawFunctionsArrayToAddTo","maybeLoadingTime","indexInListForAnimationOffset","getImageMaybe","el","innerHeight","isScrolledIntoView","image","performance","max","textBaseline","textAlign","font","fillText","HistoryEntry","ancestorOfCurrent","getThumbnailImageMaybe","getIconReactElementMaybe","r","blankImage","Image","src","HistoryView","currentEntryRef","drawFunctions","animate","fn","scrollSelectedEntryIntoView","prevProps","entryEl","scrollIntoView","behavior","block","inline","historyAncestors","get","ReportBugLink","href","rel","children","Dialog","message","error","requestBugReport","isError","close","extraButtons","buttons","stackTraceText","trimEnd","trim","replace","errorText","Warning","getToolByName","Error","App","state","defaultPalette","loaded","loadFailed","timeoutIDs","Set","saveDebounced","func","delay","timeoutID","delete","debounce","save","bind","serialized","fromFile","errorInfo","stateUpdates","isFromFile","nounPhraseThingToLoad","baseTimestamp","opToHN","makeFreeFloatingHN","op","undefined","orderedOps","index","orderedHNs","parentHN","childHN","previousHistoryNode","values","gitBranchName","Fragment","fontFamily","expectPropertiesToExist","properties","object","locationMessage","TypeError","deserializeOperation","serializedOperation","entries","historyNodeID","historyNodeData","fromHNID","deserializeDocument","showError","setState","log","documentID","serializedDocumentToLoad","localforage","getItem","loadSerializedDocument","leavingThisDocument","setItem","documentThatYouWereMaybeLeaving","createNewDocument","serializedDocument","mismatchedCallback","json","toUTCString","createRawPNG","rawImageBlob","pngramBlob","encodedBlob","verifiedCallback","verifyEncodedBlob","toBlob","parse","loadNewDocument","files","file","isPNG","loadDocumentFromJSON","charCodeAt","readAsText","loadPalette","color","input","display","appendChild","handleDroppedOrOpenedFiles","click","load","beforeUnloadListener","keyDownListener","activeElement","matches","ctrlKey","undo","redo","showSaveDialog","openDocument","closeDialog","dragOverListener","e","dropListener","dataTransfer","nextProps","assert","newHistoryNode","newState","last","dialog","collectOperations","value","onChange","goToDocument","documentIDs","aria-label","component","drawingCanvasComponent","dialogState","showMessage","showDialog","createPNGram","tabIndex","useState","saveType","setSaveType","setName","blobUrl","setBlobUrlWithoutRevokingOld","revokeOldAndSetBlobUrl","newBlobUrl","oldBlobUrl","URL","revokeObjectURL","inputRef","useRef","fileExt","fileName","RegExp","saveFileAndCloseDialog","download","useEffect","select","pngramBlobUrl","createObjectURL","alert","rawPngBlob","rawPngBlobUrl","programSourceBlob","programBlobUrl","onSubmit","autoFocus","marginTop","disabled","isLocalhost","Boolean","location","hostname","match","registerValidSW","swUrl","navigator","serviceWorker","register","then","registration","onupdatefound","installingWorker","installing","onstatechange","controller","catch","protocol","host","urlForID","origin","pathname","search","history","pushState","replaceState","render","newDocumentID","shortid","generate","toLoad","updateDocumentsList","container","getElementById","setInterval","process","fetch","response","status","headers","ready","unregister","reload","checkValidServiceWorker","registerServiceWorker"],"mappings":"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","file":"static/js/main.a68ff934.chunk.js","sourcesContent":["let gestureTimeoutID;\r\nlet periodicGesturesTimeoutID;\r\n\r\nwindow.simulateRandomGesture = (callback) => {\r\n\tlet target = document.querySelector(\"canvas\");\r\n\r\n\tlet rect = target.getBoundingClientRect();\r\n\r\n\tlet triggerMouseEvent = (type, point) => {\r\n\t\tlet event = new MouseEvent(type, {\r\n\t\t\tview: window,\r\n\t\t\tbubbles: true,\r\n\t\t\tcancelable: true,\r\n\t\t\tclientX: rect.left + point.x,\r\n\t\t\tclientY: rect.top + point.y,\r\n\t\t});\r\n\t\ttarget.dispatchEvent(event);\r\n\t};\r\n\r\n\tlet t = 0;\r\n\tlet cx = Math.random() * rect.width;\r\n\tlet cy = Math.random() * rect.height;\r\n\tlet gestureComponents = [];\r\n\tlet numberOfComponents = 5;\r\n\tfor (let i = 0; i < numberOfComponents; i += 1) {\r\n\t\tgestureComponents.push({\r\n\t\t\trx:\r\n\t\t\t\t(Math.random() * Math.min(rect.width, rect.height)) /\r\n\t\t\t\t2 /\r\n\t\t\t\tnumberOfComponents,\r\n\t\t\try:\r\n\t\t\t\t(Math.random() * Math.min(rect.width, rect.height)) /\r\n\t\t\t\t2 /\r\n\t\t\t\tnumberOfComponents,\r\n\t\t\tangularFactor: Math.random() * 5 - Math.random(),\r\n\t\t\tangularOffset: Math.random() * 5 - Math.random(),\r\n\t\t});\r\n\t}\r\n\tlet pointForTime = (t) => {\r\n\t\tlet point = { x: cx, y: cy };\r\n\t\tfor (let i = 0; i < gestureComponents.length; i += 1) {\r\n\t\t\tlet { rx, ry, angularFactor, angularOffset } = gestureComponents[i];\r\n\t\t\tpoint.x +=\r\n\t\t\t\tMath.sin(Math.PI * 2 * ((t / 100) * angularFactor + angularOffset)) *\r\n\t\t\t\trx;\r\n\t\t\tpoint.y +=\r\n\t\t\t\tMath.cos(Math.PI * 2 * ((t / 100) * angularFactor + angularOffset)) *\r\n\t\t\t\try;\r\n\t\t}\r\n\t\treturn point;\r\n\t};\r\n\ttriggerMouseEvent(\"mousedown\", pointForTime(t));\r\n\tlet move = () => {\r\n\t\tt += 1;\r\n\t\tif (t > 50) {\r\n\t\t\ttriggerMouseEvent(\"mouseup\", pointForTime(t));\r\n\t\t\tif (callback) {\r\n\t\t\t\tcallback();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\ttriggerMouseEvent(\"mousemove\", pointForTime(t));\r\n\t\t\tgestureTimeoutID = setTimeout(move, 10);\r\n\t\t}\r\n\t};\r\n\tmove();\r\n};\r\n\r\nwindow.simulateRandomGesturesPeriodically = (delayBetweenGestures = 50) => {\r\n\tlet waitThenGo = () => {\r\n\t\tperiodicGesturesTimeoutID = setTimeout(() => {\r\n\t\t\twindow.simulateRandomGesture(waitThenGo);\r\n\t\t}, delayBetweenGestures);\r\n\t};\r\n\twindow.simulateRandomGesture(waitThenGo);\r\n};\r\n\r\nwindow.stopSimulatingGestures = () => {\r\n\tclearTimeout(gestureTimeoutID);\r\n\tclearTimeout(periodicGesturesTimeoutID);\r\n};\r\n","import pngChunksExtract from \"png-chunks-extract\";\r\nimport pngChunksEncode from \"png-chunks-encode\";\r\nimport pngChunkText from \"png-chunk-text\";\r\n\r\nconst readPngChunksFromBlob = (blob, callback) => {\r\n\tconst fileReader = new FileReader();\r\n\tfileReader.onload = () => {\r\n\t\tconst arrayBuffer = fileReader.result;\r\n\t\tconst uint8Array = new Uint8Array(arrayBuffer);\r\n\t\tconst chunks = pngChunksExtract(uint8Array);\r\n\t\tcallback(chunks);\r\n\t};\r\n\tfileReader.readAsArrayBuffer(blob);\r\n};\r\n\r\nexport function injectMetadataIntoBlob(blob, metadata, callback) {\r\n\treadPngChunksFromBlob(blob, (chunks) => {\r\n\t\tfor (let k in metadata) {\r\n\t\t\tif (metadata.hasOwnProperty(k)) {\r\n\t\t\t\tchunks.splice(-1, 0, pngChunkText.encode(k, metadata[k]));\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst reencodedBuffer = pngChunksEncode(chunks);\r\n\t\tconst reencodedBlob = new Blob([reencodedBuffer], { type: \"image/png\" });\r\n\t\tcallback(reencodedBlob);\r\n\t});\r\n}\r\n\r\nexport function readMetadataSync(uint8Array) {\r\n\tconst chunks = pngChunksExtract(uint8Array);\r\n\r\n\tconst textChunks = chunks\r\n\t\t.filter((chunk) => chunk.name === \"tEXt\")\r\n\t\t.map((chunk) => pngChunkText.decode(chunk.data));\r\n\r\n\tconst metadata = {};\r\n\r\n\tfor (let i = 0; i < textChunks.length; i++) {\r\n\t\tconst textChunk = textChunks[i];\r\n\t\tmetadata[textChunk.keyword] = textChunk.text;\r\n\t}\r\n\r\n\treturn metadata;\r\n}\r\n","// TODO maybe: more efficient IDs (don't need to restrict the alphabet to hex)\r\nconst byteToHex = (byte) => `0${byte.toString(16)}`.slice(-2);\r\nexport const generateID = (length = 40) => {\r\n\t// length must be an even number (default: 40)\r\n\tconst array = new Uint8Array(length / 2);\r\n\tcrypto.getRandomValues(array);\r\n\treturn Array.from(array, byteToHex).join(\"\");\r\n};\r\n","import {generateID} from \"./helpers.js\";\r\n\r\nexport default class HistoryNode {\r\n\t// NOTE: data may be freely changed after construction, this is basically just a struct\r\n\tconstructor({parentNode, timestamp, operation, name, id}) {\r\n\t\tthis.parentNode = parentNode;\r\n\t\tthis.childNodes = [];\r\n\t\tthis.timestamp = timestamp ?? Date.now();\r\n\t\tthis.operation = operation;\r\n\t\tthis.name = name;\r\n\t\tthis.id = id ?? generateID();\r\n\t}\r\n}\r\n","import { List } from \"immutable\";\r\n\r\nexport function goToHistoryNode(targetHistoryNode, {currentHistoryNode, redos, undos}) {\r\n\tconst fromHistoryNode = currentHistoryNode;\r\n\tconst oldHistoryPath =\r\n\t\tredos.size > 0 ?\r\n\t\t\t[redos.first(), ...getHistoryAncestors(redos.first())] :\r\n\t\t\t[fromHistoryNode, ...getHistoryAncestors(fromHistoryNode)];\r\n\r\n\tconst ancestorsOfTarget = getHistoryAncestors(targetHistoryNode);\r\n\r\n\tundos = new List([...ancestorsOfTarget].reverse());\r\n\r\n\t// window.console && console.log(\"targetHistoryNode:\", targetHistoryNode);\r\n\t// window.console && console.log(\"ancestorsOfTarget:\", ancestorsOfTarget);\r\n\t// window.console && console.log(\"oldHistoryPath:\", oldHistoryPath);\r\n\tredos = new List();\r\n\r\n\tlet latestNode = targetHistoryNode;\r\n\twhile (latestNode.childNodes.length > 0) {\r\n\t\tconst futures = [...latestNode.childNodes];\r\n\t\tfutures.sort((a, b)=> {\r\n\t\t\tif(oldHistoryPath.indexOf(a) > -1) {\r\n\t\t\t\treturn -1;\r\n\t\t\t}\r\n\t\t\tif(oldHistoryPath.indexOf(b) > -1) {\r\n\t\t\t\treturn +1;\r\n\t\t\t}\r\n\t\t\treturn 0;\r\n\t\t});\r\n\t\tlatestNode = futures[0];\r\n\t\tredos = redos.unshift(latestNode);\r\n\t}\r\n\t// window.console && console.log(\"new undos:\", undos);\r\n\t// window.console && console.log(\"new redos:\", redos);\r\n\r\n\treturn { currentHistoryNode: targetHistoryNode, undos, redos };\r\n}\r\n\r\nexport function undo({currentHistoryNode, undos, redos}){\r\n\tif (undos.size < 1) {\r\n\t\treturn {currentHistoryNode, undos, redos};\r\n\t}\r\n\r\n\tredos = redos.push(currentHistoryNode);\r\n\tlet targetHistoryNode = undos.last();\r\n\tundos = undos.pop();\r\n\r\n\treturn goToHistoryNode(targetHistoryNode, {currentHistoryNode, undos, redos});\r\n}\r\n\r\nexport function redo({currentHistoryNode, undos, redos}){\r\n\tif (redos.size < 1) {\r\n\t\t// if (!historyWindowOpen && !historyPromptOpen) {\r\n\t\t// \tshowMessage({\r\n\t\t// \t\tmessage: <React.Fragment>\r\n\t\t// \t\t\tYou can get back to <strong>any state</strong> using the history panel.\r\n\t\t// \t\t</React.Fragment>,\r\n\t\t// \t});\r\n\t\t// }\r\n\t\treturn {currentHistoryNode, undos, redos};\r\n\t}\r\n\r\n\tundos = undos.push(currentHistoryNode);\r\n\tlet targetHistoryNode = redos.last();\r\n\tredos = redos.pop();\r\n\r\n\treturn goToHistoryNode(targetHistoryNode, {currentHistoryNode, undos, redos});\r\n}\r\n\r\nexport function getHistoryAncestors(node) {\r\n\tconst ancestors = [];\r\n\tfor (node = node.parentNode; node; node = node.parentNode) {\r\n\t\tancestors.push(node);\r\n\t}\r\n\treturn ancestors;\r\n}\r\n\r\nfunction getRoot(historyNode) {\r\n\twhile (historyNode.parentNode) {\r\n\t\thistoryNode = historyNode.parentNode;\r\n\t}\r\n\treturn historyNode;\r\n}\r\n\r\nexport function getAllHistoryNodesSortedByTimestamp(anyHistoryNodeInGraph) {\r\n\tconst rootHistoryNode = getRoot(anyHistoryNodeInGraph);\r\n\r\n\tconst allHistoryNodes = [];\r\n\tconst collectNodes = (node)=> {\r\n\t\tfor (const childNode of node.childNodes) {\r\n\t\t\tcollectNodes(childNode);\r\n\t\t}\r\n\t\tallHistoryNodes.push(node);\r\n\t};\r\n\tcollectNodes(rootHistoryNode);\r\n\r\n\tallHistoryNodes.sort((a, b)=> {\r\n\t\tif (a.timestamp < b.timestamp) {\r\n\t\t\treturn -1;\r\n\t\t}\r\n\t\tif (b.timestamp < a.timestamp) {\r\n\t\t\treturn +1;\r\n\t\t}\r\n\t\treturn 0;\r\n\t});\r\n\r\n\treturn allHistoryNodes;\r\n}\r\n","import React from \"react\";\r\nimport { List } from \"immutable\";\r\nimport HistoryNode from \"./HistoryNode\";\r\nimport {generateID} from \"./helpers.js\";\r\nimport {getAllHistoryNodesSortedByTimestamp} from \"./history.js\";\r\n\r\nexport const CURRENT_SERIALIZATION_VERSION = 0.5;\r\n\r\nexport function serializeDocument({palette, selectedSwatch, selectedTool, undos, redos, currentHistoryNode}) {\r\n\t// TODO: serialize tools as code (+ identifiers), and create a sandbox?\r\n\r\n\tconst serializeOperation = (operation) => {\r\n\t\treturn {\r\n\t\t\tid: operation.id,\r\n\t\t\ttoolID: operation.tool.name,\r\n\t\t\tpoints: operation.points,\r\n\t\t\tswatch: operation.swatch,\r\n\t\t};\r\n\t};\r\n\tconst allHistoryNodes = getAllHistoryNodesSortedByTimestamp(currentHistoryNode);\r\n\r\n\tconst toID = (historyNode)=> historyNode.id;\r\n\r\n\tconst historyNodesByID = {};\r\n\tallHistoryNodes.forEach((historyNode)=> {\r\n\t\thistoryNodesByID[historyNode.id] = {\r\n\t\t\tparentHNID: historyNode.parentNode && historyNode.parentNode.id,\r\n\t\t\tchildHNIDs: historyNode.childNodes.map(toID),\r\n\t\t\ttimestamp: historyNode.timestamp,\r\n\t\t\toperation: historyNode.operation && serializeOperation(historyNode.operation),\r\n\t\t\tname: historyNode.name,\r\n\t\t\tid: historyNode.id,\r\n\t\t};\r\n\t});\r\n\r\n\treturn {\r\n\t\tformat: \"mopaint\",\r\n\t\tformatVersion: CURRENT_SERIALIZATION_VERSION,\r\n\t\tpalette: palette,\r\n\t\tselectedSwatch: selectedSwatch,\r\n\t\tselectedToolID: selectedTool.name,\r\n\t\thistoryNodesByID,\r\n\t\tundoHNIDs: undos.toJS().map(toID),\r\n\t\tredoHNIDs: redos.toJS().map(toID),\r\n\t\tcurrentHNID: toID(currentHistoryNode),\r\n\t};\r\n}\r\n\r\nexport function deserializeDocument(serialized, isFromFile, getToolByName) {\r\n\tconst nounPhraseThingToLoad = isFromFile ? \"document\" : \"document state\";\r\n\tif (serialized.format !== \"mopaint\") {\r\n\t\treturn [{\r\n\t\t\tmessage: `Can't load ${nounPhraseThingToLoad} - it does not appear to be a Mopaint document`,\r\n\t\t}];\r\n\t}\r\n\tif (\r\n\t\ttypeof serialized.formatVersion !== \"number\" ||\r\n\t\tserialized.formatVersion > CURRENT_SERIALIZATION_VERSION\r\n\t) {\r\n\t\treturn [{\r\n\t\t\tmessage: `Can't load ${nounPhraseThingToLoad} created by later version of the app`,\r\n\t\t}];\r\n\t}\r\n\tconst MINIMUM_LOADABLE_VERSION = 0.1;\r\n\r\n\t// Upgrade the document, incrementing the version number step by step.\r\n\t//\r\n\t// e.g.\r\n\t// if (serialized.formatVersion === 0.01) {\r\n\t// \tserialized.newPropertyName = serialized.oldName;\r\n\t// \tdelete serialized.oldName;\r\n\t// \tserialized.formatVersion = 0.02;\r\n\t// }\r\n\r\n\tif (serialized.formatVersion === 0.1) {\r\n\t\t// just skip over version 0.2, which was a dead end\r\n\t\tserialized.formatVersion = 0.3;\r\n\t}\r\n\tif (serialized.formatVersion === 0.3) {\r\n\t\tserialized.formatVersion = 0.4;\r\n\t\t// Convert to Non-Linear History\r\n\t\t// \r\n\t\t// linear undos/redos -> tree of nodes\r\n\t\t// operations -> nodes containing operations\r\n\t\t// last \"undo\" -> current history node\r\n\t\t// \r\n\t\t// necessary lies:\r\n\t\t// - time (previously not recorded)\r\n\t\t// - document structure (previously not recorded / already a lie)\r\n\t\t//\r\n\t\t// History nodes are to be serialized at this point as:\r\n\t\t// {parentHNID, childHNIDs, timestamp, operation, name, id}\r\n\r\n\t\tconst baseTimestamp = +new Date('January 1, 2020 00:00:00');\r\n\t\tconst rootHistoryNode = {\r\n\t\t\tname: \"New Document\",\r\n\t\t\tid: generateID(),\r\n\t\t\tchildHNIDs: [],\r\n\t\t\ttimestamp: baseTimestamp,\r\n\t\t};\r\n\r\n\t\tconst historyNodesByID = {};\r\n\t\thistoryNodesByID[rootHistoryNode.id] = rootHistoryNode;\r\n\r\n\t\tconst opToHN = new Map();\r\n\t\tconst makeFreeFloatingHN = (op)=> {\r\n\t\t\tconst id = generateID();\r\n\t\t\thistoryNodesByID[id] = {\r\n\t\t\t\tid,\r\n\t\t\t\toperation: op,\r\n\t\t\t\tname: op.toolID,\r\n\t\t\t\tparentHNID: undefined,\r\n\t\t\t\tchildHNIDs: [],\r\n\t\t\t\ttimestamp: baseTimestamp,\r\n\t\t\t};\r\n\t\t\topToHN.set(op, historyNodesByID[id]);\r\n\t\t};\r\n\t\tserialized.undos.forEach(makeFreeFloatingHN);\r\n\t\tserialized.redos.forEach(makeFreeFloatingHN);\r\n\r\n\t\tlet currentHNID;\r\n\t\tconst undoHNIDs = [];\r\n\t\tconst redoHNIDs = [];\r\n\t\tconst linkHNs = (parentHN, childHN)=> {\r\n\t\t\tif (parentHN) {\r\n\t\t\t\tparentHN.childHNIDs.push(childHN.id);\r\n\t\t\t\tchildHN.parentHNID = parentHN.id;\r\n\t\t\t}\r\n\t\t};\r\n\t\t\r\n\t\tconst orderedOps = [\r\n\t\t\t...serialized.undos,\r\n\t\t\t...[...serialized.redos].reverse(),\r\n\t\t];\r\n\t\tconst orderedHNs = [\r\n\t\t\trootHistoryNode,\r\n\t\t\t...orderedOps.map((op)=> opToHN.get(op)),\r\n\t\t];\r\n\t\torderedHNs.forEach((historyNode, index, orderedHNs)=> {\r\n\t\t\tconst previousHistoryNode = orderedHNs[index - 1];\r\n\t\t\tif (previousHistoryNode) {\r\n\t\t\t\tlinkHNs(previousHistoryNode, historyNode);\r\n\t\t\t}\r\n\t\t\t// TODO: update the history view's sort to work structurally when timestamps are equal\r\n\t\t\thistoryNode.timestamp += index;\r\n\t\t});\r\n\r\n\t\tundoHNIDs.push(rootHistoryNode.id);\r\n\t\torderedOps.forEach((op)=> {\r\n\t\t\tconst historyNode = opToHN.get(op);\r\n\t\t\tif (op === serialized.undos[serialized.undos.length - 1]) {\r\n\t\t\t\tcurrentHNID = historyNode.id;\r\n\t\t\t} else if (serialized.redos.indexOf(op) > -1) {\r\n\t\t\t\tredoHNIDs.push(historyNode.id);\r\n\t\t\t} else {\r\n\t\t\t\tundoHNIDs.push(historyNode.id);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tserialized.historyNodesByID = historyNodesByID;\r\n\t\tserialized.currentHNID = currentHNID;\r\n\t\tserialized.undoHNIDs = undoHNIDs;\r\n\t\tserialized.redoHNIDs = redoHNIDs;\r\n\r\n\t\tdelete serialized.undos;\r\n\t\tdelete serialized.redos;\r\n\t}\r\n\tif (serialized.formatVersion === 0.4) {\r\n\t\tserialized.formatVersion = 0.5;\r\n\t\t// The Fill tool previously used the first point of a gesture, acting on mousedown\r\n\t\t// The Fill tool now uses the last point of a gesture, like in Paint.NET\r\n\r\n\t\t// Normally I would prefer preserving points, and just add the first point to the end (if different),\r\n\t\t// but 1. the only real use case I see for that gesture data is for a future animation-from-history feature,\r\n\t\t// in which case I would have to write a heuristic to detect this upgrade to avoid a weird animation,\r\n\t\t// and 2. this isn't a popular app (I can worry about minutia like this later-on, when someone might care*),\r\n\t\t// and so I think it's better to just discard the points after the first point.\r\n\r\n\t\tfor (const historyNode of Object.values(serialized.historyNodesByID)) {\r\n\t\t\tif (historyNode.operation?.name === \"Fill\") {\r\n\t\t\t\tconst {points} = historyNode.operation;\r\n\t\t\t\t// const firstPos = points[0];\r\n\t\t\t\t// const lastPos = points[points.length - 1];\r\n\t\t\t\t// if (firstPos.x !== lastPos.x || firstPos.y !== lastPos.y) {\r\n\t\t\t\t// \tpoints.push(firstPos);\r\n\t\t\t\t// }\r\n\t\t\t\tpoints.length = 1;\r\n\t\t\t}\r\n\t\t}\r\n\t\t// *Someone might care about arbitrary tool's gesture data for changing a tool into another tool,\r\n\t\t// like Line to Free-Form Line just for fun or whatever (but Fill to Free-Form Line or whatever is a weird use-case)\r\n\t\t// Look, maybe someone wants to just plot everywhere the mouse was (that affected the document), okay? I dunno!\r\n\t\t// Look, sometimes preserving data is about supporting use cases you didn't even conceive of at the time.\r\n\t\t// But anyways, I'm probably the only person with old documents saved from this app, so format upgrades are\r\n\t\t// mainly an academic (and self-serving) endeavour at this point, and a good habit to maintain backwards compatibility.\r\n\r\n\t\t// In the future, a Fill operation might be composed of `Flood Fill(Last Point of Gesture(Gesture))` normally\r\n\t\t// and for an upgrade like this, older documents would just stay as `Flood Fill(First Point of Gesture(Gesture))`\r\n\t}\r\n\tif (serialized.formatVersion < CURRENT_SERIALIZATION_VERSION) {\r\n\t\tconst gitBranchName = `format-version-${serialized.formatVersion}`;\r\n\t\treturn [{\r\n\t\t\tmessage: <React.Fragment>\r\n\t\t\t\t<p>\r\n\t\t\t\t\tCan't load {nounPhraseThingToLoad} created by old version of the app; there's no upgrade path from format version {\r\n\t\t\t\t\t\tserialized.formatVersion\r\n\t\t\t\t\t} to {CURRENT_SERIALIZATION_VERSION}{\r\n\t\t\t\t\t\tMINIMUM_LOADABLE_VERSION !== CURRENT_SERIALIZATION_VERSION\r\n\t\t\t\t\t\t\t? ` (minimum loadable: ${MINIMUM_LOADABLE_VERSION})`\r\n\t\t\t\t\t\t\t: \"\"\r\n\t\t\t\t\t}\r\n\t\t\t\t</p>\r\n\t\t\t\t<p>\r\n\t\t\t\t\tTo load this {nounPhraseThingToLoad}, use the version of Mopaint at the Git branch&nbsp;\r\n\t\t\t\t\t<a href={`https://github.com/1j01/mopaint/tree/${gitBranchName}`} style={{fontFamily: \"monospace\"}}>{gitBranchName}</a>\r\n\t\t\t\t</p>\r\n\t\t\t</React.Fragment>\r\n\t\t}];\r\n\t}\r\n\r\n\tconst expectPropertiesToExist = (properties, object, locationMessage) => {\r\n\t\tproperties.forEach((key) => {\r\n\t\t\tif (!object[key]) {\r\n\t\t\t\tthrow new TypeError(`expected property '${key}' ${locationMessage}`);\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\tconst deserializeOperation = (serializedOperation) => {\r\n\t\texpectPropertiesToExist(\r\n\t\t\t[\"id\", \"toolID\", \"points\", \"swatch\"],\r\n\t\t\tserializedOperation,\r\n\t\t\t`on operation with ID ${serializedOperation.id}`,\r\n\t\t);\r\n\t\tconst tool = getToolByName(serializedOperation.toolID);\r\n\t\treturn {\r\n\t\t\tid: serializedOperation.id,\r\n\t\t\ttool: tool,\r\n\t\t\tpoints: serializedOperation.points,\r\n\t\t\tswatch: serializedOperation.swatch,\r\n\t\t};\r\n\t};\r\n\texpectPropertiesToExist(\r\n\t\t[\"palette\", \"selectedSwatch\", \"selectedToolID\", \"undoHNIDs\", \"redoHNIDs\", \"currentHNID\", \"historyNodesByID\"],\r\n\t\tserialized,\r\n\t\t\"on the root document object\",\r\n\t);\r\n\tconst historyNodesByID = {};\r\n\tfor (const [historyNodeID, historyNodeData] of Object.entries(serialized.historyNodesByID)) {\r\n\t\thistoryNodesByID[historyNodeID] = new HistoryNode(historyNodeData);\r\n\t\tif (historyNodeData.operation) {\r\n\t\t\thistoryNodesByID[historyNodeID].operation = deserializeOperation(historyNodeData.operation);\r\n\t\t}\r\n\t}\r\n\tconst fromHNID = (historyNodeID)=> historyNodesByID[historyNodeID];\r\n\tfor (const [historyNodeID, historyNodeData] of Object.entries(serialized.historyNodesByID)) {\r\n\t\thistoryNodesByID[historyNodeID].parentNode = historyNodesByID[historyNodeData.parentHNID];\r\n\t\thistoryNodesByID[historyNodeID].childNodes = historyNodeData.childHNIDs.map(fromHNID);\r\n\t}\r\n\treturn [null, {\r\n\t\tpalette: serialized.palette,\r\n\t\tselectedSwatch: serialized.selectedSwatch,\r\n\t\tselectedTool: getToolByName(serialized.selectedToolID),\r\n\t\tundos: new List(serialized.undoHNIDs.map(fromHNID)),\r\n\t\tredos: new List(serialized.redoHNIDs.map(fromHNID)),\r\n\t\tcurrentHistoryNode: fromHNID(serialized.currentHNID),\r\n\t}];\r\n}\r\n","const line = (ctx, x1, y1, x2, y2, swatch) => {\r\n\t// TODO: circle if coords are the same (i.e. no length to the line)?\r\n\t// (could approximate by shifting a coordinate minisculely)\r\n\tctx.beginPath();\r\n\tctx.moveTo(x1, y1);\r\n\tctx.lineTo(x2, y2);\r\n\tctx.strokeStyle = swatch;\r\n\tctx.lineWidth = 5;\r\n\tctx.lineCap = \"round\";\r\n\tctx.stroke();\r\n};\r\n\r\nexport default line;\r\n\r\nexport const tool = {\r\n\tname: \"Line\",\r\n\tdrawShape: line,\r\n};\r\n","const circle = (ctx, x1, y1, x2, y2, swatch) => {\r\n\tconst radius = Math.hypot(x2 - x1, y2 - y1);\r\n\tctx.beginPath();\r\n\tctx.arc(x1, y1, radius, 0, Math.PI * 2);\r\n\tctx.fillStyle = swatch;\r\n\tctx.fill();\r\n};\r\n\r\nexport default circle;\r\n\r\nexport const tool = {\r\n\tname: \"Circle\",\r\n\tdrawShape: circle,\r\n};\r\n","const rectangle = (ctx, x1, y1, x2, y2, swatch) => {\r\n\tctx.beginPath();\r\n\tctx.rect(x1, y1, x2 - x1, y2 - y1);\r\n\tctx.fillStyle = swatch;\r\n\tctx.fill();\r\n};\r\n\r\nexport default rectangle;\r\n","const getMirrorSymmetryPoints = (x, y, flipCenterX, flipCenterY) => {\r\n\t// const angle = 0;\r\n\t// TODO: let user choose symmetry line\r\n\r\n\tconst reflectPoint = (x, y) => ({\r\n\t\t// TODO: work with arbitrary angle\r\n\t\t// x: flipCenterX + Math.cos(angle) * (x - flipCenterX) + Math.sin(angle) * (y - flipCenterY),\r\n\t\t// y: flipCenterY + Math.sin(angle) * (x - flipCenterX) + Math.cos(angle) * (y - flipCenterY),\r\n\t\tx: flipCenterX * 2 - x,\r\n\t\ty: y,\r\n\t});\r\n\r\n\treturn [{ x, y }, reflectPoint(x, y)];\r\n};\r\n\r\nexport default getMirrorSymmetryPoints;\r\n","// TODO: let user choose center and number of repetitions and everything\r\n\r\n// Returns an array of {x, y} objects representing the symmetries of the given coordinates.\r\n// Based on https://www.nayuki.io/page/symmetry-sketcher-javascript\r\nconst getRotationalSymmetryPoints = (x, y, centerX, centerY) => {\r\n\tconst offsetAngle = 0; // Radians\r\n\tconst repetitions = 6;\r\n\r\n\t// up = 0 degrees, right = 90 deg, down = 180 deg, left = 270 deg\r\n\tconst relativeX = x - centerX;\r\n\tconst relativeY = centerY - y;\r\n\tconst distance = Math.hypot(relativeX, relativeY);\r\n\tconst angle = Math.atan2(relativeX, relativeY) + offsetAngle; // Radians\r\n\tconst result = [];\r\n\tfor (let i = 0; i < repetitions; i++) {\r\n\t\tlet theta = angle + ((Math.PI * 2) / repetitions) * i; // Radians\r\n\t\tx = centerX + Math.sin(theta) * distance;\r\n\t\ty = centerY - Math.cos(theta) * distance;\r\n\t\tresult.push({ x, y });\r\n\t\t// if (mirrorSymmetry) {\r\n\t\t// \tx = centerX - Math.sin(theta) * distance;\r\n\t\t// \tresult.push([x, y]);\r\n\t\t// }\r\n\t}\r\n\treturn result;\r\n};\r\n\r\nexport default getRotationalSymmetryPoints;\r\n","function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport React from \"react\";\n\nvar _ref2 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref3 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref4 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref5 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref6 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref7 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref8 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref9 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref10 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref11 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref12 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref13 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref14 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref15 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar _ref16 =\n/*#__PURE__*/\nReact.createElement(\"g\", null);\n\nvar SvgFlaticonsFillBucketFlipped = function SvgFlaticonsFillBucketFlipped(_ref) {\n  var svgRef = _ref.svgRef,\n      title = _ref.title,\n      props = _objectWithoutProperties(_ref, [\"svgRef\", \"title\"]);\n\n  return React.createElement(\"svg\", _extends({\n    id: \"Capa_1\",\n    x: \"0px\",\n    y: \"0px\",\n    viewBox: \"0 0 18.713 18.713\",\n    style: {\n      enableBackground: \"new 0 0 18.713 18.713\"\n    },\n    xmlSpace: \"preserve\",\n    ref: svgRef\n  }, props), title ? React.createElement(\"title\", null, title) : null, React.createElement(\"g\", {\n    transform: \"scale(-1,1) translate(-18.713,0)\"\n  }, React.createElement(\"path\", {\n    style: {\n      fill: \"#030104\"\n    },\n    d: \"M13.367,6.434L8.872,1.895l-0.65-0.672L6.687,2.731c-2.624-0.375-4.51,0.59-5.178,1.777 C0.698,5.949,1.527,7.522,1.553,7.57c0.693,1.385,1.689,2.216,2.961,2.473c0.279,0.055,0.56,0.08,0.84,0.08 c1.322,0,2.644-0.561,3.649-1.135c0.271,0.188,0.601,0.299,0.954,0.299c0.93,0,1.686-0.759,1.686-1.691s-0.756-1.69-1.686-1.69 s-1.686,0.758-1.686,1.69c0,0.093,0.013,0.184,0.027,0.274C7.286,8.445,5.951,8.986,4.77,8.748C3.905,8.573,3.237,7.995,2.719,6.96 C2.714,6.95,2.203,5.957,2.654,5.157c0.38-0.676,1.371-1.111,2.883-1.275L5.302,4.119L3.13,6.299 c0.023,0.053,0.04,0.085,0.041,0.087c0.209,0.418,0.444,0.758,0.706,1.03l3.932-3.943c0.187-0.187,0.435-0.29,0.698-0.29 s0.513,0.103,0.698,0.29l4.771,4.787c0.385,0.385,0.385,1.014,0,1.399L7.774,15.88c-0.372,0.373-1.023,0.373-1.396,0l-4.772-4.787 c-0.187-0.186-0.289-0.434-0.289-0.699c0-0.264,0.102-0.514,0.289-0.7l0.515-0.518C1.828,8.874,1.568,8.512,1.335,8.098 l-0.66,0.663C0.24,9.197,0,9.777,0,10.394c0,0.617,0.24,1.197,0.675,1.633l4.772,4.787c0.435,0.436,1.012,0.676,1.628,0.676 c0.614,0,1.193-0.24,1.628-0.676l6.201-6.221L16.205,9.3l-0.361-0.365c0.683-0.373,0.987,2.744,0.987,2.744s0.954,7.439,1.802,0 C19.443,4.56,13.854,6.272,13.367,6.434z\"\n  })), _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9, _ref10, _ref11, _ref12, _ref13, _ref14, _ref15, _ref16);\n};\n\nvar ForwardRef = React.forwardRef(function (props, ref) {\n  return React.createElement(SvgFlaticonsFillBucketFlipped, _extends({\n    svgRef: ref\n  }, props));\n});\nexport default __webpack_public_path__ + \"static/media/flaticons-fill-bucket-flipped.9c7684c7.svg\";\nexport { ForwardRef as ReactComponent };","import line from \"./line.js\";\r\nimport circle from \"./circle.js\";\r\nimport rectangle from \"./rectangle.js\";\r\nimport fill from \"./fill.js\";\r\nimport mirrorReflect from \"./mirror-symmetry.js\";\r\nimport rotationallyReflect from \"./rotational-symmetry.js\";\r\n// // import { ReactComponent as SymmetryIcon } from \"../icons/noun-symmetry.svg\";\r\n// // import { ReactComponent as CelticKnotIcon } from \"../icons/noun-celtic-knot.svg\";\r\nimport { ReactComponent as FillBucketIcon } from \"../icons/flaticons-fill-bucket-flipped.svg\";\r\n\r\n\r\nconst tools = {\r\n\t\"Freeform Line\": {\r\n\t\tdrawSegmentOfPath: line,\r\n\t},\r\n\t\"Line\": {\r\n\t\tdrawShape: line,\r\n\t},\r\n\t\"Freeform Circles\": {\r\n\t\tdrawSegmentOfPath: circle,\r\n\t},\r\n\t\"Circle\": {\r\n\t\tdrawShape: circle,\r\n\t},\r\n\t\"Rectangle\": {\r\n\t\tdrawShape: rectangle,\r\n\t},\r\n\t\"Fill\": {\r\n\t\tIcon: FillBucketIcon,\r\n\t\t// these UI function signatures are pretty arbitrary and would only get worse\r\n\t\t// as time goes on and I maintain backwards compatibility (even out of laziness!) and add things to the end\r\n\t\t// and it doesn't help that there's this layer of indirection where I have to map these signatures\r\n\t\tdrawFromPoint: function(opCtx, x, y, swatch, documentCtx) {\r\n\t\t\topCtx.drawImage(documentCtx.canvas, 0, 0);\r\n\t\t\tfill(opCtx, x, y, swatch);\r\n\t\t},\r\n\t},\r\n};\r\n\r\nObject.keys(tools).forEach((key) => {\r\n\tconst tool = tools[key];\r\n\r\n\tif (tool.drawSegmentOfPath) {\r\n\t\ttool.drawFromGesturePoints = (opContext, points, swatch)=> {\r\n\t\t\tfor (let i1 = 0, i2 = 1; i2 < points.length; i1 += 1, i2 += 1) {\r\n\t\t\t\ttool.drawSegmentOfPath(\r\n\t\t\t\t\topContext,\r\n\t\t\t\t\tpoints[i1].x,\r\n\t\t\t\t\tpoints[i1].y,\r\n\t\t\t\t\tpoints[i2].x,\r\n\t\t\t\t\tpoints[i2].y,\r\n\t\t\t\t\tswatch\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t};\r\n\t\ttool.getPreviewGesturePoints = (width, height)=> {\r\n\t\t\tconst points = [];\r\n\t\t\tfor (let i = 0; i < 20; i += 2) {\r\n\t\t\t\tpoints.push({\r\n\t\t\t\t\tx: width / 2 + 48 * Math.sin(Math.sin((i * i) / 302)),\r\n\t\t\t\t\ty: height / 2 + 48 * Math.cos(Math.sin(i / 5)),\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\treturn points;\r\n\t\t};\r\n\t}\r\n\tif (tool.drawShape) {\r\n\t\ttool.drawFromGesturePoints = (opContext, points, swatch)=> {\r\n\t\t\tconst startPos = points[0];\r\n\t\t\tconst lastPos = points[points.length - 1];\r\n\t\t\ttool.drawShape(\r\n\t\t\t\topContext,\r\n\t\t\t\tstartPos.x,\r\n\t\t\t\tstartPos.y,\r\n\t\t\t\tlastPos.x,\r\n\t\t\t\tlastPos.y,\r\n\t\t\t\tswatch\r\n\t\t\t);\r\n\t\t};\r\n\t\ttool.getPreviewGesturePoints = (width, height)=> {\r\n\t\t\treturn [\r\n\t\t\t\t{ x: width * 0.5, y: height * 0.5 },\r\n\t\t\t\t{ x: width * 0.8, y: height * 0.8 },\r\n\t\t\t];\r\n\t\t};\r\n\t}\r\n\tif (tool.drawFromPoint) {\r\n\t\ttool.drawFromGesturePoints = (opContext, points, swatch, documentContext)=> {\r\n\t\t\tconst lastPos = points[points.length - 1];\r\n\t\t\ttool.drawFromPoint(opContext, lastPos.x, lastPos.y, swatch, documentContext);\r\n\t\t};\r\n\t\ttool.getPreviewGesturePoints = (width, height)=> {\r\n\t\t\treturn { x: width / 2, y: height / 2 };\r\n\t\t};\r\n\t}\r\n});\r\n\r\n// TODO: allow the USER to compose tools (dynamically)\r\n// TODO: show preview of multiple points the user will interact with if they interact\r\nconst pointModifiers = [\r\n\t{\r\n\t\tprefix: \"Mirror Symmetric \",\r\n\t\t// name: \"Mirror Symmetry\",\r\n\t\t// name: \"Mirror Reflect\",\r\n\t\t// icon: SymmetryIcon,\r\n\t\tpointToPoints: mirrorReflect,\r\n\t},\r\n\t{\r\n\t\tprefix: \"Rotationally Symmetric \",\r\n\t\t// name: \"Rotational Symmetry\",\r\n\t\t// name: \"Point Reflect\",\r\n\t\t// icon: CelticKnotIcon,\r\n\t\tpointToPoints: rotationallyReflect,\r\n\t},\r\n];\r\npointModifiers.forEach((modifier) => {\r\n\tObject.keys(tools).forEach((key) => {\r\n\t\tconst originalTool = tools[key];\r\n\t\tconst newKey = modifier.prefix + key;\r\n\r\n\t\tif (originalTool.drawFromPoint) {\r\n\t\t\treturn; // skip Fill tool for now\r\n\t\t\t// TODO: either pass multiple starting points to the Fill tool at once,\r\n\t\t\t// or set it up so the document is updated between multiple calls to the Fill tool\r\n\t\t\t// (could do some sort of \"sub-operations\" thing for the latter, or something simpler)\r\n\t\t\t// (OR set it up to isolate the fill region on the opCanvas and then combine the fill regions from multiple calls,\r\n\t\t\t// but that would be inefficient, processing areas multiple times)\r\n\t\t\t// Other tools like the line tool could benefit from taking the geometry of multiple lines to draw all at once as an optimization,\r\n\t\t\t// so maybe there could be a way for tools to opt in to handling batching for optimization?\r\n\t\t}\r\n\t\tif (originalTool.drawFromGesturePoints) {\r\n\t\t\tconst newTool = (tools[newKey] = {});\r\n\t\t\tnewTool.drawFromGesturePoints = (opContext, gesturePoints, swatch, documentContext) => {\r\n\t\t\t\tconst pointses = []; // very silly name\r\n\t\t\t\tconst centerX = opContext.canvas.width / 2;\r\n\t\t\t\tconst centerY = opContext.canvas.height / 2;\r\n\t\t\t\tfor (const gesturePoint of gesturePoints) {\r\n\t\t\t\t\tconst symmetricPoints = modifier.pointToPoints(gesturePoint.x, gesturePoint.y, centerX, centerY);\r\n\t\t\t\t\tfor (let i = 0; i < symmetricPoints.length; i++) {\r\n\t\t\t\t\t\tpointses[i] = pointses[i] || [];\r\n\t\t\t\t\t\tpointses[i].push(symmetricPoints[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfor (const points of pointses) {\r\n\t\t\t\t\toriginalTool.drawFromGesturePoints(opContext, points, swatch, documentContext);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tnewTool.getPreviewGesturePoints = (width, height)=>\r\n\t\t\t\toriginalTool.getPreviewGesturePoints(width/2, height/2);\r\n\t\t}\r\n\t});\r\n});\r\n\r\nconst toolsArray = Object.keys(tools).map((key) => {\r\n\tconst tool = tools[key];\r\n\ttool.name = key;\r\n\treturn tool;\r\n});\r\n\r\nexport default toolsArray;\r\nexport const toolsByName = tools;\r\n","// TODO:\r\n// * Keep bounds and return them\r\n// (like this implementation does: https://github.com/hughsk/flood-fill)\r\n// so cached fill region data can be bounded by the affected region\r\n// (which could save memory, or save the time that a general bounding box finding algorithm would take - like trim-canvas.js),\r\n// * Separate the flood fill region (output) from the reference (input),\r\n// so the flood fill can be used to implement more types of operations,\r\n// like the \"Magic Wand\" tool, and custom things like \"Fill with Offset\"\r\n// (by adding a Move in between Flood Fill and Draw Fill Region, or whatever)\r\n// * Optimize flood based on chunks / make it handle chunks in order to do infinite documents etc.\r\n// Need to keep track of visited chunks, but could revisit a chunk from a different side.\r\n// Imagine the worst case of a flood fill algorithm input, but spread across chunks.\r\n// * Show progress bar and cancel button as necessary\r\n// (UI would be handled outside any flooding/filling implementations.)\r\n// * Support fill with bitmap (pattern as swatch).\r\n// * Tolerance threshold, and maybe some fancier blending (i.e. non-binary)...\r\n// * Also, I want to support workflows where you draw fills underneath other shapes/strokes,\r\n// and have the fills extend by at least the antialiasing distance.\r\n// (This is good for comics, from what I've seen.)\r\n\r\n// Other optimizations may include:\r\n// * Delegate to Web Workers or the GPU.\r\n// GPU.js looks interesting: https://github.com/gpujs/gpu.js\r\n// * Compile JavaScript to Web Assembly with a tool\r\n// * Get and set entire pixels at a time instead of individual RGBA components\r\n// https://hacks.mozilla.org/2011/12/faster-canvas-pixel-manipulation-with-typed-arrays/\r\n// * Study and implement ideas from an optimized flood fill algorithm,\r\n// or port one, either by hand or with Emscripten\r\n// QuickFill: https://www.codeproject.com/Articles/6017/QuickFill-An-efficient-flood-fill-algorithm\r\n// Queue-Linear: https://www.codeproject.com/Articles/16405/Queue-Linear-Flood-Fill-A-Fast-Flood-Fill-Algorith\r\n\r\nexport default function fill(ctx, x, y, swatch) {\r\n\tconst canvas = ctx.canvas;\r\n\r\n\tx = Math.floor(x);\r\n\ty = Math.floor(y);\r\n\r\n\tif (x < 0 || y < 0 || x > canvas.width || y > canvas.height) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst stack = [[x, y]];\r\n\tconst imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n\tlet pixelIndex = (y * canvas.width + x) * 4;\r\n\tconst startR = imageData.data[pixelIndex + 0];\r\n\tconst startG = imageData.data[pixelIndex + 1];\r\n\tconst startB = imageData.data[pixelIndex + 2];\r\n\tconst startA = imageData.data[pixelIndex + 3];\r\n\r\n\tconst onePixelCanvas = document.createElement(\"canvas\");\r\n\tconst onePixelCanvasCtx = onePixelCanvas.getContext(\"2d\");\r\n\tonePixelCanvasCtx.fillStyle = swatch;\r\n\tonePixelCanvasCtx.fillRect(0, 0, 1, 1);\r\n\tconst onePixelImageData = onePixelCanvasCtx.getImageData(0, 0, 1, 1);\r\n\tconst [fillR, fillG, fillB, fillA] = onePixelImageData.data;\r\n\r\n\t// console.log([startR, startG, startB, startA], [fillR, fillG, fillB, fillA]);\r\n\r\n\tif (\r\n\t\tfillR === startR &&\r\n\t\tfillG === startG &&\r\n\t\tfillB === startB &&\r\n\t\tfillA === startA\r\n\t) {\r\n\t\treturn;\r\n\t}\r\n\r\n\twhile (stack.length) {\r\n\t\tlet newPos, x, y, pixelIndex, reachLeft, reachRight;\r\n\t\tnewPos = stack.pop();\r\n\t\tx = newPos[0];\r\n\t\ty = newPos[1];\r\n\r\n\t\tpixelIndex = (y * canvas.width + x) * 4;\r\n\t\twhile (matchesStartColor(pixelIndex)) {\r\n\t\t\ty--;\r\n\t\t\tpixelIndex = (y * canvas.width + x) * 4;\r\n\t\t}\r\n\t\treachLeft = false;\r\n\t\treachRight = false;\r\n\t\twhile (true) {\r\n\t\t\ty++;\r\n\t\t\tpixelIndex = (y * canvas.width + x) * 4;\r\n\r\n\t\t\tif (!(y < canvas.height && matchesStartColor(pixelIndex))) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tcolorPixel(pixelIndex);\r\n\r\n\t\t\tif (x > 0) {\r\n\t\t\t\tif (matchesStartColor(pixelIndex - 4)) {\r\n\t\t\t\t\tif (!reachLeft) {\r\n\t\t\t\t\t\tstack.push([x - 1, y]);\r\n\t\t\t\t\t\treachLeft = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (reachLeft) {\r\n\t\t\t\t\treachLeft = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (x < canvas.width - 1) {\r\n\t\t\t\tif (matchesStartColor(pixelIndex + 4)) {\r\n\t\t\t\t\tif (!reachRight) {\r\n\t\t\t\t\t\tstack.push([x + 1, y]);\r\n\t\t\t\t\t\treachRight = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (reachRight) {\r\n\t\t\t\t\treachRight = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tpixelIndex += canvas.width * 4;\r\n\t\t}\r\n\t}\r\n\tctx.putImageData(imageData, 0, 0);\r\n\r\n\tfunction matchesStartColor(pixelIndex) {\r\n\t\treturn (\r\n\t\t\timageData.data[pixelIndex + 0] === startR &&\r\n\t\t\timageData.data[pixelIndex + 1] === startG &&\r\n\t\t\timageData.data[pixelIndex + 2] === startB &&\r\n\t\t\timageData.data[pixelIndex + 3] === startA\r\n\t\t);\r\n\t}\r\n\r\n\tfunction colorPixel(pixelIndex) {\r\n\t\timageData.data[pixelIndex + 0] = fillR;\r\n\t\timageData.data[pixelIndex + 1] = fillG;\r\n\t\timageData.data[pixelIndex + 2] = fillB;\r\n\t\timageData.data[pixelIndex + 3] = fillA;\r\n\t}\r\n};\r\n","import sha256 from \"hash.js/lib/hash/sha/256\";\r\n\r\nconst opCanvas = document.createElement(\"canvas\");\r\nconst opContext = opCanvas.getContext(\"2d\");\r\n\r\nexport const draw = ({documentCanvas, operations, thumbnailsByOperation, cache, hashInDocumentByOperation})=> {\r\n\tconst documentContext = documentCanvas.getContext(\"2d\");\r\n\r\n\tdocumentContext.clearRect(0, 0, opCanvas.width, opCanvas.height);\r\n\r\n\topCanvas.width = documentCanvas.width;\r\n\topCanvas.height = documentCanvas.height;\r\n\r\n\tconst runningHash = sha256();\r\n\toperations.forEach((operation, operationIndex) => {\r\n\t\trunningHash.update(JSON.stringify(operation));\r\n\t\tconst operationHash = runningHash.digest(\"hex\");\r\n\t\topContext.clearRect(0, 0, opCanvas.width, opCanvas.height);\r\n\t\tif (cache[operationHash]) {\r\n\t\t\t// console.log(\"cache hit\");\r\n\t\t\tdocumentContext.drawImage(cache[operationHash], 0, 0);\r\n\t\t} else {\r\n\t\t\t// opContext.clearRect(0, 0, opCanvas.width, opCanvas.height);\r\n\t\t\t// console.log(\"cache miss\");\r\n\t\t\tconst { points, tool, swatch } = operation;\r\n\r\n\t\t\ttool.drawFromGesturePoints(opContext, points, swatch, documentContext);\r\n\r\n\t\t\tdocumentContext.drawImage(opCanvas, 0, 0);\r\n\r\n\t\t\thashInDocumentByOperation.set(operation, operationHash);\r\n\r\n\t\t\t// fill the cache\r\n\t\t\tif (!operation.updatingContinously) {\r\n\t\t\t\tcache[operationHash] = document.createElement(\"canvas\");\r\n\t\t\t\tcache[operationHash].width = opCanvas.width;\r\n\t\t\t\tcache[operationHash].height = opCanvas.height;\r\n\t\t\t\tcache[operationHash].getContext(\"2d\").drawImage(opCanvas, 0, 0);\r\n\t\t\t}\r\n\r\n\t\t\t// TODO: optimize: use existing canvas if it exists (clear and update it)\r\n\t\t\tconst thumbnail = document.createElement(\"canvas\");\r\n\t\t\tthumbnail.width = 64;\r\n\t\t\tthumbnail.height = 64;\r\n\t\t\t// TODO: keep thumbnail proportional\r\n\t\t\t// can reuse code in ToolPreview.js\r\n\t\t\tthumbnail.getContext(\"2d\").drawImage(opCanvas, 0, 0, 64, 64);\r\n\t\t\tthumbnailsByOperation.set(operation, thumbnail);\r\n\r\n\t\t\t// TODO: cache invalidation\r\n\t\t\t// // console.log(\"invalidate\", operations, operationIndex + 1);\r\n\t\t\t// operations.slice(operationIndex + 1).forEach((operation)=> {\r\n\t\t\t// \t// TODO: unless self-contained\r\n\t\t\t// \t// console.log(thumbnailsByOperation.has(operation), thumbnailsByOperation);\r\n\t\t\t// \tthumbnailsByOperation.delete(operation);\r\n\t\t\t// \tdelete cache[hashInDocumentByOperation.get(operation)];\r\n\t\t\t// });\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/*\r\nexport function render(mopaintDocument, canvas, inputs) {\r\n\tconst ctx = canvas.getContext(\"2d\");\r\n\r\n\tctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n\tconst runningHash = sha256();\r\n\tmopaintDocument.operations.forEach((operation, operationIndex) => {\r\n\t\trunningHash.update(JSON.stringify(operation));\r\n\t\tconst operationHash = runningHash.digest(\"hex\");\r\n\r\n\t\toperation.exec(ctx);\r\n\t\t\r\n\t\tthis.hashInDocumentByOperation.set(operation, operationHash);\r\n\t});\r\n\r\n\tctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\tctx.drawImage(documentCanvas, 0, 0);\r\n}\r\n\r\nexport function overlayOnPage(mopaintDocument, elements) {\r\n\tconst canvas = document.createElement(\"canvas\");\r\n\r\n\tconst makeFrameInputs = ()=> {\r\n\t\tconst rects = {};\r\n\t\tfor (let id, element of elements) {\r\n\t\t\tconst {left, top, right, bottom} = element.getBoundingClientRect();\r\n\t\t\tconst x = left, y = top, width = right - left, height = bottom - top;\r\n\t\t\trects[id] = {x, y, width, height};\r\n\t\t}\r\n\t\tconst pageWidth = innerWidth, pageHeight = innerHeight;\r\n\t\tconst inputs = {rects, pageWidth, pageHeight};\r\n\t\treturn inputs;\r\n\t};\r\n\r\n\tcanvas.style.pointerEvents = \"none\";\r\n\tcanvas.style.position = \"fixed\";\r\n\tcanvas.style.left = \"0\";\r\n\tcanvas.style.top = \"0\";\r\n\tdocument.body.appendChild(canvas);\r\n\t\r\n\tconst animate = ()=> {\r\n\t\tconst inputs = makeFrameInputs();\r\n\r\n\t\tcanvas.width = inputs.pageWidth;\r\n\t\tcanvas.height = inputs.pageHeight;\r\n\r\n\t\trender(mopaintDocument, canvas, inputs);\r\n\r\n\t\trequestAnimationFrame(animate);\r\n\t};\r\n\trequestAnimationFrame(animate);\r\n}\r\n*/\r\n","// TODO: evaluate other hashing libraries\r\n// https://brillout.github.io/test-javascript-hash-implementations/\r\nimport React, { Component } from \"react\";\r\nimport PropTypes from \"prop-types\";\r\nimport \"./DrawingCanvas.css\";\r\nimport {draw} from \"../engine.js\";\r\nimport {generateID} from \"../helpers.js\";\r\n\r\nclass DrawingCanvas extends Component {\r\n\tconstructor(props) {\r\n\t\tsuper(props);\r\n\r\n\t\tthis.operation = null;\r\n\r\n\t\tthis.canvasRef = React.createRef();\r\n\r\n\t\tthis.cache = {};\r\n\t\t// hashes of operations up to and including the given operation in the document\r\n\t\tthis.hashInDocumentByOperation = new Map();\r\n\t}\r\n\trender() {\r\n\t\tif (this.animationFrameID) {\r\n\t\t\tcancelAnimationFrame(this.animationFrameID);\r\n\t\t}\r\n\t\tthis.animationFrameID = requestAnimationFrame(()=> {\r\n\t\t\tdraw({\r\n\t\t\t\tdocumentCanvas: this.canvasRef.current,\r\n\t\t\t\toperations: this.props.operations,\r\n\t\t\t\tthumbnailsByOperation: this.props.thumbnailsByOperation,\r\n\t\t\t\tcache: this.cache,\r\n\t\t\t\thashInDocumentByOperation: this.hashInDocumentByOperation,\r\n\t\t\t});\r\n\t\t});\r\n\t\tconst width = 640;\r\n\t\tconst height = 480;\r\n\t\treturn (\r\n\t\t\t<div className=\"DrawingCanvas\" style={{ width, height }}>\r\n\t\t\t\t<canvas width={width} height={height} ref={this.canvasRef} />\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n\ttoCanvasCoords(event) {\r\n\t\tconst canvas = this.canvasRef.current;\r\n\t\tconst rect = canvas.getBoundingClientRect();\r\n\t\treturn {\r\n\t\t\tx: event.clientX - rect.left,\r\n\t\t\ty: event.clientY - rect.top,\r\n\t\t};\r\n\t}\r\n\t// TODO: touch support\r\n\tonMouseMoveWhileDown(event) {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst pos = this.toCanvasCoords(event);\r\n\t\tif (!this.operation) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.operation.points.push(pos);\r\n\r\n\t\tconst { updateOperation } = this.props;\r\n\t\tupdateOperation(this.operation);\r\n\t}\r\n\tonMouseDown(event) {\r\n\t\tif (event.which !== 1) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tevent.preventDefault();\r\n\t\tconst { selectedSwatch, selectedTool } = this.props;\r\n\t\tif (!selectedTool) {\r\n\t\t\tconsole.warn(\"no tool selected\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst pos = this.toCanvasCoords(event);\r\n\t\tthis.operation = {\r\n\t\t\tid: generateID(10),\r\n\t\t\tpoints: [pos],\r\n\t\t\ttool: selectedTool,\r\n\t\t\tswatch: selectedSwatch,\r\n\t\t\tupdatingContinously: true, // TODO: this should probably be extrinsic!\r\n\t\t};\r\n\t\tconst { addOperation } = this.props;\r\n\t\taddOperation(this.operation);\r\n\t\tif (event.target.setCapture) {\r\n\t\t\tevent.target.setCapture();\r\n\t\t} else {\r\n\t\t\tdocument.body.classList.add(\"cursor-override-DrawingCanvas\");\r\n\t\t}\r\n\t}\r\n\tonMouseUp(event) {\r\n\t\t// TODO: add pos if different? (is that possible? and does this matter?)\r\n\t\t// const pos = this.toCanvasCoords(event);\r\n\t\t// this.operation.points.push(pos);\r\n\r\n\t\tconst { updateOperation } = this.props;\r\n\t\tif (!this.operation) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tdelete this.operation.updatingContinously; // bit of a hack so let's uh clean it up / make it less present in the document store... (as opposed to setting it to false)\r\n\t\tupdateOperation(this.operation);\r\n\r\n\t\tdocument.body.classList.remove(\"cursor-override-DrawingCanvas\");\r\n\t}\r\n\tcomponentDidMount() {\r\n\t\tconst canvas = this.canvasRef.current;\r\n\t\tlet mouseIsDown = false;\r\n\t\tcanvas.addEventListener(\r\n\t\t\t\"mousedown\",\r\n\t\t\t(this.mouseDownListener = (event) => {\r\n\t\t\t\tif (mouseIsDown) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (event.button !== 0) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tmouseIsDown = true;\r\n\t\t\t\tthis.onMouseDown(event);\r\n\t\t\t\twindow.addEventListener(\r\n\t\t\t\t\t\"mousemove\",\r\n\t\t\t\t\t(this.mouseMoveListener = (event) => {\r\n\t\t\t\t\t\tthis.onMouseMoveWhileDown(event);\r\n\t\t\t\t\t})\r\n\t\t\t\t);\r\n\t\t\t\twindow.addEventListener(\r\n\t\t\t\t\t\"mouseup\",\r\n\t\t\t\t\t(this.mouseUpListener = (event) => {\r\n\t\t\t\t\t\twindow.removeEventListener(\"mousemove\", this.mouseMoveListener);\r\n\t\t\t\t\t\twindow.removeEventListener(\"mouseup\", this.mouseUpListener);\r\n\t\t\t\t\t\tmouseIsDown = false;\r\n\t\t\t\t\t\tthis.onMouseUp(event);\r\n\t\t\t\t\t})\r\n\t\t\t\t);\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\tcomponentWillUnmount() {\r\n\t\tconst canvas = this.canvasRef.current;\r\n\t\tcanvas.removeEventListener(\"mousedown\", this.mouseDownListener);\r\n\t\twindow.removeEventListener(\"mousemove\", this.mouseMoveListener);\r\n\t\twindow.removeEventListener(\"mouseup\", this.mouseUpListener);\r\n\t\tcancelAnimationFrame(this.animationFrameID);\r\n\t}\r\n}\r\n\r\nDrawingCanvas.propTypes = {\r\n\tselectedTool: PropTypes.object,\r\n\tselectedSwatch: PropTypes.oneOfType([\r\n\t\tPropTypes.string,\r\n\t\tPropTypes.instanceOf(CanvasGradient),\r\n\t\tPropTypes.instanceOf(CanvasPattern),\r\n\t]).isRequired,\r\n};\r\n\r\nexport default DrawingCanvas;\r\n","// Based on https://gist.github.com/timdown/021d9c8f2aabc7092df564996f5afbbf\r\n\r\nconst trimCanvas = (() => {\r\n\tfunction rowBlank(imageData, width, y) {\r\n\t\tfor (let x = 0; x < width; ++x) {\r\n\t\t\tif (imageData.data[y * width * 4 + x * 4 + 3] !== 0) return false;\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\r\n\tfunction columnBlank(imageData, width, x, top, bottom) {\r\n\t\tfor (let y = top; y < bottom; ++y) {\r\n\t\t\tif (imageData.data[y * width * 4 + x * 4 + 3] !== 0) return false;\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn (canvas) => {\r\n\t\tconst ctx = canvas.getContext(\"2d\");\r\n\t\tconst width = canvas.width;\r\n\t\tconst imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n\t\tlet top = 0,\r\n\t\t\tbottom = imageData.height,\r\n\t\t\tleft = 0,\r\n\t\t\tright = imageData.width;\r\n\r\n\t\twhile (top < bottom && rowBlank(imageData, width, top)) ++top;\r\n\t\twhile (bottom - 1 > top && rowBlank(imageData, width, bottom - 1)) --bottom;\r\n\t\twhile (left < right && columnBlank(imageData, width, left, top, bottom))\r\n\t\t\t++left;\r\n\t\twhile (\r\n\t\t\tright - 1 > left &&\r\n\t\t\tcolumnBlank(imageData, width, right - 1, top, bottom)\r\n\t\t)\r\n\t\t\t--right;\r\n\r\n\t\tconst trimmed = ctx.getImageData(\r\n\t\t\tleft,\r\n\t\t\ttop,\r\n\t\t\tright - left || 1,\r\n\t\t\tbottom - top || 1\r\n\t\t);\r\n\t\tconst copy = canvas.ownerDocument.createElement(\"canvas\");\r\n\t\tconst copyCtx = copy.getContext(\"2d\");\r\n\t\tcopy.width = trimmed.width;\r\n\t\tcopy.height = trimmed.height;\r\n\t\tcopyCtx.putImageData(trimmed, 0, 0);\r\n\r\n\t\treturn copy;\r\n\t};\r\n})();\r\n\r\nexport default trimCanvas;\r\n","import React, { Component } from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport PropTypes from \"prop-types\";\r\nimport trimCanvas from \"../trim-canvas.js\";\r\n// import './ToolPreview.css';\r\n\r\nclass ToolPreview extends Component {\r\n\trender() {\r\n\t\tconst { width, height, tool } = this.props;\r\n\t\tif (tool.Icon) {\r\n\t\t\treturn (\r\n\t\t\t\t<tool.Icon className=\"ToolPreview\" width={width} height={height} />\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn (\r\n\t\t\t\t<canvas\r\n\t\t\t\t\tclassName=\"ToolPreview\"\r\n\t\t\t\t\twidth={width}\r\n\t\t\t\t\theight={height}\r\n\t\t\t\t\tref=\"canvas\"\r\n\t\t\t\t/>\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\tcomponentDidMount() {\r\n\t\tconst canvas = ReactDOM.findDOMNode(this.refs.canvas);\r\n\t\tif (!canvas) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst ctx = canvas.getContext(\"2d\");\r\n\r\n\t\tconst opCanvas = document.createElement(\"canvas\");\r\n\t\topCanvas.width = 128;\r\n\t\topCanvas.height = 128;\r\n\t\tconst opContext = opCanvas.getContext(\"2d\");\r\n\r\n\t\tconst { tool } = this.props;\r\n\r\n\t\tconst swatch = \"black\";\r\n\r\n\t\tconst points = tool.getPreviewGesturePoints(opCanvas.width, opCanvas.height);\r\n\r\n\t\ttool.drawFromGesturePoints(opContext, points, swatch);\r\n\r\n\t\tconst trimmedCanvas = trimCanvas(opCanvas);\r\n\r\n\t\tlet drawWidth, drawHeight;\r\n\t\t// TODO: maybe handle height not equaling width for props to ToolPreview\r\n\t\tif (trimmedCanvas.width > trimmedCanvas.height) {\r\n\t\t\tdrawWidth = canvas.width;\r\n\t\t\tdrawHeight = (trimmedCanvas.height / trimmedCanvas.width) * canvas.width;\r\n\t\t} else {\r\n\t\t\tdrawWidth = (trimmedCanvas.width / trimmedCanvas.height) * canvas.width;\r\n\t\t\tdrawHeight = canvas.width;\r\n\t\t}\r\n\t\tctx.drawImage(\r\n\t\t\ttrimmedCanvas,\r\n\t\t\t(canvas.width - drawWidth) / 2,\r\n\t\t\t(canvas.height - drawHeight) / 2,\r\n\t\t\tdrawWidth,\r\n\t\t\tdrawHeight\r\n\t\t);\r\n\t}\r\n}\r\n\r\nToolPreview.propTypes = {\r\n\ttool: PropTypes.object.isRequired,\r\n\twidth: PropTypes.number.isRequired,\r\n\theight: PropTypes.number.isRequired,\r\n};\r\n\r\nexport default ToolPreview;\r\n","import React, { Component } from \"react\";\r\nimport PropTypes from \"prop-types\";\r\nimport ToolPreview from \"./ToolPreview.js\";\r\nimport \"./Toolbox.css\";\r\n\r\nclass Toolbox extends Component {\r\n\trender() {\r\n\t\tvar { tools, selectedTool, selectTool } = this.props;\r\n\t\ttools = tools || []; // TODO: loading state\r\n\t\treturn (\r\n\t\t\t<div className=\"Toolbox\" role=\"radiogroup\">\r\n\t\t\t\t{tools.map((tool) => {\r\n\t\t\t\t\tconst selected = selectedTool === tool;\r\n\t\t\t\t\treturn (\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tkey={tool.name}\r\n\t\t\t\t\t\t\tclassName=\"Toolbox-tool\"\r\n\t\t\t\t\t\t\t// TODO: disabled when selected?\r\n\t\t\t\t\t\t\trole=\"radio\"\r\n\t\t\t\t\t\t\taria-checked={selected ? \"aria-checked\" : null}\r\n\t\t\t\t\t\t\tonClick={() => {\r\n\t\t\t\t\t\t\t\tselectTool(tool);\r\n\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\ttitle={tool.name}\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<ToolPreview tool={tool} width={48} height={48} />\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t);\r\n\t\t\t\t})}\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n}\r\n\r\nToolbox.propTypes = {\r\n\ttools: PropTypes.array,\r\n\tselectedTool: PropTypes.object,\r\n\tselectTool: PropTypes.func.isRequired,\r\n};\r\n\r\nexport default Toolbox;\r\n","import React, { Component } from \"react\";\r\nimport PropTypes from \"prop-types\";\r\nimport \"./Palette.css\";\r\n\r\n// TODO: DRY Toolbox + Palette\r\nclass Palette extends Component {\r\n\trender() {\r\n\t\tconst { palette, selectedSwatch, selectSwatch } = this.props;\r\n\t\treturn (\r\n\t\t\t<div className=\"Palette\" role=\"radiogroup\">\r\n\t\t\t\t{palette.map((swatch) => {\r\n\t\t\t\t\tconst selected = selectedSwatch === swatch;\r\n\t\t\t\t\treturn (\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tkey={swatch}\r\n\t\t\t\t\t\t\tclassName=\"Palette-swatch swatch\"\r\n\t\t\t\t\t\t\tstyle={{ backgroundColor: swatch }}\r\n\t\t\t\t\t\t\trole=\"radio\"\r\n\t\t\t\t\t\t\taria-checked={selected ? \"aria-checked\" : null}\r\n\t\t\t\t\t\t\tonClick={() => {\r\n\t\t\t\t\t\t\t\tselectSwatch(swatch);\r\n\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t);\r\n\t\t\t\t})}\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n}\r\n\r\nPalette.propTypes = {\r\n\tpalette: PropTypes.array.isRequired,\r\n\tselectedSwatch: PropTypes.oneOfType([\r\n\t\tPropTypes.instanceOf(CanvasPattern),\r\n\t\tPropTypes.instanceOf(CanvasGradient),\r\n\t\tPropTypes.string,\r\n\t]).isRequired,\r\n\tselectSwatch: PropTypes.func.isRequired,\r\n};\r\n\r\nexport default Palette;\r\n","import React, { Component } from \"react\";\r\nimport PropTypes from \"prop-types\";\r\nimport Palette from \"./Palette.js\";\r\nimport \"./Colorbox.css\";\r\n\r\nclass Colorbox extends Component {\r\n\trender() {\r\n\t\tconst { palette, selectedSwatch, selectSwatch } = this.props;\r\n\t\treturn (\r\n\t\t\t<div className=\"Colorbox\">\r\n\t\t\t\t<div className=\"Colorbox-selected-swatches\">\r\n\t\t\t\t\t<div\r\n\t\t\t\t\t\tclassName=\"Colorbox-selected-swatch swatch\"\r\n\t\t\t\t\t\tkey={selectedSwatch}\r\n\t\t\t\t\t\tstyle={{ backgroundColor: selectedSwatch }}\r\n\t\t\t\t\t/>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div className=\"Colorbox-divider\" />\r\n\t\t\t\t<Palette\r\n\t\t\t\t\tpalette={palette}\r\n\t\t\t\t\tselectedSwatch={selectedSwatch}\r\n\t\t\t\t\tselectSwatch={selectSwatch}\r\n\t\t\t\t/>\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n}\r\n\r\nColorbox.propTypes = {\r\n\tpalette: PropTypes.array.isRequired,\r\n\tselectedSwatch: PropTypes.oneOfType([\r\n\t\tPropTypes.instanceOf(CanvasPattern),\r\n\t\tPropTypes.instanceOf(CanvasGradient),\r\n\t\tPropTypes.string,\r\n\t]).isRequired,\r\n\tselectSwatch: PropTypes.func.isRequired,\r\n};\r\n\r\nexport default Colorbox;\r\n","import React, { Component } from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport PropTypes from \"prop-types\";\r\nimport ToolPreview from \"./ToolPreview.js\";\r\nimport \"./HistoryEntry.css\";\r\nimport HistoryNode from \"../HistoryNode.js\";\r\n\r\n// const modulo = (a, b) => (+a % (b = +b) + b) % b;\r\n\r\nfunction isScrolledIntoView(el) {\r\n\t// Partially visible elements return true.\r\n\t// Assumption: scroll pane is near window height (and scrolls vertically)\r\n\tconst rect = el.getBoundingClientRect();\r\n\treturn rect.top < window.innerHeight && rect.bottom >= 0;\r\n}\r\n\r\nclass Thumbnail extends Component {\r\n\trender() {\r\n\t\tconst { width, height } = this.props;\r\n\t\tthis.props.drawFunctionsArrayToAddTo.push(() => this.draw());\r\n\t\tthis.maybeLoadingTime = 0;\r\n\t\treturn <canvas width={width} height={height} />;\r\n\t}\r\n\tdraw() {\r\n\t\tconst { indexInListForAnimationOffset, getImageMaybe } = this.props;\r\n\t\tconst canvas = ReactDOM.findDOMNode(this);\r\n\r\n\t\tif(!isScrolledIntoView(canvas)){\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst ctx = canvas.getContext(\"2d\");\r\n\t\tctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n\t\t// TODO: clean up how this works!\r\n\t\t// this getImageMaybe thing is a hack to update the image outside of React's render model,\r\n\t\t// since we already have an animation loop\r\n\t\tconst image = getImageMaybe();\r\n\t\tif (image) {\r\n\t\t\tctx.drawImage(image, 0, 0, canvas.width, canvas.height);\r\n\t\t} else {\r\n\t\t\t// ctx.fillRect(Math.random()*canvas.width / 2, Math.random()*canvas.height / 2, 10, 10);\r\n\t\t\t/*\r\n\t\t\tctx.beginPath();\r\n\t\t\tconst baseRotationTurns =\r\n\t\t\t\tMath.sin(\r\n\t\t\t\t\tperformance.now() / 1000 +\r\n\t\t\t\t\tindexInListForAnimationOffset * 0.03\r\n\t\t\t\t\t// 0\r\n\t\t\t\t) * 5 / Math.pow(1.001, this.maybeLoadingTime++);\r\n\t\t\tconst baseRotationRadians = modulo(baseRotationTurns * Math.PI * 2, Math.PI * 2);\r\n\t\t\tctx.arc(\r\n\t\t\t\tcanvas.width / 2,\r\n\t\t\t\tcanvas.height / 2,\r\n\t\t\t\tMath.min(canvas.width, canvas.height) / 2 * 0.9,\r\n\t\t\t\tbaseRotationRadians,\r\n\t\t\t\tbaseRotationRadians + Math.PI / 2,\r\n\t\t\t\tfalse\r\n\t\t\t);\r\n\t\t\tctx.lineWidth = 2;\r\n\t\t\tctx.strokeStyle = \"rgba(128, 128, 128, 0.8)\";\r\n\t\t\tctx.stroke();\r\n\t\t\t*/\r\n\t\t\t// ctx.save();\r\n\t\t\tfor (let i = 0; i < 4; i += 1) {\r\n\t\t\t\tlet radius =\r\n\t\t\t\t\t// (Math.min(canvas.width, canvas.height) / 2 - 5) *\r\n\t\t\t\t\t((Math.min(canvas.width, canvas.height) / 2) *\r\n\t\t\t\t\t\t(2 +\r\n\t\t\t\t\t\t\tMath.sin(\r\n\t\t\t\t\t\t\t\t(i * Math.PI) / 2 +\r\n\t\t\t\t\t\t\t\t\tperformance.now() / 1000 -\r\n\t\t\t\t\t\t\t\t\tindexInListForAnimationOffset * 0.03\r\n\t\t\t\t\t\t\t))) /\r\n\t\t\t\t\t3;\r\n\t\t\t\t// ctx.lineWidth = 5 *\r\n\t\t\t\t// \t(1 + Math.sin(Math.PI/2 +\r\n\t\t\t\t// \t\ti * Math.PI/2 +\r\n\t\t\t\t// \t\tperformance.now() / 1000 +\r\n\t\t\t\t// \t\tindexInListForAnimationOffset * 0.03\r\n\t\t\t\t// \t)) / 2;\r\n\t\t\t\t// radius += ctx.lineWidth / 2;\r\n\t\t\t\t// ctx.lineWidth = radius / 2;\r\n\t\t\t\t// radius += ctx.lineWidth / 2;\r\n\r\n\t\t\t\t// ctx.strokeStyle = \"rgba(128, 128, 128, 0.8)\";\r\n\t\t\t\t// ctx.fillStyle = \"rgba(128, 128, 128, 0.8)\";\r\n\t\t\t\tctx.fillStyle = `rgba(128, 128, 128, ${0.8 *\r\n\t\t\t\t\tMath.max(\r\n\t\t\t\t\t\t0,\r\n\t\t\t\t\t\tMath.sin(\r\n\t\t\t\t\t\t\tMath.PI / 2 +\r\n\t\t\t\t\t\t\t\t(i * Math.PI) / 2 +\r\n\t\t\t\t\t\t\t\tperformance.now() / 1000 -\r\n\t\t\t\t\t\t\t\tindexInListForAnimationOffset * 0.03\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t)})`;\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tctx.arc(\r\n\t\t\t\t\tcanvas.width / 2,\r\n\t\t\t\t\tcanvas.height / 2,\r\n\t\t\t\t\tradius,\r\n\t\t\t\t\t0,\r\n\t\t\t\t\tMath.PI * 2,\r\n\t\t\t\t\tfalse\r\n\t\t\t\t);\r\n\t\t\t\t// ctx.stroke();\r\n\t\t\t\tctx.fill();\r\n\t\t\t}\r\n\t\t\t// ctx.restore();\r\n\t\t\tctx.fillStyle = \"white\";\r\n\t\t\tctx.textBaseline = \"middle\";\r\n\t\t\tctx.textAlign = \"center\";\r\n\t\t\tctx.font = `${(Math.min(canvas.width, canvas.height) / 2) *\r\n\t\t\t\t0.9}px sans-serif`;\r\n\t\t\tctx.fillText(\"?\", canvas.width / 2, canvas.height / 2);\r\n\t\t}\r\n\t}\r\n\tcomponentDidMount() {\r\n\t\tthis.draw();\r\n\t}\r\n\tcomponentDidUpdate() {\r\n\t\tthis.draw();\r\n\t}\r\n\t// (TODO)\r\n\t// shouldComponentUpdate(newProps) {\r\n\t// \treturn newProps.image !== this.props.image;\r\n\t// }\r\n}\r\n\r\nThumbnail.propTypes = {\r\n\twidth: PropTypes.number.isRequired,\r\n\theight: PropTypes.number.isRequired,\r\n\tindexInListForAnimationOffset: PropTypes.number.isRequired,\r\n\tgetImageMaybe: PropTypes.func.isRequired,\r\n};\r\n\r\nclass HistoryEntry extends Component {\r\n\trender() {\r\n\t\tconst {\r\n\t\t\tcurrent,\r\n\t\t\tancestorOfCurrent,\r\n\t\t\tonClick,\r\n\t\t\thistoryNode,\r\n\t\t\tindexInListForAnimationOffset,\r\n\t\t\tdrawFunctionsArrayToAddTo,\r\n\t\t\tgetThumbnailImageMaybe,\r\n\t\t\tgetIconReactElementMaybe,\r\n\t\t} = this.props;\r\n\t\tconst {operation} = historyNode;\r\n\t\t// NOTE: role works together with role in HistoryView\r\n\t\treturn (\r\n\t\t\t<button\r\n\t\t\t\tclassName={\r\n\t\t\t\t\t\"HistoryEntry\" +\r\n\t\t\t\t\t(current ? \" current\" : \"\") +\r\n\t\t\t\t\t(ancestorOfCurrent ? \" ancestor-of-current\" : \"\")\r\n\t\t\t\t}\r\n\t\t\t\trole=\"radio\"\r\n\t\t\t\taria-checked={current ? \"aria-checked\" : null}\r\n\t\t\t\tonClick={onClick} // for keyboard accessibility (?)\r\n\t\t\t\tonMouseDown={onClick} // for speed (w/ a mouse)\r\n\t\t\t>\r\n\t\t\t\t<Thumbnail\r\n\t\t\t\t\twidth={24}\r\n\t\t\t\t\theight={24}\r\n\t\t\t\t\tindexInListForAnimationOffset={indexInListForAnimationOffset}\r\n\t\t\t\t\tdrawFunctionsArrayToAddTo={drawFunctionsArrayToAddTo}\r\n\t\t\t\t\tgetImageMaybe={getThumbnailImageMaybe}\r\n\t\t\t\t/>\r\n\t\t\t\t{getIconReactElementMaybe?.() ?? (operation && <ToolPreview tool={operation.tool} width={16} height={16} />)}\r\n\t\t\t\t{historyNode.name}\r\n\t\t\t</button>\r\n\t\t);\r\n\t}\r\n}\r\n\r\nHistoryEntry.propTypes = {\r\n\thistoryNode: PropTypes.instanceOf(HistoryNode).isRequired,\r\n\tcurrent: PropTypes.bool.isRequired,\r\n\tancestorOfCurrent: PropTypes.bool.isRequired,\r\n\tonClick: PropTypes.func.isRequired,\r\n};\r\n\r\nexport default HistoryEntry;\r\n","function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport React from \"react\";\n\nvar _ref2 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  fill: \"#95a5a6\",\n  d: \"M5 0c-.982 0-3 2.018-3 3v10c0 1 1 2 2 2h8c.982 0 .762-1.048 1-2V5L9 0z\"\n});\n\nvar _ref3 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  fill: \"#bdc3c7\",\n  d: \"M4 0c-.982 0-2 1.018-2 2v10c0 .982 1.018 2 2 2h8c.982 0 1.73-1.056 2-2V5L9 0z\"\n});\n\nvar _ref4 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  fill: \"#95a5a6\",\n  d: \"M14 5L9 0v3c0 .982 1.018 2 2 2z\"\n});\n\nvar _ref5 =\n/*#__PURE__*/\nReact.createElement(\"g\", {\n  transform: \"matrix(.5 0 0 .5 9.225 -504.681)\"\n}, React.createElement(\"circle\", {\n  cx: 6.55,\n  cy: 1034.362,\n  r: 7,\n  fill: \"#27ae60\"\n}), React.createElement(\"circle\", {\n  cx: 6.55,\n  cy: 1032.362,\n  r: 7,\n  fill: \"#2ecc71\"\n}), React.createElement(\"path\", {\n  fill: \"#27ae60\",\n  d: \"M1.55 1035.362h4v4h2v-4h4v-2h-4v-4h-2v4h-4z\"\n}), React.createElement(\"path\", {\n  fill: \"#ecf0f1\",\n  d: \"M1.55 1033.362h4v4h2v-4h4v-2h-4v-4h-2v4h-4z\"\n}));\n\nvar SvgDocumentNew16PxImportable = function SvgDocumentNew16PxImportable(_ref) {\n  var svgRef = _ref.svgRef,\n      title = _ref.title,\n      props = _objectWithoutProperties(_ref, [\"svgRef\", \"title\"]);\n\n  return React.createElement(\"svg\", _extends({\n    width: 16,\n    height: 16,\n    viewBox: \"0 0 16 16\",\n    ref: svgRef\n  }, props), title ? React.createElement(\"title\", null, title) : null, _ref2, _ref3, _ref4, _ref5);\n};\n\nvar ForwardRef = React.forwardRef(function (props, ref) {\n  return React.createElement(SvgDocumentNew16PxImportable, _extends({\n    svgRef: ref\n  }, props));\n});\nexport default __webpack_public_path__ + \"static/media/document-new-16px-importable.0a5e72cd.svg\";\nexport { ForwardRef as ReactComponent };","import React, { Component } from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport PropTypes from \"prop-types\";\r\nimport HistoryEntry from \"./HistoryEntry.js\";\r\nimport \"./HistoryView.css\";\r\nimport {getHistoryAncestors, getAllHistoryNodesSortedByTimestamp} from \"../history.js\";\r\nimport HistoryNode from \"../HistoryNode.js\";\r\nimport { ReactComponent as NewDocumentIcon } from \"../icons/small-n-flat/document-new-16px-importable.svg\";\r\n\r\nconst blankImage = new Image();\r\n// transparent single-pixel PNG\r\nblankImage.src = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=\";\r\n\r\n// TODO: keyboard navigation\r\nclass HistoryView extends Component {\r\n\tconstructor(props) {\r\n\t\tsuper(props);\r\n\r\n\t\tthis.currentEntryRef = React.createRef();\r\n\t\t\r\n\t\t// TODO: cleanup how this works!\r\n\t\tthis.drawFunctions = [];\r\n\t}\r\n\tcomponentDidMount() {\r\n\t\tconst animate = () => {\r\n\t\t\tthis.animationFrameID = requestAnimationFrame(animate);\r\n\t\t\tthis.drawFunctions.forEach((fn) => fn());\r\n\t\t};\r\n\t\tanimate();\r\n\t\tthis.scrollSelectedEntryIntoView();\r\n\t}\r\n\tcomponentWillUnmount() {\r\n\t\tcancelAnimationFrame(this.animationFrameID);\r\n\t}\r\n\tcomponentDidUpdate(prevProps) {\r\n\t\tif (this.props.undos.size !== prevProps.undos.size) {\r\n\t\t\t// NOTE: assuming entry sizes are equal\r\n\t\t\tthis.scrollSelectedEntryIntoView();\r\n\t\t}\r\n\t}\r\n\tscrollSelectedEntryIntoView() {\r\n\t\tconst entryEl = this.currentEntryRef.current && ReactDOM.findDOMNode(this.currentEntryRef.current);\r\n\t\tif (entryEl) {\r\n\t\t\tentryEl.scrollIntoView({\r\n\t\t\t\tbehavior: \"instant\",\r\n\t\t\t\tblock: \"nearest\",\r\n\t\t\t\tinline: \"nearest\",\r\n\t\t\t});\r\n\t\t\t// entryEl.parentElement.scrollTop =\r\n\t\t\t// \tMath.min(\r\n\t\t\t// \t\tentryEl.offsetTop,\r\n\t\t\t// \t\tMath.max(\r\n\t\t\t// \t\t\tentryEl.parentElement.scrollTop,\r\n\t\t\t// \t\t\tentryEl.offsetTop - entryEl.parentElement.clientHeight + entryEl.clientHeight\r\n\t\t\t// \t\t)\r\n\t\t\t// \t);\r\n\t\t}\r\n\t}\r\n\trender() {\r\n\t\tthis.drawFunctions = [];\r\n\r\n\t\tconst { currentHistoryNode, goToHistoryNode, thumbnailsByOperation } = this.props;\r\n\r\n\t\tconst historyAncestors = getHistoryAncestors(currentHistoryNode);\r\n\t\tconst allHistoryNodes = getAllHistoryNodesSortedByTimestamp(currentHistoryNode);\r\n\r\n\t\treturn (\r\n\t\t\t<div className=\"HistoryView\" role=\"radiogroup\">\r\n\t\t\t\t{allHistoryNodes.map((node)=> {\r\n\t\t\t\t\tconst ancestorOfCurrent = historyAncestors.indexOf(node) > -1;\r\n\t\t\t\t\tconst current = node === currentHistoryNode;\r\n\t\t\t\t\treturn <HistoryEntry\r\n\t\t\t\t\t\tkey={node.id}\r\n\t\t\t\t\t\thistoryNode={node}\r\n\t\t\t\t\t\tcurrent={current}\r\n\t\t\t\t\t\tref={current && this.currentEntryRef}\r\n\t\t\t\t\t\tancestorOfCurrent={ancestorOfCurrent}\r\n\t\t\t\t\t\tonClick={() => goToHistoryNode(node)}\r\n\t\t\t\t\t\tindexInListForAnimationOffset={0 /* TODO */}\r\n\t\t\t\t\t\tdrawFunctionsArrayToAddTo={this.drawFunctions}\r\n\t\t\t\t\t\tgetThumbnailImageMaybe={() =>\r\n\t\t\t\t\t\t\tnode.operation ?\r\n\t\t\t\t\t\t\t\tthumbnailsByOperation.get(node.operation) :\r\n\t\t\t\t\t\t\t\tblankImage\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tgetIconReactElementMaybe={() =>\r\n\t\t\t\t\t\t\tnode.name === \"New Document\" ? <NewDocumentIcon width={16} height={16}/> : null\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t/>;\r\n\t\t\t\t})}\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n}\r\n\r\nHistoryView.propTypes = {\r\n\tcurrentHistoryNode: PropTypes.instanceOf(HistoryNode).isRequired,\r\n\tthumbnailsByOperation: PropTypes.instanceOf(Map).isRequired,\r\n\tgoToHistoryNode: PropTypes.func.isRequired,\r\n};\r\n\r\nexport default HistoryView;\r\n","import React from \"react\";\r\nimport PropTypes from \"prop-types\";\r\nimport \"./Dialog.css\";\r\n\r\nconst ReportBugLink = (props) => (\r\n\t<a\r\n\t\thref=\"https://github.com/1j01/mopaint/issues/\"\r\n\t\ttarget=\"_blank\"\r\n\t\trel=\"noopener noreferrer\"\r\n\t>\r\n\t\t{props.children}\r\n\t</a>\r\n);\r\n\r\nexport default function Dialog({\r\n\tmessage,\r\n\terror,\r\n\tisError,\r\n\trequestBugReport,\r\n\tclose,\r\n\textraButtons,\r\n\tbuttons,\r\n}) {\r\n\t// TODO: use <dialog> etc.\r\n\t// TODO: error icon (and other icons as appropriate)\r\n\r\n\t// NOTE: error.stack is nonstandard and quite different between browsers.\r\n\t// In chrome it includes the error message redundantly\r\n\t// TODO: handle indentation generically instead of based on cases of Chrome and Firefox\r\n\t// (which could change in the future)\r\n\tconst stackTraceText =\r\n\t\terror &&\r\n\t\terror.stack &&\r\n\t\t(error.stack.indexOf(error.toString()) === 0\r\n\t\t\t? error.stack.slice(error.toString().length).trimEnd() // Chrome\r\n\t\t\t: `\\n${error.stack.trim()}`.replace(/\\n/g, \"\\n    \")); // Firefox\r\n\tconst errorText =\r\n\t\terror &&\r\n\t\t(stackTraceText\r\n\t\t\t? `${error.toString()}\\n\\nStack trace:${stackTraceText}`\r\n\t\t\t: error.toString());\r\n\r\n\treturn (\r\n\t\t<div className=\"Dialog\">\r\n\t\t\t<div className=\"Dialog-box\">\r\n\t\t\t\t{message || error.message}\r\n\t\t\t\t{error && (\r\n\t\t\t\t\t<details>\r\n\t\t\t\t\t\t<summary>Details</summary>\r\n\t\t\t\t\t\t<div className=\"actual-details\">\r\n\t\t\t\t\t\t\t<pre>{errorText}</pre>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</details>\r\n\t\t\t\t)}\r\n\t\t\t\t{requestBugReport && (\r\n\t\t\t\t\t<div>\r\n\t\t\t\t\t\tYou should <ReportBugLink>report this bug</ReportBugLink>.\r\n\t\t\t\t\t</div>\r\n\t\t\t\t)}\r\n\t\t\t\t<div className=\"Dialog-buttons\">\r\n\t\t\t\t\t{buttons || <button onClick={close}>Close</button>}\r\n\t\t\t\t\t{extraButtons}\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t);\r\n}\r\n\r\nDialog.propTypes = {\r\n\tmessage: PropTypes.node.isRequired,\r\n\terror: PropTypes.object,\r\n\tisError: PropTypes.bool,\r\n\trequestBugReport: PropTypes.bool,\r\n\tclose: PropTypes.func,\r\n\textraButtons: PropTypes.node,\r\n\tbuttons: PropTypes.node,\r\n};\r\n","import React from \"react\";\r\nimport PropTypes from \"prop-types\";\r\nimport \"./Warning.css\";\r\n\r\nconst Warning = (props) => {\r\n\treturn <div className=\"Warning\" /*role=\"alert\"*/>{props.children}</div>;\r\n};\r\n\r\nWarning.propTypes = {\r\n\tchildren: PropTypes.node.isRequired,\r\n};\r\n\r\nexport default Warning;\r\n","const palette = [\r\n\t\"rgb(0,0,0)\",\r\n\t\"rgb(34,32,52)\",\r\n\t\"rgb(69,40,60)\",\r\n\t\"rgb(102,57,49)\",\r\n\t\"rgb(143,86,59)\",\r\n\t\"rgb(223,113,38)\",\r\n\t\"rgb(217,160,102)\",\r\n\t\"rgb(238,195,154)\",\r\n\t\"rgb(251,242,54)\",\r\n\t\"rgb(153,229,80)\",\r\n\t\"rgb(106,190,48)\",\r\n\t\"rgb(55,148,110)\",\r\n\t\"rgb(75,105,47)\",\r\n\t\"rgb(82,75,36)\",\r\n\t\"rgb(50,60,57)\",\r\n\t\"rgb(63,63,116)\",\r\n\t\"rgb(48,96,130)\",\r\n\t\"rgb(91,110,225)\",\r\n\t\"rgb(99,155,255)\",\r\n\t\"rgb(95,205,228)\",\r\n\t\"rgb(203,219,252)\",\r\n\t\"rgb(255,255,255)\",\r\n\t\"rgb(155,173,183)\",\r\n\t\"rgb(132,126,135)\",\r\n\t\"rgb(105,106,106)\",\r\n\t\"rgb(89,86,82)\",\r\n\t\"rgb(118,66,138)\",\r\n\t\"rgb(172,50,50)\",\r\n\t\"rgb(217,87,99)\",\r\n\t\"rgb(215,123,186)\",\r\n\t\"rgb(143,151,74)\",\r\n\t\"rgb(138,111,48)\",\r\n];\r\n\r\nexport default palette;\r\n","function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport React from \"react\";\n\nvar _ref2 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M7 0c-.982 0-3 2.018-3 3v16c0 1 1 2 2 2h12c.982 0 1-1.018 1-2V5l-4-5z\",\n  fill: \"#95a5a6\"\n});\n\nvar _ref3 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M6 0c-.982 0-2 1.018-2 2v16c0 .982 1.018 2 2 2h12c.982 0 2-1.018 2-2V5l-5-5z\",\n  fill: \"#bdc3c7\"\n});\n\nvar _ref4 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M20 5l-5-5v3c0 .982 1.03 1.845 2 2z\",\n  fill: \"#95a5a6\"\n});\n\nvar _ref5 =\n/*#__PURE__*/\nReact.createElement(\"g\", {\n  transform: \"matrix(.5 0 0 .5 16.225 -497.681)\"\n}, React.createElement(\"circle\", {\n  cx: 6.55,\n  cy: 1034.362,\n  r: 9,\n  fill: \"#27ae60\"\n}), React.createElement(\"circle\", {\n  cx: 6.55,\n  cy: 1032.362,\n  r: 9,\n  fill: \"#2ecc71\"\n}), React.createElement(\"path\", {\n  d: \"M1.55 1035.362h4v4h2v-4h4v-2h-4v-4h-2v4h-4z\",\n  fill: \"#27ae60\"\n}), React.createElement(\"path\", {\n  d: \"M1.55 1033.362h4v4h2v-4h4v-2h-4v-4h-2v4h-4z\",\n  fill: \"#ecf0f1\"\n}));\n\nvar SvgDocumentNewImportable = function SvgDocumentNewImportable(_ref) {\n  var svgRef = _ref.svgRef,\n      title = _ref.title,\n      props = _objectWithoutProperties(_ref, [\"svgRef\", \"title\"]);\n\n  return React.createElement(\"svg\", _extends({\n    width: 24,\n    height: 24,\n    viewBox: \"0 0 24 24\",\n    ref: svgRef\n  }, props), title ? React.createElement(\"title\", null, title) : null, _ref2, _ref3, _ref4, _ref5);\n};\n\nvar ForwardRef = React.forwardRef(function (props, ref) {\n  return React.createElement(SvgDocumentNewImportable, _extends({\n    svgRef: ref\n  }, props));\n});\nexport default __webpack_public_path__ + \"static/media/document-new-importable.b8ee69e7.svg\";\nexport { ForwardRef as ReactComponent };","function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport React from \"react\";\n\nvar _ref2 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M1.632 6.314C.73 6.314 0 7.044 0 7.946v11.422C0 20.27.78 21 1.682 21H17.75c1.401 0 2.281-2.21 2.253-2.42l-.422-.549V7.946c0-.902-.73-1.632-1.631-1.632z\",\n  fill: \"#2980b9\"\n});\n\nvar _ref3 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M3 3c-.901 0-2 1.099-2 2v10.928c0 1 .546 1.808 1.448 1.808H17.134c.901 0 1.632-.73 1.632-1.631V6.532C18.766 5.633 17.9 5 17 5H10.473L8 3z\",\n  fill: \"#2980b9\"\n});\n\nvar _ref4 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M18.52 19.368L20 8c.118-.909-.203-2-1.203-2H4c-.901 0-1.42.229-1.557 1.13L1 19z\",\n  fill: \"#bdc3c7\"\n});\n\nvar _ref5 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M6 7c-.901 0-1.362.044-1.68.946L2.591 12.84l-.288.816L1 18c-.318.901 0 2 2 2h15.14c.902 0 1.34-.156 1.799-1.12l1.946-5.223.288-.816 1.463-4.32c.428-1.1.172-1.521-.972-1.521z\",\n  fill: \"#3498db\"\n});\n\nvar SvgDocumentOpenImportable = function SvgDocumentOpenImportable(_ref) {\n  var svgRef = _ref.svgRef,\n      title = _ref.title,\n      props = _objectWithoutProperties(_ref, [\"svgRef\", \"title\"]);\n\n  return React.createElement(\"svg\", _extends({\n    width: 24,\n    height: 24,\n    viewBox: \"0 0 24 24\",\n    ref: svgRef\n  }, props), title ? React.createElement(\"title\", null, title) : null, _ref2, _ref3, _ref4, _ref5);\n};\n\nvar ForwardRef = React.forwardRef(function (props, ref) {\n  return React.createElement(SvgDocumentOpenImportable, _extends({\n    svgRef: ref\n  }, props));\n});\nexport default __webpack_public_path__ + \"static/media/document-open-importable.98294831.svg\";\nexport { ForwardRef as ReactComponent };","function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport React from \"react\";\n\nvar _ref2 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-3H5z\",\n  fill: \"#3498db\"\n});\n\nvar _ref3 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M7 3v6a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3H7z\",\n  fill: \"#2980b9\"\n});\n\nvar _ref4 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  d: \"M7 3v5a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3H7zM6 12a1 1 0 0 0-1 1v8h14v-8a1 1 0 0 0-1-1H6z\",\n  fill: \"#ecf0f1\"\n});\n\nvar _ref5 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  fill: \"#bdc3c7\",\n  d: \"M5 20h14v1H5zM7 14h10v1H7zM7 16h10v1H7z\"\n});\n\nvar _ref6 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  fill: \"#3498db\",\n  d: \"M13 4h3v4h-3z\"\n});\n\nvar _ref7 =\n/*#__PURE__*/\nReact.createElement(\"path\", {\n  fill: \"#2980b9\",\n  d: \"M13 4h3v1h-3z\"\n});\n\nvar SvgDocumentSaveImportable = function SvgDocumentSaveImportable(_ref) {\n  var svgRef = _ref.svgRef,\n      title = _ref.title,\n      props = _objectWithoutProperties(_ref, [\"svgRef\", \"title\"]);\n\n  return React.createElement(\"svg\", _extends({\n    width: 24,\n    height: 24,\n    viewBox: \"0 0 24 24\",\n    ref: svgRef\n  }, props), title ? React.createElement(\"title\", null, title) : null, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7);\n};\n\nvar ForwardRef = React.forwardRef(function (props, ref) {\n  return React.createElement(SvgDocumentSaveImportable, _extends({\n    svgRef: ref\n  }, props));\n});\nexport default __webpack_public_path__ + \"static/media/document-save-importable.5fad2c24.svg\";\nexport { ForwardRef as ReactComponent };","import localforage from \"localforage\";\r\nimport { List } from \"immutable\";\r\nimport React, { Component, useEffect, useState, useRef } from \"react\";\r\nimport PropTypes from \"prop-types\";\r\nimport { load as loadPalette } from \"anypalette\";\r\nimport isPNG from \"is-png\";\r\nimport { injectMetadataIntoBlob, readMetadataSync } from \"../png-metadata.js\";\r\nimport { serializeDocument, deserializeDocument } from \"../document-format\"; \r\nimport tools, { toolsByName } from \"../tools\";\r\nimport DrawingCanvas from \"./DrawingCanvas.js\";\r\nimport Toolbox from \"./Toolbox.js\";\r\nimport Colorbox from \"./Colorbox.js\";\r\nimport HistoryView from \"./HistoryView.js\";\r\nimport Dialog from \"./Dialog.js\";\r\nimport Warning from \"./Warning.js\";\r\nimport defaultPalette from \"../db32-palette.js\";\r\nimport \"./App.css\";\r\nimport { ReactComponent as NewDocumentIcon } from \"../icons/small-n-flat/document-new-importable.svg\";\r\nimport { ReactComponent as OpenDocumentIcon } from \"../icons/small-n-flat/document-open-importable.svg\";\r\nimport { ReactComponent as SaveDocumentIcon } from \"../icons/small-n-flat/document-save-importable.svg\";\r\nimport HistoryNode from \"../HistoryNode.js\";\r\nimport { undo, redo, goToHistoryNode } from \"../history.js\";\r\n\r\nconst getToolByName = (toolID)=> {\r\n\tconst tool = toolsByName[toolID];\r\n\tif (!tool) {\r\n\t\tthrow new Error(`Tool not found with name '${toolID}'`);\r\n\t}\r\n\treturn tool;\r\n};\r\n\r\nclass App extends Component {\r\n\tconstructor(props) {\r\n\t\tsuper(props);\r\n\t\t// TODO: move state outside of the component\r\n\t\tthis.state = {\r\n\t\t\tpalette: defaultPalette, // TODO: eventually probably remove the \"palette\" state as a concept;\r\n\t\t\t// I don't think this feature is special enough to warrant special handling (except for parsing palette files)\r\n\t\t\t// It can be part of the document, and more dynamic (gradients and patterns),\r\n\t\t\t// and could be shared with other documents the same way(s) as tools should be able to be\r\n\t\t\t// (and images could be used as palettes by sampling from them)\r\n\t\t\tselectedSwatch: defaultPalette[0],\r\n\t\t\tselectedTool: getToolByName(\"Freeform Line\"),\r\n\t\t\tundos: new List(),\r\n\t\t\tredos: new List(),\r\n\t\t\tcurrentHistoryNode: new HistoryNode({name: \"New Document\"}),\r\n\t\t\tloaded: false,\r\n\t\t\tloadFailed: false,\r\n\t\t};\r\n\r\n\t\tthis.thumbnailsByOperation = new Map(); // TODO: could use cache?\r\n\r\n\t\tthis.timeoutIDs = new Set();\r\n\t\tconst debounce = (func, delay) => {\r\n\t\t\tlet timeoutID;\r\n\t\t\treturn () => {\r\n\t\t\t\tclearTimeout(timeoutID);\r\n\t\t\t\tthis.timeoutIDs.delete(timeoutID);\r\n\t\t\t\ttimeoutID = setTimeout(func, delay);\r\n\t\t\t\tthis.timeoutIDs.add(timeoutID);\r\n\t\t\t};\r\n\t\t};\r\n\t\tthis.saveDebounced = debounce(this.save.bind(this), 500);\r\n\t}\r\n\r\n\tloadSerializedDocument(serialized, fromFile) {\r\n\t\tlet errorInfo, stateUpdates;\r\n\t\ttry {\r\n\t\t\t[errorInfo, stateUpdates] = deserializeDocument(serialized, fromFile, getToolByName);\r\n\t\t} catch (error) {\r\n\t\t\terrorInfo = {\r\n\t\t\t\tmessage: \"Failed to load document!\",\r\n\t\t\t\terror,\r\n\t\t\t};\r\n\t\t}\r\n\t\tif (errorInfo) {\r\n\t\t\tthis.showError(errorInfo);\r\n\t\t\tthis.setState({ loadFailed: true });\r\n\t\t} else {\r\n\t\t\tstateUpdates.loaded = true;\r\n\t\t\tthis.setState(stateUpdates, () => {\r\n\t\t\t\tconsole.log(`Loaded ${this.props.documentID}`);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tload() {\r\n\t\tif (!this.props.documentID) {\r\n\t\t\tconsole.log(`No document ID to load`);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconsole.log(`Load ${this.props.documentID}`);\r\n\t\tconst {serializedDocumentToLoad} = this.props;\r\n\t\tlocalforage.getItem(\r\n\t\t\t`document:${this.props.documentID}:state`,\r\n\t\t\t(error, serialized) => {\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\t// TODO: detect quota limit\r\n\t\t\t\t\tthis.showError({\r\n\t\t\t\t\t\tmessage: \"Failed to load document state from storage!\",\r\n\t\t\t\t\t\terror,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.setState({ loadFailed: true });\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (serializedDocumentToLoad) {\r\n\t\t\t\t\tif (!serialized) {\r\n\t\t\t\t\t\tthis.loadSerializedDocument(serializedDocumentToLoad);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.showError({\r\n\t\t\t\t\t\t\tmessage:\r\n\t\t\t\t\t\t\t\t\"Almost loaded a document over an existing document. This shouldn't happen!\",\r\n\t\t\t\t\t\t\trequestBugReport: true,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (!serialized) {\r\n\t\t\t\t\tthis.setState({ loaded: true });\r\n\t\t\t\t\tconsole.log(\r\n\t\t\t\t\t\t`State loaded as empty for document:${this.props.documentID}:state`,\r\n\t\t\t\t\t);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tconsole.log(`Loaded data for ${this.props.documentID}`);\r\n\t\t\t\tthis.loadSerializedDocument(serialized);\r\n\t\t\t},\r\n\t\t);\r\n\t}\r\n\r\n\tsave(leavingThisDocument) {\r\n\t\tif (!this.state.loaded) {\r\n\t\t\tif (!leavingThisDocument) {\r\n\t\t\t\t// TODO: allow drawing in not-loaded document and carry state over to a new document\r\n\t\t\t\t// (and update this message to reflect that (clearly, and reassuringly))\r\n\t\t\t\tthis.setState({ undos: new List(), redos: new List(), loaded: false });\r\n\t\t\t\tthis.showError({\r\n\t\t\t\t\tmessage: `The document ${\r\n\t\t\t\t\t\tthis.state.loadFailed ? \"failed to load\" : \"hasn't loaded yet\"\r\n\t\t\t\t\t}. Start a new document?`,\r\n\t\t\t\t\textraButtons: (\r\n\t\t\t\t\t\t<button onClick={this.props.createNewDocument}>New Document</button>\r\n\t\t\t\t\t),\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst serialized = serializeDocument(this.state);\r\n\t\tlocalforage.setItem(\r\n\t\t\t`document:${this.props.documentID}:state`,\r\n\t\t\tserialized,\r\n\t\t\t(error) => {\r\n\t\t\t\tconst documentThatYouWereMaybeLeaving = leavingThisDocument\r\n\t\t\t\t\t? \"the previous document\"\r\n\t\t\t\t\t: \"document\";\r\n\t\t\t\t// Enable one of these lines to emit Error Message Itself Test (EMIT) errors (I'm coining that! 😛)\r\n\t\t\t\t// error = new Error(); error.name = \"QuotaExceededError\";\r\n\t\t\t\t// error = new Error(\"asdftest\"); error.name = \"QuotaExceededError\";\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\t// TODO: investigate these different error cases (in different browsers), and improve the messages\r\n\t\t\t\t\t// This \"QuotaExceededError\" without a message seems to happen in Chrome when the disk is full\r\n\t\t\t\t\t// but other browsers probably wouldn't do the same thing,\r\n\t\t\t\t\t// so it might make sense to present both possibilities regardless...\r\n\t\t\t\t\t// (but maybe present them in different priority of likeliness?\r\n\t\t\t\t\t// but that might just come across as confusingly inconsistent)\r\n\t\t\t\t\t// Also it might make sense to make it a (small/short) dialog tree,\r\n\t\t\t\t\t// either with separate dialog boxes, or with expandables\r\n\t\t\t\t\t// Also it would be nice to link to documentation (or web searches) to help with checking disk space and freeing it up\r\n\t\t\t\t\t// (e.g. \"check disk space <operating system name>\")\r\n\t\t\t\t\t// Also once there's a document selector, where you can manage storage, there should be a button to open it,\r\n\t\t\t\t\t// and the message(s) should be updated; no more need to delete all documents\r\n\t\t\t\t\tif (error.name === \"QuotaExceededError\" && !error.message) {\r\n\t\t\t\t\t\tthis.showError({\r\n\t\t\t\t\t\t\tmessage: <div>\r\n\t\t\t\t\t\t\t\tFailed to save {documentThatYouWereMaybeLeaving} into storage!\r\n\t\t\t\t\t\t\t\t<br/><br/>\r\n\t\t\t\t\t\t\t\tCheck that your computer has enough disk space.\r\n\t\t\t\t\t\t\t\t<br/><br/>\r\n\t\t\t\t\t\t\t\tIf you have enough free space, we've run out of space as allowed by the browser per site.\r\n\t\t\t\t\t\t\t\tYou could free up quota by clearing the storage for this site in your browser's settings,\r\n\t\t\t\t\t\t\t\thowever, this will delete all documents.\r\n\t\t\t\t\t\t\t</div>,\r\n\t\t\t\t\t\t\terror,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else if (error.name === \"QuotaExceededError\") {\r\n\t\t\t\t\t\t// We don't *know* it's running into quota limits here, it could be out of disk space in other browsers\r\n\t\t\t\t\t\t// This \"Ran out of space allowed by the browser\" is sort of designed to be ambiguous,\r\n\t\t\t\t\t\t// but that's not a good way to get across the possibility of different scenarios;\r\n\t\t\t\t\t\t// TODO: find a way to make this clear/better\r\n\t\t\t\t\t\tthis.showError({\r\n\t\t\t\t\t\t\tmessage: <div>\r\n\t\t\t\t\t\t\t\tFailed to save {documentThatYouWereMaybeLeaving} into storage!\r\n\t\t\t\t\t\t\t\t<br/><br/>\r\n\t\t\t\t\t\t\t\tRan out of space allowed by the browser.\r\n\t\t\t\t\t\t\t\tYou could free up quota by clearing the storage for this site in your browser's settings,\r\n\t\t\t\t\t\t\t\thowever, this will delete all documents.\r\n\t\t\t\t\t\t\t</div>,\r\n\t\t\t\t\t\t\terror,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.showError({\r\n\t\t\t\t\t\t\tmessage: `Failed to save ${documentThatYouWereMaybeLeaving} into storage!`,\r\n\t\t\t\t\t\t\terror,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.log(\r\n\t\t\t\t\t\t`Saved ${this.props.documentID}${\r\n\t\t\t\t\t\t\tleavingThisDocument ? \" (leaving it)\" : \"\"\r\n\t\t\t\t\t\t}`,\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t);\r\n\t}\r\n\r\n\tcreatePNGram(serializedDocument, callback, mismatchedCallback) {\r\n\t\tconst json = JSON.stringify(serializedDocument);\r\n\t\tconst metadata = {\r\n\t\t\t\"Software\": \"Mopaint\",\r\n\t\t\t\"Mopaint Format Version\": serializedDocument.formatVersion,\r\n\t\t\t\"Creation Time\": new Date().toUTCString(),\r\n\t\t\t\"Program Source\": json,\r\n\t\t};\r\n\r\n\t\tconsole.log(\"Save PNG with metadata\", metadata);\r\n\r\n\t\tconst verifyEncodedBlob = (\r\n\t\t\tencodedBlob,\r\n\t\t\tverifiedCallback,\r\n\t\t\tmismatchedCallback,\r\n\t\t) => {\r\n\t\t\tconst fileReader = new FileReader();\r\n\t\t\tfileReader.onload = () => {\r\n\t\t\t\tconst arrayBuffer = fileReader.result;\r\n\t\t\t\tconst uint8Array = new Uint8Array(arrayBuffer);\r\n\t\t\t\tconst encodedMetadata = readMetadataSync(uint8Array);\r\n\t\t\t\tif (encodedMetadata[\"Program Source\"] === json) {\r\n\t\t\t\t\tverifiedCallback();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmismatchedCallback();\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tfileReader.readAsArrayBuffer(encodedBlob);\r\n\t\t};\r\n\r\n\t\tthis.createRawPNG((rawImageBlob) => {\r\n\t\t\tinjectMetadataIntoBlob(rawImageBlob, metadata, (pngramBlob) => {\r\n\t\t\t\tverifyEncodedBlob(\r\n\t\t\t\t\tpngramBlob,\r\n\t\t\t\t\t() => {\r\n\t\t\t\t\t\tcallback(pngramBlob);\r\n\t\t\t\t\t},\r\n\t\t\t\t\t() => {\r\n\t\t\t\t\t\tmismatchedCallback();\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tcreateRawPNG(callback) {\r\n\t\t// TODO: get this in a more \"legit\" way (i.e. refs)\r\n\t\tconst canvas = document.querySelector(\".DrawingCanvas canvas\");\r\n\r\n\t\tcanvas.toBlob(callback, \"image/png\");\r\n\t}\r\n\r\n\tloadDocumentFromJSON(json) {\r\n\t\tlet serializedDocument;\r\n\t\ttry {\r\n\t\t\tserializedDocument = JSON.parse(json);\r\n\t\t} catch (error) {\r\n\t\t\tthis.showError({\r\n\t\t\t\tmessage: (\r\n\t\t\t\t\t<div>\r\n\t\t\t\t\t\tFailed to load as Mopaint document, invalid JSON\r\n\t\t\t\t\t\t<details>\r\n\t\t\t\t\t\t\t<summary>JSON</summary>\r\n\t\t\t\t\t\t\t<div className=\"actual-details\">\r\n\t\t\t\t\t\t\t\t<pre>{json}</pre>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</details>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t),\r\n\t\t\t\terror,\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.props.loadNewDocument(serializedDocument);\r\n\t}\r\n\r\n\thandleDroppedOrOpenedFiles(files) {\r\n\t\t// TODO: progress indication\r\n\t\tconst file = files[0];\r\n\t\tif (file) {\r\n\t\t\tconst fileReader = new FileReader();\r\n\t\t\tfileReader.onload = () => {\r\n\t\t\t\tconst arrayBuffer = fileReader.result;\r\n\t\t\t\tconst uint8Array = new Uint8Array(arrayBuffer);\r\n\t\t\t\tif (isPNG(uint8Array)) {\r\n\t\t\t\t\tconst metadata = readMetadataSync(uint8Array);\r\n\t\t\t\t\tconst formatVersion = metadata[\"Mopaint Format Version\"];\r\n\t\t\t\t\tif (formatVersion) {\r\n\t\t\t\t\t\tconst json = metadata[\"Program Source\"];\r\n\t\t\t\t\t\tthis.loadDocumentFromJSON(json);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// TODO: handle plain image files\r\n\t\t\t\t\t\tthis.showError({\r\n\t\t\t\t\t\t\tmessage:\r\n\t\t\t\t\t\t\t\t\"Loading images is not supported yet (other than Mopaint PNG programs)\",\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (uint8Array[0] === \"{\".charCodeAt(0)) {\r\n\t\t\t\t\tconst fileReader = new FileReader();\r\n\t\t\t\t\tfileReader.onload = () => {\r\n\t\t\t\t\t\tthis.loadDocumentFromJSON(fileReader.result);\r\n\t\t\t\t\t};\r\n\t\t\t\t\tfileReader.readAsText(file);\r\n\t\t\t\t\t// TODO: handle palette json files\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// TODO: handle plain image files, Photoshop/GIMP/Paint.NET documents, etc.\r\n\t\t\t\t\tloadPalette(file, (error, palette) => {\r\n\t\t\t\t\t\tif (error) {\r\n\t\t\t\t\t\t\tthis.showError({\r\n\t\t\t\t\t\t\t\tmessage: `Failed to load file as a color palette.`, // TODO: more generic message? uh? er? hm? uh...\r\n\t\t\t\t\t\t\t\terror,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis.setState(\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\tpalette: palette.map((color) => color.toString()),\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\tthis.saveDebounced.bind(this),\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tfileReader.readAsArrayBuffer(file);\r\n\t\t}\r\n\t}\r\n\r\n\topenDocument() {\r\n\t\tconst input = document.createElement(\"input\");\r\n\t\tinput.type = \"file\";\r\n\t\tinput.style.display = \"none\";\r\n\t\tdocument.body.appendChild(input);\r\n\t\t// input.multiple = true; // TODO once opening multiple images is a thing\r\n\t\tinput.addEventListener(\"change\", () => {\r\n\t\t\tthis.handleDroppedOrOpenedFiles(input.files);\r\n\t\t\tinput.remove();\r\n\t\t});\r\n\t\tinput.click();\r\n\t}\r\n\r\n\tcomponentDidMount() {\r\n\t\tthis.load();\r\n\r\n\t\twindow.addEventListener(\r\n\t\t\t\"beforeunload\",\r\n\t\t\t(this.beforeUnloadListener = (event) => {\r\n\t\t\t\t// This isn't the only time we save -- that would be a terrible pattern! you can't rely on any 'event' in a power outage or crash --\r\n\t\t\t\t// but it's good to have since there are places where we delay (i.e. debounce) saving for performance reasons\r\n\t\t\t\t// so if you made a change and then quickly closed or reloaded the page (by accident, and/or with auto reload in development),\r\n\t\t\t\t// it'll still save, and you won't lose anything. it's great. 🙂\r\n\t\t\t\tthis.save(true);\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\twindow.addEventListener(\r\n\t\t\t\"keydown\",\r\n\t\t\t(this.keyDownListener = (event) => {\r\n\t\t\t\tif (event.key === \"Escape\") {\r\n\t\t\t\t\tthis.closeDialog();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (\r\n\t\t\t\t\tdocument.activeElement &&\r\n\t\t\t\t\tdocument.activeElement.matches(\"input, textarea\")\r\n\t\t\t\t) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t// TODO: metaKey for mac\r\n\t\t\t\tif (event.ctrlKey) {\r\n\t\t\t\t\tif (event.key === \"z\") {\r\n\t\t\t\t\t\tthis.undo();\r\n\t\t\t\t\t} else if (event.key === \"Z\" || event.key === \"y\") {\r\n\t\t\t\t\t\tthis.redo();\r\n\t\t\t\t\t} else if (event.key === \"s\" || event.key === \"S\") { // Save and Save As shortcuts same for now\r\n\t\t\t\t\t\tthis.showSaveDialog();\r\n\t\t\t\t\t} else if (event.key === \"o\") {\r\n\t\t\t\t\t\tthis.openDocument();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn; // don't prevent default\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn; // don't prevent default\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\twindow.addEventListener(\r\n\t\t\t\"dragover\",\r\n\t\t\t(this.dragOverListener = (e) => {\r\n\t\t\t\te.preventDefault();\r\n\t\t\t}),\r\n\t\t);\r\n\t\twindow.addEventListener(\r\n\t\t\t\"drop\",\r\n\t\t\t(this.dropListener = (e) => {\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\tthis.handleDroppedOrOpenedFiles(e.dataTransfer.files);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tcomponentWillUnmount() {\r\n\t\tthis.save(true);\r\n\t\tthis.timeoutIDs.forEach((timeoutID) => {\r\n\t\t\tclearTimeout(timeoutID);\r\n\t\t});\r\n\t\twindow.removeEventListener(\"beforeunload\", this.beforeUnloadListener);\r\n\t\twindow.removeEventListener(\"keydown\", this.keyDownListener);\r\n\t\twindow.removeEventListener(\"dragover\", this.dragOverListener);\r\n\t\twindow.removeEventListener(\"drop\", this.dropListener);\r\n\t}\r\n\r\n\tcomponentWillReceiveProps(nextProps) {\r\n\t\tconsole.assert(\r\n\t\t\tnextProps.documentID === this.props.documentID,\r\n\t\t\t\"App component is not designed to handle switching documents without reconstruction\",\r\n\t\t);\r\n\t\t// TODO: make App component handle switching documents\r\n\t}\r\n\r\n\t// TODO: collaborative sync with undo/redo, showing operations from other users in realtime\r\n\t// Note: should be able to support time-based tools in a reproducible way\r\n\t// with timestamps and periodic updates to the lastest timestamp\r\n\t// and support psuedorandomness by seeding from operation ID\r\n\t// TODO: move this state manipulation stuff out of the component\r\n\taddOperation(operation) {\r\n\r\n\t\tlet { currentHistoryNode, undos, redos } = this.state;\r\n\r\n\t\tredos = new List();\r\n\t\tundos = undos.push(currentHistoryNode);\r\n\r\n\t\tconst newHistoryNode = new HistoryNode({\r\n\t\t\tparentNode: currentHistoryNode,\r\n\t\t\tname: operation.tool.name,\r\n\t\t\toperation,\r\n\t\t});\r\n\t\tcurrentHistoryNode.childNodes.push(newHistoryNode);\r\n\t\tcurrentHistoryNode = newHistoryNode;\r\n\t\t\r\n\t\tthis.setState(\r\n\t\t\t{\r\n\t\t\t\tcurrentHistoryNode: currentHistoryNode,\r\n\t\t\t\tundos: undos,\r\n\t\t\t\tredos: redos,\r\n\t\t\t},\r\n\t\t\tthis.save.bind(this),\r\n\t\t);\r\n\t}\r\n\r\n\tupdateOperation(operation) {\r\n\t\t// TODO: immutable operation objects probably (immutable.js has a Record class, I could use that)\r\n\t\t// or append-only operation state?\r\n\t\t// TODO: soft undo/redo / fundo/freedo / sliding/gliding/partial undo/redo\r\n\r\n\t\t// (this is just to generically trigger an update)\r\n\t\tthis.setState({ currentHistoryNode: this.state.currentHistoryNode }, this.saveDebounced.bind(this));\r\n\t}\r\n\r\n\tundo() {\r\n\t\tconst { currentHistoryNode, undos, redos } = this.state;\r\n\r\n\t\tconst newState = undo({currentHistoryNode, undos, redos});\r\n\t\tthis.setState(\r\n\t\t\t{\r\n\t\t\t\tcurrentHistoryNode: newState.currentHistoryNode,\r\n\t\t\t\tundos: newState.undos,\r\n\t\t\t\tredos: newState.redos,\r\n\t\t\t},\r\n\t\t\tthis.saveDebounced.bind(this),\r\n\t\t);\r\n\t}\r\n\r\n\tredo() {\r\n\t\tconst { currentHistoryNode, undos, redos } = this.state;\r\n\r\n\t\tconst newState = redo({currentHistoryNode, undos, redos});\r\n\t\tthis.setState(\r\n\t\t\t{\r\n\t\t\t\tcurrentHistoryNode: newState.currentHistoryNode,\r\n\t\t\t\tundos: newState.undos,\r\n\t\t\t\tredos: newState.redos,\r\n\t\t\t},\r\n\t\t\tthis.saveDebounced.bind(this),\r\n\t\t);\r\n\t}\r\n\r\n\tgoToHistoryNode(targetHistoryNode) {\r\n\t\tconst { currentHistoryNode, undos, redos } = this.state;\r\n\r\n\t\tconst newState = goToHistoryNode(targetHistoryNode, {currentHistoryNode, undos, redos});\r\n\t\tthis.setState(\r\n\t\t\t{\r\n\t\t\t\tcurrentHistoryNode: newState.currentHistoryNode,\r\n\t\t\t\tundos: newState.undos,\r\n\t\t\t\tredos: newState.redos,\r\n\t\t\t},\r\n\t\t\tthis.saveDebounced.bind(this),\r\n\t\t);\r\n\t}\r\n\r\n\trender() {\r\n\t\tconst { selectedSwatch, selectedTool, palette, currentHistoryNode, dialog } = this.state;\r\n\r\n\t\tconst selectSwatch = (swatch) => {\r\n\t\t\tthis.setState({ selectedSwatch: swatch }, this.saveDebounced.bind(this));\r\n\t\t};\r\n\t\tconst selectTool = (tool) => {\r\n\t\t\tthis.setState({ selectedTool: tool }, this.saveDebounced.bind(this));\r\n\t\t};\r\n\r\n\t\tconst operations = [];\r\n\t\tconst collectOperations = (historyNode)=> {\r\n\t\t\tif (historyNode.operation) {\r\n\t\t\t\toperations.push(historyNode.operation);\r\n\t\t\t}\r\n\t\t\twhile (historyNode.parentNode) {\r\n\t\t\t\thistoryNode = historyNode.parentNode;\r\n\t\t\t\tif (historyNode.operation) {\r\n\t\t\t\t\toperations.push(historyNode.operation);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\toperations.reverse();\r\n\t\t};\r\n\t\tcollectOperations(currentHistoryNode);\r\n\r\n\t\treturn (\r\n\t\t\t<div className=\"App\">\r\n\t\t\t\t<main>\r\n\t\t\t\t\t<Warning>\r\n\t\t\t\t\t\t⚠ This app is in very early stages of development. There are Big Plans.\r\n\t\t\t\t\t\tSee the <a href=\"https://github.com/1j01/mopaint#mopaint\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n\t\t\t\t\t\t\tREADME on GitHub for more info\r\n\t\t\t\t\t\t</a>.\r\n\t\t\t\t\t</Warning>\r\n\t\t\t\t\t<div id=\"documents-options\">\r\n\t\t\t\t\t\t<label>\r\n\t\t\t\t\t\t\tSwitch documents:&nbsp;\r\n\t\t\t\t\t\t\t<select\r\n\t\t\t\t\t\t\t\tvalue={this.props.documentID}\r\n\t\t\t\t\t\t\t\tonChange={(event) =>\r\n\t\t\t\t\t\t\t\t\tthis.props.goToDocument(event.target.value)\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t// documentID may not be in documentIDs if the document is not yet saved\r\n\t\t\t\t\t\t\t\t\t[this.props.documentID, ...this.props.documentIDs.filter((id)=> id !== this.props.documentID)].map((documentID) => {\r\n\t\t\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\t\t\t<option value={documentID} key={documentID}>\r\n\t\t\t\t\t\t\t\t\t\t\t\tUntitled ({documentID})\r\n\t\t\t\t\t\t\t\t\t\t\t</option>\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t<hr/>\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tid=\"new-document\"\r\n\t\t\t\t\t\t\tclassName=\"toolbar-button\"\r\n\t\t\t\t\t\t\tonClick={this.props.createNewDocument}\r\n\t\t\t\t\t\t\taria-label=\"New Document\"\r\n\t\t\t\t\t\t\ttitle=\"New Document\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<NewDocumentIcon width=\"48px\" height=\"48px\"/>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tid=\"save-document\"\r\n\t\t\t\t\t\t\tclassName=\"toolbar-button\"\r\n\t\t\t\t\t\t\tonClick={() => {\r\n\t\t\t\t\t\t\t\tthis.showSaveDialog();\r\n\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\taria-label=\"Save Document\"\r\n\t\t\t\t\t\t\ttitle=\"Save Document\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<SaveDocumentIcon width=\"48px\" height=\"48px\"/>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tid=\"open-document\"\r\n\t\t\t\t\t\t\tclassName=\"toolbar-button\"\r\n\t\t\t\t\t\t\tonClick={() => {\r\n\t\t\t\t\t\t\t\tthis.openDocument();\r\n\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\taria-label=\"Open Document\"\r\n\t\t\t\t\t\t\ttitle=\"Open Document\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<OpenDocumentIcon width=\"48px\" height=\"48px\"/>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<Toolbox\r\n\t\t\t\t\t\ttools={tools}\r\n\t\t\t\t\t\tselectedTool={selectedTool}\r\n\t\t\t\t\t\tselectTool={selectTool}\r\n\t\t\t\t\t/>\r\n\t\t\t\t\t<Colorbox\r\n\t\t\t\t\t\tpalette={palette}\r\n\t\t\t\t\t\tselectedSwatch={selectedSwatch}\r\n\t\t\t\t\t\tselectSwatch={selectSwatch}\r\n\t\t\t\t\t/>\r\n\t\t\t\t\t<DrawingCanvas\r\n\t\t\t\t\t\tselectedSwatch={selectedSwatch}\r\n\t\t\t\t\t\tselectedTool={selectedTool}\r\n\t\t\t\t\t\tdocumentContext={this.documentContext}\r\n\t\t\t\t\t\taddOperation={this.addOperation.bind(this)}\r\n\t\t\t\t\t\tupdateOperation={this.updateOperation.bind(this)}\r\n\t\t\t\t\t\toperations={operations}\r\n\t\t\t\t\t\tthumbnailsByOperation={this.thumbnailsByOperation}\r\n\t\t\t\t\t\tref={(component) => {\r\n\t\t\t\t\t\t\tthis.drawingCanvasComponent = component;\r\n\t\t\t\t\t\t}}\r\n\t\t\t\t\t/>\r\n\t\t\t\t</main>\r\n\t\t\t\t{/* TODO: resizable sidebar */}\r\n\t\t\t\t<div className=\"sidebar\">\r\n\t\t\t\t\t<HistoryView\r\n\t\t\t\t\t\tcurrentHistoryNode={this.state.currentHistoryNode}\r\n\t\t\t\t\t\tundos={this.state.undos}\r\n\t\t\t\t\t\tredos={this.state.redos}\r\n\t\t\t\t\t\tgoToHistoryNode={this.goToHistoryNode.bind(this)}\r\n\t\t\t\t\t\tthumbnailsByOperation={this.thumbnailsByOperation}\r\n\t\t\t\t\t/>\r\n\t\t\t\t</div>\r\n\t\t\t\t{dialog}\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n\r\n\tshowError(dialogState) {\r\n\t\tdialogState = { isError: true, ...dialogState };\r\n\t\tif (window.console && dialogState.error) {\r\n\t\t\tconsole.error(\"(Error details:)\", dialogState.error);\r\n\t\t}\r\n\t\tthis.showMessage(dialogState);\r\n\t}\r\n\r\n\tshowMessage(dialogState) {\r\n\t\tthis.showDialog(\r\n\t\t\t<Dialog\r\n\t\t\t\tmessage={dialogState.message}\r\n\t\t\t\terror={dialogState.error}\r\n\t\t\t\tisError={dialogState.isError}\r\n\t\t\t\trequestBugReport={dialogState.requestBugReport}\r\n\t\t\t\textraButtons={dialogState.extraButtons}\r\n\t\t\t\tbuttons={dialogState.buttons}\r\n\t\t\t\tclose={this.closeDialog.bind(this)}\r\n\t\t\t/>,\r\n\t\t);\r\n\t}\r\n\r\n\tshowDialog(dialog) {\r\n\t\tthis.setState({ dialog });\r\n\t}\r\n\r\n\tcloseDialog() {\r\n\t\tthis.setState({ dialog: null });\r\n\t}\r\n\r\n\tshowSaveDialog() {\r\n\t\tconst createPNGram = this.createPNGram.bind(this);\r\n\t\tconst createRawPNG = this.createRawPNG.bind(this);\r\n\t\tconst closeDialog = this.closeDialog.bind(this);\r\n\t\tconst showError = this.showError.bind(this);\r\n\t\tconst state = this.state;\r\n\r\n\t\tconst a = document.createElement(\"a\");\r\n\t\ta.className = \"for-downloading-files\";\r\n\t\ta.tabIndex = -1;\r\n\t\tdocument.body.appendChild(a);\r\n\r\n\t\tfunction SaveDialog() {\r\n\t\t\tconst [saveType, setSaveType] = useState(\"hybrid\");\r\n\t\t\tconst [name, setName] = useState(\"Drawing\");\r\n\t\t\tconst [blobUrl, setBlobUrlWithoutRevokingOld] = useState(null);\r\n\t\t\tconst revokeOldAndSetBlobUrl = (newBlobUrl)=> {\r\n\t\t\t\tsetBlobUrlWithoutRevokingOld((oldBlobUrl)=> {\r\n\t\t\t\t\tURL.revokeObjectURL(oldBlobUrl);\r\n\t\t\t\t\treturn newBlobUrl;\r\n\t\t\t\t});\r\n\t\t\t};\r\n\t\t\tconst inputRef = useRef(null);\r\n\r\n\t\t\tconst fileExt = {\r\n\t\t\t\t\"hybrid\": \"png\",\r\n\t\t\t\t\"raw-image\": \"png\",\r\n\t\t\t\t\"program\": \"mop\",\r\n\t\t\t}[saveType];\r\n\t\t\tconst fileName = name.replace(new RegExp(\"\\\\.\" + fileExt + \"$\", \"i\"), \"\") + \".\" + fileExt;\r\n\r\n\t\t\tconst saveFileAndCloseDialog = () => {\r\n\t\t\t\ta.download = fileName;\r\n\t\t\t\ta.href = blobUrl;\r\n\t\t\t\tconsole.log(\"Download\", blobUrl);\r\n\t\t\t\ta.click();\r\n\t\t\t\tcloseDialog();\r\n\t\t\t};\r\n\r\n\t\t\tuseEffect(() => {\r\n\t\t\t\tinputRef.current.select();\r\n\t\t\t}, []);\r\n\r\n\t\t\tuseEffect(() => {\r\n\t\t\t\treturn () => {\r\n\t\t\t\t\trevokeOldAndSetBlobUrl(null);\r\n\t\t\t\t\ta.remove();\r\n\t\t\t\t};\r\n\t\t\t}, []);\r\n\r\n\t\t\tuseEffect(() => {\r\n\t\t\t\trevokeOldAndSetBlobUrl(null);\r\n\t\t\t\tif (saveType === \"hybrid\") {\r\n\t\t\t\t\tconst serializedDocument = serializeDocument(state);\r\n\t\t\t\t\tcreatePNGram(serializedDocument, (pngramBlob) => {\r\n\t\t\t\t\t\tconst pngramBlobUrl = URL.createObjectURL(pngramBlob);\r\n\t\t\t\t\t\trevokeOldAndSetBlobUrl(pngramBlobUrl);\r\n\t\t\t\t\t}, () => {\r\n\t\t\t\t\t\talert(\"Failed to save hybrid document (probably too large) - try the other save options.\");\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (saveType === \"raw-image\") {\r\n\t\t\t\t\tcreateRawPNG((rawPngBlob) => {\r\n\t\t\t\t\t\tconst rawPngBlobUrl = URL.createObjectURL(rawPngBlob);\r\n\t\t\t\t\t\trevokeOldAndSetBlobUrl(rawPngBlobUrl);\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (saveType === \"program\") {\r\n\t\t\t\t\tconst serializedDocument = serializeDocument(state);\r\n\t\t\t\t\tconst programSourceBlob = new Blob(\r\n\t\t\t\t\t\t[JSON.stringify(serializedDocument)],\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\ttype: \"application/x-mopaint+json\",\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t);\r\n\t\t\t\t\tconst programBlobUrl = URL.createObjectURL(programSourceBlob);\r\n\t\t\t\t\trevokeOldAndSetBlobUrl(programBlobUrl);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tshowError({ message: `This shouldn't happen, saveType=${saveType}`, requestBugReport: true });\r\n\t\t\t\t}\r\n\t\t\t}, [saveType]);\r\n\r\n\t\t\treturn (\r\n\t\t\t\t<Dialog\r\n\t\t\t\t\tmessage={\r\n\t\t\t\t\t\t<div className=\"save-dialog-message\">\r\n\t\t\t\t\t\t\t<form\r\n\t\t\t\t\t\t\t\tclassName=\"save-dialog-form\"\r\n\t\t\t\t\t\t\t\tonSubmit={(event) => {\r\n\t\t\t\t\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\t\t\t\t\tsaveFileAndCloseDialog();\r\n\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t<label>\r\n\t\t\t\t\t\t\t\t\tName:{\" \"}\r\n\t\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\t\t\t\t\tvalue={name}\r\n\t\t\t\t\t\t\t\t\t\tautoFocus={true}\r\n\t\t\t\t\t\t\t\t\t\tonChange={(event) => {\r\n\t\t\t\t\t\t\t\t\t\t\tsetName(event.target.value);\r\n\t\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\t\tref={inputRef}\r\n\t\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t<div style={{ marginTop: \"1em\" }}>\r\n\t\t\t\t\t\t\t\t\t<select\r\n\t\t\t\t\t\t\t\t\t\tvalue={saveType}\r\n\t\t\t\t\t\t\t\t\t\tonChange={(event) => setSaveType(event.target.value)}\r\n\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t<option value=\"hybrid\">Hybrid Mopaint Document and Image (.png)</option>\r\n\t\t\t\t\t\t\t\t\t\t<option value=\"program\">Mopaint Document (.mop)</option>\r\n\t\t\t\t\t\t\t\t\t\t<option value=\"raw-image\">Raw Image (.png)</option>\r\n\t\t\t\t\t\t\t\t\t\t{/*<option value=\"hybrid\">Hybrid Mopaint Program and Image (.png)</option>*/}\r\n\t\t\t\t\t\t\t\t\t\t{/*<option value=\"program\">Mopaint Program (.mop)</option>*/}\r\n\t\t\t\t\t\t\t\t\t\t{/*<option value=\"raw-image\">Raw/Plain Dead Fish Image (.png)</option>*/}\r\n\t\t\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</form>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t}\r\n\t\t\t\t\tclose={closeDialog}\r\n\t\t\t\t\textraButtons={\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tonClick={saveFileAndCloseDialog}\r\n\t\t\t\t\t\t\tdisabled={!blobUrl}\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t{/* TODO: loading spinner instead */}\r\n\t\t\t\t\t\t\tSave {!blobUrl ? \"(please wait...)\" : \"\"}\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t}\r\n\t\t\t\t/>\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tthis.showDialog(<SaveDialog/>);\r\n\t}\r\n}\r\n\r\nApp.propTypes = {\r\n\tdocumentID: PropTypes.string.isRequired,\r\n\tdocumentIDs: PropTypes.arrayOf(PropTypes.string.isRequired).isRequired,\r\n\tgoToDocument: PropTypes.func.isRequired,\r\n\tcreateNewDocument: PropTypes.func.isRequired,\r\n\tloadNewDocument: PropTypes.func.isRequired,\r\n\tserializedDocumentToLoad: PropTypes.object,\r\n};\r\n\r\nexport default App;\r\n","// In production, we register a service worker to serve assets from local cache.\r\n\r\n// This lets the app load faster on subsequent visits in production, and gives\r\n// it offline capabilities. However, it also means that developers (and users)\r\n// will only see deployed updates on the \"N+1\" visit to a page, since previously\r\n// cached resources are updated in the background.\r\n\r\n// To learn more about the benefits of this model, read https://goo.gl/KwvDNy.\r\n// This link also includes instructions on opting out of this behavior.\r\n\r\nconst isLocalhost = Boolean(\r\n\twindow.location.hostname === \"localhost\" ||\r\n\t\t// [::1] is the IPv6 localhost address.\r\n\t\twindow.location.hostname === \"[::1]\" ||\r\n\t\t// 127.0.0.1/8 is considered localhost for IPv4.\r\n\t\twindow.location.hostname.match(\r\n\t\t\t/^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\r\n\t\t)\r\n);\r\n\r\nexport default function register() {\r\n\tif (process.env.NODE_ENV === \"production\" && \"serviceWorker\" in navigator) {\r\n\t\t// The URL constructor is available in all browsers that support SW.\r\n\t\tconst publicUrl = new URL(process.env.PUBLIC_URL, window.location);\r\n\t\tif (publicUrl.origin !== window.location.origin) {\r\n\t\t\t// Our service worker won't work if PUBLIC_URL is on a different origin\r\n\t\t\t// from what our page is served on. This might happen if a CDN is used to\r\n\t\t\t// serve assets; see https://github.com/facebookincubator/create-react-app/issues/2374\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\twindow.addEventListener(\"load\", () => {\r\n\t\t\tconst swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\r\n\r\n\t\t\tif (!isLocalhost) {\r\n\t\t\t\t// Is not local host. Just register service worker\r\n\t\t\t\tregisterValidSW(swUrl);\r\n\t\t\t} else {\r\n\t\t\t\t// This is running on localhost. Lets check if a service worker still exists or not.\r\n\t\t\t\tcheckValidServiceWorker(swUrl);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction registerValidSW(swUrl) {\r\n\tnavigator.serviceWorker\r\n\t\t.register(swUrl)\r\n\t\t.then((registration) => {\r\n\t\t\tregistration.onupdatefound = () => {\r\n\t\t\t\tconst installingWorker = registration.installing;\r\n\t\t\t\tinstallingWorker.onstatechange = () => {\r\n\t\t\t\t\tif (installingWorker.state === \"installed\") {\r\n\t\t\t\t\t\tif (navigator.serviceWorker.controller) {\r\n\t\t\t\t\t\t\t// At this point, the old content will have been purged and\r\n\t\t\t\t\t\t\t// the fresh content will have been added to the cache.\r\n\t\t\t\t\t\t\t// It's the perfect time to display a \"New content is\r\n\t\t\t\t\t\t\t// available; please refresh.\" message in your web app.\r\n\t\t\t\t\t\t\tconsole.log(\"New content is available; please refresh.\");\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// At this point, everything has been precached.\r\n\t\t\t\t\t\t\t// It's the perfect time to display a\r\n\t\t\t\t\t\t\t// \"Content is cached for offline use.\" message.\r\n\t\t\t\t\t\t\tconsole.log(\"Content is cached for offline use.\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t};\r\n\t\t})\r\n\t\t.catch((error) => {\r\n\t\t\tconsole.error(\"Error during service worker registration:\", error);\r\n\t\t});\r\n}\r\n\r\nfunction checkValidServiceWorker(swUrl) {\r\n\t// Check if the service worker can be found. If it can't reload the page.\r\n\tfetch(swUrl)\r\n\t\t.then((response) => {\r\n\t\t\t// Ensure service worker exists, and that we really are getting a JS file.\r\n\t\t\tif (\r\n\t\t\t\tresponse.status === 404 ||\r\n\t\t\t\tresponse.headers.get(\"content-type\").indexOf(\"javascript\") === -1\r\n\t\t\t) {\r\n\t\t\t\t// No service worker found. Probably a different app. Reload the page.\r\n\t\t\t\tnavigator.serviceWorker.ready.then((registration) => {\r\n\t\t\t\t\tregistration.unregister().then(() => {\r\n\t\t\t\t\t\twindow.location.reload();\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\t// Service worker found. Proceed as normal.\r\n\t\t\t\tregisterValidSW(swUrl);\r\n\t\t\t}\r\n\t\t})\r\n\t\t.catch(() => {\r\n\t\t\tconsole.log(\r\n\t\t\t\t\"No internet connection found. App is running in offline mode.\"\r\n\t\t\t);\r\n\t\t});\r\n}\r\n\r\nexport function unregister() {\r\n\tif (\"serviceWorker\" in navigator) {\r\n\t\tnavigator.serviceWorker.ready.then((registration) => {\r\n\t\t\tregistration.unregister();\r\n\t\t});\r\n\t}\r\n}\r\n","import localforage from \"localforage\";\r\nimport shortid from \"shortid\";\r\nimport React from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport \"./index.css\";\r\nimport App from \"./components/App\";\r\nimport registerServiceWorker from \"./registerServiceWorker\";\r\nimport \"./simulate-gestures.js\";\r\n\r\nif (\r\n\twindow.location.protocol === \"http:\" &&\r\n\twindow.location.host.match(/editor|app|mopaint/)\r\n) {\r\n\twindow.location.protocol = \"https:\";\r\n}\r\n\r\nconst urlForID = (documentID) =>\r\n\t`${window.location.origin}${window.location.pathname}?document=${documentID}`;\r\nconst getIDFromCurrentURL = () =>\r\n\t(window.location.search.match(/document=([\\w\\-./]*)/) || [])[1];\r\n\r\nconst goToDocument = (documentID) => {\r\n\tif (window.location.search.match(/^\\?./)) {\r\n\t\twindow.history.pushState({}, null, urlForID(documentID));\r\n\t} else {\r\n\t\t// avoid trapping/breaking the back button, when the app is navigated to from another page\r\n\t\twindow.history.replaceState({}, null, urlForID(documentID));\r\n\t}\r\n\trender();\r\n};\r\n\r\nconst createNewDocument = () => {\r\n\tconst newDocumentID = shortid.generate();\r\n\tgoToDocument(newDocumentID);\r\n};\r\n\r\nlet toLoad = {\r\n\tserializedDocument: null,\r\n\tdocumentID: null,\r\n};\r\nconst loadNewDocument = (serializedDocument) => {\r\n\tconst documentID = shortid.generate();\r\n\ttoLoad = {serializedDocument, documentID};\r\n\tconsole.log(`Start new document (${documentID}) from`, serializedDocument);\r\n\tgoToDocument(documentID);\r\n};\r\n\r\nlet documentIDs = []; // TODO: null, and loading indicators anywhere this state is used\r\nconst updateDocumentsList = () =>\r\n\tlocalforage.keys().then((keys) => {\r\n\t\tdocumentIDs = keys\r\n\t\t\t.map((key) => key.match(/document:([a-zA-Z0-9\\-_]+):state/))\r\n\t\t\t.filter((key) => key)\r\n\t\t\t.map((key) => key[1]);\r\n\t\trender();\r\n\t});\r\n\r\nconst render = () => {\r\n\tconst container = document.getElementById(\"root\");\r\n\tconst documentID = getIDFromCurrentURL();\r\n\tif (!documentID) {\r\n\t\tcreateNewDocument();\r\n\t\treturn;\r\n\t}\r\n\tlet serializedDocumentToLoad;\r\n\tif (documentID === toLoad.documentID) {\r\n\t\tserializedDocumentToLoad = toLoad.serializedDocument;\r\n\t\ttoLoad = {\r\n\t\t\tserializedDocument: null,\r\n\t\t\tdocumentID: null,\r\n\t\t};\r\n\t}\r\n\tReactDOM.render(\r\n\t\t<App\r\n\t\t\tkey={documentID}\r\n\t\t\tdocumentID={documentID}\r\n\t\t\tdocumentIDs={documentIDs}\r\n\t\t\tgoToDocument={goToDocument}\r\n\t\t\tcreateNewDocument={createNewDocument}\r\n\t\t\tloadNewDocument={loadNewDocument}\r\n\t\t\tserializedDocumentToLoad={serializedDocumentToLoad}\r\n\t\t/>,\r\n\t\tcontainer\r\n\t);\r\n};\r\n\r\nwindow.addEventListener(\"popstate\", render);\r\nrender();\r\nupdateDocumentsList();\r\nsetInterval(updateDocumentsList, 600);\r\n\r\nregisterServiceWorker();\r\n"],"sourceRoot":""}